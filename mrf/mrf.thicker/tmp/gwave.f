      SUBROUTINE GWAVE(RHOUR)
C$$$  SUBPROGRAM DOCUMENTATION BLOCK
C                .      .    .                                       .
C SUBPROGRAM:    GWAVE       INTERFACE TO WAVE MODEL.
C   PRGMMR: MARK IREDELL     ORG: W/NMC23    DATE: 91-12-18
C
C ABSTRACT: THE WAVE MODEL IS INVOKED IF THE PARAMETER DTWAVE > 0 AND
C           THE STRESSES HAVE BEEN ACCUMULATING FOR DTWAVE HOURS.
C           THEN THE LAND-SEA MASK AND STRESSES ARE INTERPOLATED
C           TO THE WAVE GRID AND THE WAVE MODEL IS CALLED.
C           THE STRESSES ARE RESET FOR ACCUMULATING AGAIN.
C           THE WAVE MODEL IS COUPLED IF THE PARAMETER COWAVE > 0.
C           THEN THE ROUGHNESS GENERATED BY THE WAVE MODEL IS
C           INTERPOLATED BACK TO THE MODEL PHYSICS GRID.
C
C PROGRAM HISTORY LOG:
C   91-12-18  MARK IREDELL
C
C USAGE:    CALL GWAVE (RHOUR)
C   INPUT ARGUMENT LIST:
C     RHOUR    - CURRENT FORECAST HOUR
C
C   SUBPROGRAMS CALLED:
C     FLIP1    - TRANSFORM FIELD TO NEW STARTING LONGITUDE
C     FLIP2    - TRANSFORM FIELD TO REVERSE LATITUDE ORDER
C     GG2LL    - INTERPOLATE GAUSSIAN GRID TO LAT-LON GRID
C     LL2GG    - INTERPOLATE LAT-LON GRID TO GAUSSIAN GRID
C     ROWSEP   - SEPARATE LONGITUDES IN GAUSSIAN GRID
C     ROW1NS   - CONCATENATE LONGITUDES IN GAUSSIAN GRID
C
C ATTRIBUTES:
C   LANGUAGE: FORTRAN 77.
C   MACHINE:  CRAY YMP.
C
C$$$
C.................................................................
C................BEGIN TWOLOOP(COMFIBM)........................
C....
C    VERSION WITH STACKED TRANSFORMS
C....
C.................................................................
C................BEGIN comfspec...................................
C....
       COMMON /comfspec/ IDATE(4),RELVOR( 28 ),ABSVOR( 28 ),
     1 EPS( 4032 ),EPSI( 4032 ),GZ( 4033 )
       COMMON /comfspec/
     *    ZEM    ( 4033 , 28 ),
     *    DIM    ( 4033 , 28 ),
     *    TEM    ( 4033 , 28 ),
     *    RM     ( 4033 , 28 ),
     *    QM     ( 4033 )
       COMMON /comfspec/
     *    ZE     ( 4033 , 28 ),
     *    DI     ( 4033 , 28 ),
     *    TE     ( 4033 , 28 ),
     *    RQ     ( 4033 , 28 ),
     *    DPDLAM ( 4033 ),
     *    DPDPHI ( 4033 ),
     *    ULN    ( 4033 , 28 ),
     *    VLN    ( 4033 , 28 ),
     *    Q      ( 4033 )
       COMMON /comfspec/
     *    X      ( 4033 , 28 ),
     *    Y      ( 4033 , 28 ),
     *    RT     ( 4033 , 28 ),
     *    Z      ( 4033 ),
     *    W      ( 4033 , 28 )
C.................................................................
C................sof   comfspec...................................
C....
C.................................................................
C................BEGIN comfgrid...................................
C....
       COMMON /comfgrid/
     * COLRAD( 47 ),WGT( 47 ),WGTCS( 47 ),RCS2( 47 ),
     * COLRAB( 47 ),WGB( 47 ),WGBCS( 47 ),RBS2( 47 ),
     * SINLAT( 47 ),
     * SINLAB( 384 , 47 ),COSLAB( 384 , 47 )
C.................................................................
C................sof   comfgrid...................................
C....
C.................................................................
C................BEGIN comfphys ..................................
C....
      COMMON /comfphys/SLMSK( 384 , 47 ),HPRIME( 384 , 47 ),
     * SWH( 384 , 28 , 47 ),HLW( 384 , 28 , 47 ),
     * SFCNSW( 384 , 47 ),SFCDLW( 384 , 47 ),
     * COSZEN( 384 , 47 ),XLON( 384 , 47 ),
     * SDEC,CDEC,SLAG,SOLHR,CLSTP,LASTEP,
     * CV( 384 , 47 ),CVT( 384 , 47 ),CVB( 384 , 47 ),
     * ALBEDO( 384 , 47 ),TSFLW( 384 , 47 ),
     *       DUSFC( 384 , 47 ), DVSFC( 384 , 47 ),
     *       DTSFC( 384 , 47 ), DQSFC( 384 , 47 ),
     *      DLWSFC( 384 , 47 ),ULWSFC( 384 , 47 ),
     *GESHEM( 384 , 47 ),TSEA( 384 , 47 ),F10M( 384 , 47 ),
     *       DUGWD( 384 , 47 ),DVGWD( 384 , 47 ),
     *       U10M( 384 , 47 ),V10M( 384 , 47 ),
     *       T2M( 384 , 47 ),Q2M( 384 , 47 ),
     *       PSURF( 384 , 47 ),PSMEAN( 384 , 47 ),
     *TG3( 384 , 47 ),ZORL( 384 , 47 ),PLANTR( 384 , 47 ),
     *        SHELEG( 384 , 47 ),BENGSH( 384 , 47 ),
     *        GFLUX( 384 , 47 ),SLRAD( 384 ),
     *        SMC( 384 , 47 , 2 ),STC( 384 , 47 , 2 ),
     *        CANOPY( 384 , 47 ),RUNOFF( 384 , 47 ),
     *        TMPMAX( 384 , 47 ),TMPMIN( 384 , 47 ),
     *        EP( 384 , 47 ),CLDWRK( 384 , 47 ),
     *        HPBL( 384 , 47 ),PWAT( 384 , 47 )
      LOGICAL LASTEP
C.................................................................
C................sof   comfphys ..................................
C....
C....
C....
C.....BEGIN comfver...............................................
      COMMON/comfver/AM( 28 , 28 ),HM( 28 , 28 ),TM( 28 , 28 ),
     O               BM( 28 , 28 ),CM( 28 , 28 ),SPDMAX( 28 ),
     1 SI( 29 ),SL( 28 ),DEL( 28 ),RDEL2( 28 ),RMSDOT( 27 ),
     2 CI( 29 ),CL( 28 ),TOV( 28 ),GV( 28 ),SV( 28 ),RPI( 27 ),
     3 P1( 28 ),P2( 28 ), H1( 28 ),   H2( 28 ),RPIREC( 27 ),
     8   THOUR,DELTIM,KDT,INISTP,SL1,Z00,FHOUR,SHOUR,LIMLOW,DTCVAV,
     9   NFLIP,NFLOP,NR2DDA,FILTA,FILTB,DK,TK,PERCUT,DTSWAV,DTLWAV,
     X   COWAVE,DTWAVE,N50UFL,NUMSUM,NUMMAX,NCPUS,NCPUS1,NCLDB1
C.....sof   comfver...............................................
C....
C....
      COMMON/COMBIT/NDEX( 4032 ),SNNP1( 4032 )
      COMMON/COMBIT/LAB(4),IFIN,ICEN,IGEN,ICEN2,IENST,IENSI,RUNID,USRID
      CHARACTER*8 LAB
C....
C....
      COMMON /RADIAG/ FLUXR( 256 , 31 ,26)
C     EQUIVALENCE (FFLWUP(1,1),FLUXR(1,1,1)),(FFSWUP(1,1),FLUXR(1,1,2)),
C    1            (FSSWUP(1,1),FLUXR(1,1,3)),(FSSWDN(1,1),FLUXR(1,1,4)),
C    2            (CCHI  (1,1),FLUXR(1,1,5)),(CCMID (1,1),FLUXR(1,1,6)),
C    3            (CCLO  (1,1),FLUXR(1,1,7)),(CTPH  (1,1),FLUXR(1,1,8)),
C    4         (CTPM  (1,1),FLUXR(1,1,9)), (CTPL  (1,1),FLUXR(1,1,10)),
C    5         (CBTH  (1,1),FLUXR(1,1,11)),(CBTM  (1,1),FLUXR(1,1,12)),
C    6         (CBTL  (1,1),FLUXR(1,1,13)),(CTHTMP(1,1),FLUXR(1,1,14)),
C    7         (CTMTMP(1,1),FLUXR(1,1,15)),(CTLTMP(1,1),FLUXR(1,1,16)),
C    8         (ALBDO (1,1),FLUXR(1,1,17)),(FFSWDN(1,1),FLUXR(1,1,18)),
C    9         (SLWDN (1,1),FLUXR(1,1,19)),(SLWUP (1,1),FLUXR(1,1,20)),
C    1         (FLWUPC(1,1),FLUXR(1,1,21)),(FSWUPC(1,1),FLUXR(1,1,22)),
C    2         (SSWDNC(1,1),FLUXR(1,1,23)),(SSWUPC(1,1),FLUXR(1,1,24)),
C    3         (SLWDNC(1,1),FLUXR(1,1,25)),(TOTALC(1,1),FLUXR(1,1,26))
      COMMON /RADIAG/ CVAVG( 384 , 47 )
      COMMON /RADIAG/ ILEFT( 384 ),IRGHT( 384 ),WGTLON( 384 )
      COMMON /RADIAG/ INSLAT( 47 ),WGTLAT( 47 )
C.............................................................
C.................SOF  TWOLOOP(COMFIBM)........................
C................................................................
C-WAV COMMON/COMWAV/ HSTR,USTRGG( 384 , 47 ),VSTRGG( 384 , 47 )
C-WAV COMMON /BLOCK2/ ISTEP,KPOINT,KSTEP1,KSTEP2,KWAX,LAT,LLAT,LONG,LNP
C-WAV$  ,MLAT,ZM,DH,QSTART,QSTEP1,Q11OUT,Q12OUT, MARCH,QINIT
C-WAV EXTERNAL FFAC
C-WAV INTEGER ZM,DH
C-WAV LOGICAL QINIT
C-WAV PARAMETER(LONB2= 384 ,LATB2= 47 ,LONB=LONB2/2,LATB=LATB2*2)
C-WAV PARAMETER(IWAVE=144,JWAVE=73,I1=11,I2=IWAVE+2-I1,J1=9,J2=67)
C-WAV DIMENSION SMSKGG(LONB2,LATB2),ZORLGG(LONB2,LATB2)
C-WAV DIMENSION SMSKLL(IWAVE,JWAVE),ZORLLL(IWAVE,JWAVE)
C-WAV DIMENSION USTRLL(IWAVE,JWAVE),VSTRLL(IWAVE,JWAVE)
C-WAV LOGICAL LMSKLL(IWAVE,JWAVE)
C-WAV SAVE LMSKLL,ZORLLL
C-WAV DATA IONCE/0/
C-WAV DATA SLCUT/0.75/,ZORLFL/0.01/,ZORLMX/0.2/
C-----------------------------------------------------------------------
C-WAV DTW=RHOUR-HSTR
C-WAV IF(LASTEP.OR.DTW.GT.DTWAVE-0.5*DELTIM/3600.) THEN
C  INTERPOLATE SEA-LAND MASK AND ROUGHNESS
C-WAV   IF(IONCE.EQ.0) THEN
C-WAV     IONCE=1
C-WAV     DO 10 J=1,LATB2
C-WAV     DO 10 I=1,LONB2
C-WAV       SMSKGG(I,J)=MIN(SLMSK(I,J),1.)
C-WAV       IF(SLMSK(I,J).EQ.0.) THEN
C-WAV         ZORLGG(I,J)=ZORL(I,J)
C-WAV       ELSE
C-WAV         ZORLGG(I,J)=ZORLFL
C-WAV       ENDIF
10        CONTINUE
C-WAV     CALL ROWSEP(SMSKGG)
C-WAV     CALL GG2LL(COLRAB,LONB,LATB,SMSKGG,IWAVE,JWAVE,SMSKLL)
C-WAV     CALL FLIP1(I1,IWAVE,JWAVE,SMSKLL)
C-WAV     CALL FLIP2(IWAVE,JWAVE,SMSKLL)
C-WAV     DO 20 J=1,JWAVE
C-WAV     DO 20 I=1,IWAVE
C-WAV       LMSKLL(I,J)=J.GE.J1.AND.J.LE.J2.AND.SMSKLL(I,J).LT.SLCUT
20        CONTINUE
C-WAV     CALL ROWSEP(ZORLGG)
C-WAV     CALL GG2LL(COLRAB,LONB,LATB,ZORLGG,IWAVE,JWAVE,ZORLLL)
C-WAV     CALL FLIP1(I1,IWAVE,JWAVE,ZORLLL)
C-WAV     CALL FLIP2(IWAVE,JWAVE,ZORLLL)
C-WAV   ENDIF
C  INTERPOLATE STRESSES
C-WAV   CALL ROWSEP(USTRGG)
C-WAV   CALL GG2LL(COLRAB,LONB,LATB,USTRGG,IWAVE,JWAVE,USTRLL)
C-WAV   CALL FLIP1(I1,IWAVE,JWAVE,USTRLL)
C-WAV   CALL FLIP2(IWAVE,JWAVE,USTRLL)
C-WAV   CALL ROWSEP(VSTRGG)
C-WAV   CALL GG2LL(COLRAB,LONB,LATB,VSTRGG,IWAVE,JWAVE,VSTRLL)
C-WAV   CALL FLIP1(I1,IWAVE,JWAVE,VSTRLL)
C-WAV   CALL FLIP2(IWAVE,JWAVE,VSTRLL)
C  NORMALIZE STRESSES
C-WAV   RTIME=1./(3600.*DTW)
C-WAV   DO 30 J=1,JWAVE
C-WAV   DO 30 I=1,IWAVE
C-WAV     USTRLL(I,J)=USTRLL(I,J)*RTIME
C-WAV     VSTRLL(I,J)=VSTRLL(I,J)*RTIME
30      CONTINUE
C  INVOKE WAVE MODEL
C-WAV   QINIT=LASTEP
C-WAV   IYMDH=1000000*IDATE(4)+10000*IDATE(2)+100*IDATE(3)+IDATE(1)
C-WAV   PRINT 930,IYMDH,RHOUR,HSTR
C-WAV   CALL WAVE(IYMDH,HSTR,DTW,USTRLL(1,J1),VSTRLL(1,J1),LMSKLL(1,J1),
C-WAV&            ZORLLL(1,J1))
C  INTERPOLATE ROUGHNESS
C-WAV   IF(COWAVE.GT.0.) THEN
C-WAV     DO 40 J=1,JWAVE
C-WAV     DO 40 I=1,IWAVE
C-WAV       IF(.NOT.LMSKLL(I,J).OR.ZORLLL(I,J).GT.ZORLMX)
C-WAV&        ZORLLL(I,J)=ZORLFL
40        CONTINUE
C-WAV     CALL FLIP1(I2,IWAVE,JWAVE,ZORLLL)
C-WAV     CALL FLIP2(IWAVE,JWAVE,ZORLLL)
C-WAV     CALL LL2GG(COLRAB,IWAVE,JWAVE,ZORLLL,LONB,LATB,ZORLGG)
C-WAV     CALL ROW1NS(ZORLGG)
C-WAV     DO 50 J=1,LATB2
C-WAV     DO 50 I=1,LONB2
C-WAV       IF(SLMSK(I,J).EQ.0.) ZORL(I,J)=ZORLGG(I,J)
50        CONTINUE
C-WAV     CALL FLIP1(I1,IWAVE,JWAVE,ZORLLL)
C-WAV     CALL FLIP2(IWAVE,JWAVE,ZORLLL)
C-WAV     PRINT 950
C-WAV   ENDIF
C  INITIALIZE STRESSES
C-WAV   HSTR=RHOUR
C-WAV   DO 60 J=1,LATB2
C-WAV   DO 60 I=1,LONB2
C-WAV     USTRGG(I,J)=0.
C-WAV     VSTRGG(I,J)=0.
60      CONTINUE
C-WAV ENDIF
C-----------------------------------------------------------------------
      RETURN
930   FORMAT(' WAVE MODEL CALLED FOR DATE ',I8,F8.1,'   FROM',F8.1)
950   FORMAT(' WAVE MODEL ROUGHNESS USED  ',I8,F8.1)
      END
