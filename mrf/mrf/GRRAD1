      SUBROUTINE GRRAD1(DGRS,PLAMGR,PPHIGR,UGRS,VGRS,TGRS,QGRS,PGR,
     1                  ALBEDR,SLMSKR,COSZER,RLON,RLAT,
     2                  TSEAR,SHELGR,TGR,CVR,CVTR,CVBR,RHCL,
     3                  PPPRSA,OZONEA,ALBDOA,COSZRO,TAUDAR,
     4                  CLDARY,CLDSA,MTOPA,MBOTA,
     5                  RRS2,LAT,LATCO,IDTLN,IDTLS,DLON,ISTRAT,
     6                  KDAPRX,SLAG,RSIN1,RCOS1,RCOS2,
     7                  FJD,DLT,JSNO,WORKR,LWORKR,
##DG 8                  CLDTOT,CLDCNV,
##DGZ9                  SFCP,
     A                  AVECV,AVECLD,CLDL)
CFPP$ NOCONCUR R
C..     ************************************************************
C..     *  ADDED ACCUMULATION OF CLDS AND CONVECTIVE CLOUD IN DG3  *
C..     *                                        K.A.C SEPT 1994   *
C..     *  CHANGED  H,M,L CALCULATION IN CLDJMS (REMOVED FACV)     *
C..     *     AND ADDED PROPER TOTAL CLOUD CALCULATION             *
C..     *  CHANGED AVECLD CALC IN CLDIAG (USED CLDARY) AND         *
C..     *     USED TOTAL CLOUD CALCULATED IN CLDJMS                *
C..     *                                         K.A.C. NOV94     *
C..     *  INTERPOLATE O3 PROFILE TO EACH GRIDPOINT, IE USE        *
C..     *     PROPER SURFACE PRESSURE                              *
C..     *                                         K.A.C. DEC94     *
C..     *  FIX PL1 FOR OPERATIONS, WHERE DGZ IS ON AND DG3 IS OFF, *
C..     *     ....NOTE DG IS ON IF EITHER DGZ OR DG3 IS ON         *
C..     *                                         K.A.C. JAN94     *
C..     ************************************************************
C
C        UPDATES MADE TO ADD OCEANIC STRATUS AND TO FIX CONV CLOUD..
C                     TO GLOOPR - IVV(2),IBL ARE SET=1....
C                     TO GLOOPR - SET MIN Q TO 1.E-10,RATHER THAN 1.E-6
C                                 TO ANTICIPATE AVOIDING CLD CREATION
C                                 IN EXTREMELY DRY,COLD (WINTER) REGIONS
C                                 WHERE 1.E-6 COULD IMPLY HI VALU OF RH
C                     TO CLDJMS - MULTITUDE OF CHANGES
C        UPDATES MADE TO ADD GRID POINT DIAGNOSTICS ..K.A.C...SEP 91
C                     TO GLOOPR -
C        UPDATES MADE TO FIX SW APPROX              ..K.A.C...NOV 91
C                     TO COSZMN
C        UPDATES MADE TO PASS AND RECEIVE SIB DATA  ..K.A.C...MAR 92
C                     TO GLOOPR -
C        UPDATES MADE TO FIX SW RAD DIAGNOSTICS     ..K.A.C...JUN 92
C                     PROPER DIURNAL WEIGHTING
C                     TO GLOOPR AND COSZMN
C        UPDATES MADE TO CALCULATE CLEAR-SKY "ON-THE-FLY" KAC AUG 92
C                     TO GLOOPR,RADFS,FST,SPA,LWR,SWR
C                     ...FOR CLOUD FORCING....
CYH93...
C        UPDATES MADE FOR THE COMPLETELY NEW CLOUD ROUTINE (CLDJMS),USE
C                     FLAG IVVA TO CONTROL VERTICAL VELOCITY ADJ.
C                     FOR LOW CLD (=0: WITHOUT,  =1: WITH)
CYH94  NOT            USE FLAG IEMIS TO CONTROL CLD EMISS. SCHEME
CYH94  NOT            (=0: ORIG. SCHEME, =1: TEMP. DEP. SCHEME.)
C                     USE FLAG INVR TO CONTROL LAPSE RATE INVERSION
C                     TYPE OF CLD (=0: WITHOUT,  =1: WITH)
C                     TO GLOOPR AND RADFS ...Y.H.           ...DEC92
C        UPDATES MADE TO CALL CLD OPTICAL PROPERTY ROUTINE (CLDPRP),
C                     TO GIVE CLD EMISSIVITY, OPTICAL DEPTH, LAYER
C                     REFLECTANCE AND TRANSMITANCE
C                     TO GLOOPR AND RADFS ...Y.H.           ...FEB93
CYH94                 CLDPRP CALLED FROM RADFS...   Y.H.    ...FEB94
CTUNE
C       UPDATES MADE TO ALLOW TUNED CLD-RH DATA TO BE USED..CTUNE
C                   TO GLOOPR AND CLDJMS          ..K.A.C...DEC 92
C                   SPATIAL INTERPOLATION OF TABLES ........MAY93
C                   USE ONLY 1 SET OF TUNING TABLES FOR ALL FCST HRS,
C                    THE TUNING OF THE 24HR FCST       .....JAN94
C                    OLD CODE USED 6 TABLES..SEE CKC94 .....FEB94
C                   SINCE TUNING DONE FOR H,M,L CLD, VERTICALLY
C                    BLEND THE RELATIONS AT OLD HML BDRIES..JAN94
C        UPDATES MADE TO CHANGE DEFINITION OF H,M,L DOMAINS..
C          TO GLOOPR,GCLJMS,CLDJMS, CLDPRP   K.A.C...DEC92 + AUG93
CYH94         TO GLOOPR, CLDJMS, CLDPRP      K.A.C...JAN94
CYH94         TO CLDJMS..  CVTOP = KCVT (NOT KCVT+1)
CYH94                    AND TO ISTRAT=1 PART...NEW STRATUS +
CYH94                  ..NO CLOUD BELOW LLYRL..  K.A.C...MAR94
CYH94                  ..CHANGES TO CLDPRP.........Y.H...MAR94
CTUNE
CYH93...
CHL95      MODIFIED TO ALLOW MORE FREQUENT COMPUTATION OF SHORTWAVE FLUX
CHL95      ASSUME THAT DTSWAV <= DTLWAV!!!!!.....H.-L. PAN JUL95
C---
 %INCLUDE RDPARM;
CTUNE
CKC94 PARAMETER (MCLD=3,NSEAL=2,NBIN=100,NLON=2,NLAT=4,IDA=6)
      PARAMETER (MCLD=3,NSEAL=2,NBIN=100,NLON=2,NLAT=4)
CTUNE
C...
 %INCLUDE COMFVER;
C....
      DIMENSION DGRS(#LONR22,#LEVS)
      DIMENSION PLAMGR(#LONR22),PPHIGR(#LONR22)
      DIMENSION UGRS(#LONR22,#LEVS),VGRS(#LONR22,#LEVS)
      DIMENSION TGRS(#LONR22,#LEVS),QGRS(#LONR22,#LEVS)
      DIMENSION PGR(#LONR22)
C....
      DIMENSION WORKR(#LONR2,LWORKR)
C....
      DIMENSION COSZER(#LONR2)
C....
      DIMENSION RRS2(#LATR2)
      DIMENSION RLON(#LONR2),RLAT(#LONR2)
      DIMENSION ALBEDR(#LONR2),SLMSKR(#LONR2)
CYH93 DIMENSION VVEL(#LONR2,#LEVS),SSNOW(#LONR2),EMIS(#LONR2)
      DIMENSION VVEL(#LONR2,#LEVS),SSNOW(#LONR2)
C....   CLDARY CONTAINS MULTI LAYERS OF CLOUD
CYH94 DIMENSION CLDARY(#LONR2,#LEVS),CLSTR(#LONR2)
      DIMENSION CLDARY(#LONR2,#LEVS)
##DG  DIMENSION CLDTOT(#LONR2,#LEVS),CLDCNV(#LONR2,#LEVS)
##DGZ DIMENSION SFCP(#LONR2)
##DG  DIMENSION ICNV(#LONR2)
CYH94 DIMENSION EMIS0(#LONR2,3),TAUC0(#LONR2,3)
CYH93...
C....
      DIMENSION    PPPRSA(#LONR2,#LEVS),
     1             OZONEA(#LONR2,#LEVS),ALBDOA(#LONR2),
CTOT 2             CLDSA(#LONR2,3),MTOPA(#LONR2,3),MBOTA(#LONR2,3),
     2             CLDSA(#LONR2,4),MTOPA(#LONR2,3),MBOTA(#LONR2,3),
     3             COSZRO(#LONR2),TAUDAR(#LONR2),WRKEMA(#LONR2),
     4             TSEAR(#LONR2),SHELGR(#LONR2),
     5             CVR(#LONR2),CVTR(#LONR2),CVBR(#LONR2),
C                  ADDED BY BOB GRUMBINE FOR SEA ICE ALBEDO ALGORITHM
     6             TGR(#LONR2)
      DIMENSION    AVECV(3,#LATR),AVECLD(#LEVS,#LATR),CLDL(4,#LATR)
C....
CYH93...
C     SAVE KEMIS,IVV,IBL,ICONV,IEMIS,ITHK,
CYH94 SAVE KEMIS,KALB,IEMIS,INVR,IVVA,RHMAX,
      SAVE                  INVR,IVVA,RHMAX,
CTUNE1     CRH,
     2     XLABDY,XLOBDY,XLIM
CKC942     XLABDY,XLOBDY,XLIM,RHCLT
CTUNE
CYH   DIMENSION CRH(3),IVV(3)
CKAC  DIMENSION CRH(#LEVS,2)
CTUNE
C...  ARRAY ADDED FOR RH-CL CALCULATION
C     INDICES FOR LON,LAT,CLD TYPE(L,M,H), LAND/SEA RESPECTIVELY
C     NLON=1-2, FOR EASTERN AND WESTERN HEMISPHERES
C     NLAT=1-4, FOR 60N-30N,30N-EQU,EQU-30S,30S-60S
C     LAND/SEA=1-2 FOR LAND(AND SEAICE),SEA
      DIMENSION RHCL (NBIN,NLON,NLAT,MCLD,NSEAL)
      DIMENSION RHCLA(NBIN,NLON,     MCLD,NSEAL,2)
      DIMENSION RHCLD(#LONR2,NBIN,MCLD)
      DIMENSION XLABDY(3),XLOBDY(3)
C...   XLABDY = LAT BNDRY BETWEEN TUNING REGIONS,+/- XLIM FOR TRANSITION
C.     XLOBDY = LON BNDRY BETWEEN TUNING REGIONS
      DATA XLABDY / 30.#E0 , 0.#E0 , -30.#E0 /
      DATA XLOBDY / 0.#E0 , 180.#E0 , 360.#E0 /
      DATA XLIM / 5.#E0 /
CTUNE
C..... INITIAL RH CRIT. SET 1 FOR OCEAN, SET 2 FOR LAND.
C      INVR=0 NO LAPSE RATE INVERSION TYPE CLD, =1 WIHT IT
C      IVVA=0 NO VERTICAL VELOCITY ADJ. FOR LOW CLD, =1 WITH ADJ.
CYH93...
CYH94 DATA CRH/9*0.72,7*0.70,12*0.86, 9*0.68,7*0.66,12*0.82/
CKAC  DATA CRH/9*0.75#E0,7*0.75#E0,12*0.88#E0,
CKAC 1          9*0.70#E0,7*0.70#E0,12*0.85#E0/
CYH94 DATA RHMAX/1.00/, IEMIS/1/, INVR/1/, IVVA/1/
      DATA RHMAX/1.00#E0/, INVR/1/, IVVA/1/
C     DATA CRH/0.8,0.8,0.8/
C     DATA IVV/1,1,0/
C     DATA ISTRAT,IBL,ICONV,IEMIS,ITHK/1,1,1,0,1/
CYH93...
CYH94 DATA KEMIS/0/
C....
      DO 250 J=1,#LONR2
        PGR(J) = EXP(PGR(J))
##DGZ   SFCP(J) = PGR(J)
##DG    ICNV(J) = 0.#E0
  250 CONTINUE
C....
C    CONVERT VIRT. TEMP TO THERMODYNAMIC TEMP.
C.......................................................
      DO 270 K=1,#LEVS
       DO 270 J=1,#LONR2
        IF(QGRS(J,K).LE.0.0#E0) QGRS(J,K)=1.0#E-10
        TGRS(J,K)=TGRS(J,K)/(1.0#E0+0.6#E0*QGRS(J,K))
  270 CONTINUE
CTUNE
      XLATNH = RLAT(1) * 180.#E0 / #PI
      XLATSH = - XLATNH
C....  GET RH-CLD RELATION FOR THIS LAT
      IREGNH = 4
      DO 210 K=1,3
       IF (XLATNH.GT.XLABDY(K)) THEN
        IREGNH = K
        GO TO 215
       END IF
  210 CONTINUE
  215 IREGSH = 4
      DO 220 K=1,3
       IF (XLATSH.GT.XLABDY(K)) THEN
        IREGSH = K
        GO TO 225
       END IF
  220 CONTINUE
  225 CONTINUE
      DO 230 ISLA=1,NSEAL
       DO 230 KC=1,MCLD
        DO 230 LO=1,NLON
         DO 230 NBI=1,NBIN
          RHCLA(NBI,LO,KC,ISLA,1) = RHCL(NBI,LO,IREGNH,KC,ISLA)
          RHCLA(NBI,LO,KC,ISLA,2) = RHCL(NBI,LO,IREGSH,KC,ISLA)
  230 CONTINUE
C.....    LINEAR TRANSITION BETWEEN LATITUDINAL REGIONS...
      DO 240 KLA=1,3
       XLNN = XLABDY(KLA)+XLIM
       XLSS = XLABDY(KLA)-XLIM
       IF (XLATNH.LT.XLNN.AND.XLATNH.GT.XLSS) THEN
        DO 235 ISLA=1,NSEAL
         DO 235 KC=1,MCLD
          DO 235 LO=1,NLON
           DO 235 NBI=1,NBIN
            RHCLA (NBI,LO,KC,ISLA,1) =
     1         (RHCL(NBI,LO,KLA,KC,ISLA)-RHCL(NBI,LO,KLA+1,KC,ISLA))
     2       * (XLATNH-XLSS)/(XLNN-XLSS) + RHCL(NBI,LO,KLA+1,KC,ISLA)
  235   CONTINUE
       END IF
       IF (XLATSH.LT.XLNN.AND.XLATSH.GT.XLSS) THEN
        DO 237 ISLA=1,NSEAL
         DO 237 KC=1,MCLD
          DO 237 LO=1,NLON
           DO 237 NBI=1,NBIN
            RHCLA (NBI,LO,KC,ISLA,2) =
     1         (RHCL(NBI,LO,KLA,KC,ISLA)-RHCL(NBI,LO,KLA+1,KC,ISLA))
     2       * (XLATSH-XLSS)/(XLNN-XLSS) + RHCL(NBI,LO,KLA+1,KC,ISLA)
  237   CONTINUE
       END IF
  240 CONTINUE
C     PRINT 75,XLATNH,IREGNH,XLATSH,IREGSH
C  75 FORMAT(1H ,' NH LAT AND REGION=',F7.2,I4,
C    1           ' SH LAT AND REGION=',F7.2,I4)
C...   GET RH-CLD RELATIONSHIP FOR EACH GRID POINT, INTERPOLATING
C       LONGITUDINALLY BETWEEN REGIONS IF NECESSARY..
      DO 248 I=1,#LONR2
       ILSEA = 1
       IF (SLMSKR(I).LT.1.#E0) THEN
C...  OPEN OCEAN POINT....
        ILSEA = 2
       END IF
C...  WHICH HEMISPHERE
       IH  = 1
       XLONPT = DLON * (I-1)
       IF (I.GT.#LONR) THEN
        IH = 2
        XLONPT = DLON * (I-#LONR-1)
       END IF
       ILONGT = 1
       IF (I.GT.IDTLN.AND.I.LE.#LONR) ILONGT = 2
       IF (I.GT.IDTLS) ILONGT = 2
       DO 246 K=1,MCLD
        DO 241 NBI=1,NBIN
         RHCLD(I,NBI,K) = RHCLA(NBI,ILONGT,K,ILSEA,IH)
  241   CONTINUE
        IKN = 0
        DO 243 KLO=1,3
         DIFLO = ABS(XLONPT-XLOBDY(KLO))
         IF (DIFLO.LT.XLIM) THEN
          IKN = KLO
          GO TO 244
         END IF
  243   CONTINUE
        GO TO 246
  244   CONTINUE
        ILFT = ILONGT
        IRGT = ILFT + 1
        IF (IRGT.GT.NLON) IRGT = 1
        XLFT = XLOBDY(IKN) - XLIM
        XRGT = XLOBDY(IKN) + XLIM
        DO 245 NBI=1,NBIN
         RHCLD (I,NBI,K) =
     1     (RHCLA(NBI,ILFT,K,ILSEA,IH)-RHCLA(NBI,IRGT,K,ILSEA,IH))
     2      * (XLONPT-XRGT)/(XLFT-XRGT)+RHCLA(NBI,IRGT,K,ILSEA,IH)
  245   CONTINUE
  246  CONTINUE
  248 CONTINUE
CTUNE
C.......................................................
C....   GET MEAN ZENITH ANGLE FOR THIS DTSWAV-BOTH NH AND SH
C      START RADFS SET-UP FOR BOTH HEMISPHERES
C...      GET VERTICAL MOTION (CB/SEC) IN VVEL
C.......................................................
      CALL OMEGAS(#LONR2,#LONR22,#LEVS,
     &            PPHIGR(1),PLAMGR(1),WORKR,UGRS(1,1),VGRS(1,1),
     2            DGRS(1,1),DEL,RRS2(LAT),VVEL,PGR(1),SL)
C...      GET MODEL DIAGNOSED CLDS
      CALL CLDJMS(#LONR2,#LONR22,#LEVS,NBIN,MCLD,
     1            PGR(1),QGRS(1,1),TGRS(1,1),VVEL,
     2            CVR(1),CVTR(1),CVBR(1),
CKAC 3            SI,SL,CRH,SLMSKR(1),
     3            SI,SL,    SLMSKR(1),
     4            CLDSA(1,1),MTOPA(1,1),MBOTA(1,1),
CTUNE5            CLDARY(1,1),IVVA,INVR,RHMAX,CLSTR(1))
CYH945            CLDARY(1,1),IVVA,INVR,RHMAX,CLSTR(1),
     5            CLDARY(1,1),IVVA,INVR,RHMAX,
     6            RLAT(1),RHCLD,ISTRAT)
CDG3     UNPACK CLDAMT AND CONV CLDAMT FROM CLDARY..(STRATUS IS +2)
CDG3      RADIATION SEES STRATIFORM OR CONVECTIVE...NOT MERGED.....
CDG3      SO CLDTOT REFLECTS THIS BELOW
CDG3  NOTE:CLDARY 2-4 DIGITS TO LEFT OF DECIMAL=CV CLOUD
CDG3       CLDARY 1 DIGIT TO LEFT OF DECIMAL+FRACTIONAL PART=STRAT CLD
CDG3        GET STRATIFORM CLD INTO CLDTOT, CONV CLD IN CLDCNV
CDG3        ..ANVIL CI IS STRATIFORM, SO PLACE THE 1 LYR IN CNV ALSO
CDG3        ..ICNV = CV CLOUD TOP LAYER
##DG   DO 251 K=1,#LEVS
##DG    DO 251 I=1,#LONR2
##DG     CLDTOT(I,K) = AMOD (CLDARY(I,K),2.#E0)
##DG     CLDCNV(I,K) = FLOAT(INT(CLDARY(I,K))/10)*1.#E-3
##DG     IF(CLDCNV(I,K).GT.0.#E0) THEN
##DG      CLDTOT(I,K) = CLDCNV(I,K)
##DG      ICNV(I) = K
##DG     END IF
  251  CONTINUE
CDG3      ..ANVIL CI PLACED INTO LAYER ABOVE CONV CLD TOP
##DG   DO 252 I=1,#LONR2
##DG    K = ICNV(I)
##DG    IF (K.GT.1.AND.K.LT.#LEVS) THEN
##DG     CLDCNV(I,K+1) = CLDTOT(I,K+1)
##DG    END IF
  252  CONTINUE
CTUNE
CYH94...   CLDPRP NOW CALLED FROM WITHIN RADFS.....
CYH93...
C...      COMPUTE MEAN CLOUD DIAGNOSTICS + H,M,L,TOTAL CLOUD
      CALL CVDIAG(AVECV(1,LAT  ),AVECV(1,LATCO),
     1            CVR(1),CVTR(1),CVBR(1))
      CALL CLDIAG(AVECLD(1,LAT  ),CLDL(1,LAT  ),
     1            AVECLD(1,LATCO),CLDL(1,LATCO),
     2            CLDSA(1,1),CLDARY(1,1))
CTOT 2            CLDSA(1,1),MTOPA(1,1),MBOTA(1,1),
CTOT 3            CLDSA(1,2),MTOPA(1,2),MBOTA(1,2),
CTOT 4            CLDSA(1,3),MTOPA(1,3),MBOTA(1,3))
C...
CO3 ....
      CALL OZON2D(SL,OZONEA(1,1),PGR(1),RLAT(1),RSIN1,RCOS1,RCOS2)
CO3 ....
      DO 300 K=1,#LEVS
       DO 300 I=1,#LONR2
CO3     OZONEA(I,K) = 0.#E0
        PPPRSA(I,K) = SL(K) * PGR(I)
  300 CONTINUE
      DO 340 I=1,#LONR2
        IF(SLMSKR(I).EQ.2.0#E0) THEN
           TSEAR(I) = MIN(TSEAR(I),271.2#E0)
        ELSE IF(SLMSKR(I).EQ.0.0#E0) THEN
           TSEAR(I) = MAX(TSEAR(I),271.21#E0)
        ELSE IF(SLMSKR(I).EQ.1.0#E0 .AND. SHELGR(I).GT.0.0#E0)
     1  THEN
           TSEAR(I) = MIN(TSEAR(I),273.16#E0)
        ENDIF
  340 CONTINUE
      IF (KDAPRX.EQ.0) THEN
C        **********************************************
C...      COMPUTE COSINE SOLAR ZENITH ANGLE IF KDAPRX=0
C...      DTSWAV IS SW RADIATIVE TIME STEP IN HOURS
C        **********************************************
        CALL ZENITH(FJD,DLT,SLAG,RLAT(1),RLON(1),WRKEMA(1),
     1              DTSWAV,#LONR2,COSZRO(1),TAUDAR(1))
      ELSE
C        **********************************
C...      DIURNAL CYCLE APPROXIMATION
C        **********************************
        DO 360 I=1,#LONR2
          TAUDAR(I) = 1.#E0
          COSZRO(I) = COSZER(I)
  360   CONTINUE
      ENDIF
C....  ************************************
C   THE FOLLOWING DETERMINES SURFACE ALBEDO (ALBDOA),WHERE SNOW EXISTS.
C....  ************************************
      DO 380 I=1,#LONR2
        WRKEMA(I) = 0.#E0
        SSNOW(I) = SHELGR(I) * 0.1#E0
  380 CONTINUE
      CALL ALBSNO(#LONR2,LAT,JSNO,
     1            ALBDOA(1),RLAT(1),ALBEDR(1),SLMSKR(1),
     1            SSNOW, TGR(1), TGRS(1,1) )
C....
      RETURN
      END
