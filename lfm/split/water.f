       SUBROUTINE WATER
C$$$   SUBPROGRAM  DOCUMENTATION  BLOCK
C
C SUBPROGRAM: WATER          LARGE AND SUB-GRID SCALE MOIST PHYSICS
C   AUTHOR: DENNIS DEAVEN    ORG: W/NMC23    DATE: 23 JUN 83
C
C ABSTRACT: PERFORMS MOIST AND DRY ADJUSTMENTS IN THE FOLLOWING ORDER:
C   (1)  LARGE SCALE PRECIPITATION INCLUDING EVAPORATION ON THE WAY
C        DOWN.  DONE EVERY TIME STEP. (NO LATENT HEAT RELEASE DURING
C        FIRST 4 HOURS OF INTEGRATION).
C   (2)  SUB GRID SCALE CONVECTION WITH NO EVAPORATION. DONE EVERY TIME
C        STEP DURING FIRST 4 HOURS OF INTEGRATION AND ONCE PER TIME
C        STEP THEREAFTER. (NO LATENT HEAT RELEASE FIRST 4 HOURS)
C   (3)  DRY CONVECTIVE ADJUSTMENT DONE EVERY TIME STEP.
C***NOTE***   THIS ROUTINE IS CALLED ONCE PER TIME STEP WHEN K = 7
C             AFTER MASS AND MOISTURE VARIABLES HAVE BEEN STEPPED
C             FORWARD IN TIME
C
C USAGE:  CALL WATER
C
C - - - - - - - - - I N P U T   V A R I A B L E S  - - - - - - - - -
C     NAMES       MEANING/CONTENT/PURPOSE/UNITS/TYPE        INTERFACE
C     -----       ----------------------------------        ---------
C     US,VS..     FORECAST VARIABLES PLUS FIXED FIELDS      /DEABLK/
C     MNSTEP      TIME STEP INDEX (1,2,3...NPHOUR)          /TTME/
C     K7NEW..     LAYER/TIME INDICIES                       /INDEX/
C
C - - - - - - - - - O U T P U T   V A R I A B L E S - - - - - - - - - -
C     NAMES       MEANING/CONTENT/PURPOSE/UNITS/TYPE        INTERFACE
C     -----       ----------------------------------        ---------
C     TS          POT. TEMP. AFTER ADJUSTMENTS TO TAU+1     /DEABLK/
C     WS          PRECIP. WATER        DITTO                  DITTO
C     PSIG        DP/D(SIGMA)          DITTO                  DITTO
C
C - - - - - - - - - S U B P R O G R A M S   C A L L E D - - - - - - - -
C     NAME(S)                                               LIBRARY
C     -------                                               -------
C     LCL,UNPSEP                                            LFMLIB
C
C - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
C ATTRIBUTES:
C   LANGUAGE: SiliconGraphics 3.5 FORTRAN 77
C   MACHINE:  SiliconGraphics IRIS-4D/25, 35, INDIGO
C$$$
C
      IMPLICIT    REAL (A-H,O-Z)
      REAL        HOUR1
      REAL        ICE, MF
      REAL        PSS(8)
      LOGICAL     THIN,CONDIN
      CHARACTER*4 LABSIN,LABBND,LABS00,LABS06,LABS12,LABV06,LABV12
      COMMON /VTEMP/ SIGDOT( 53 , 45 ,5 ), VT( 53 , 45 ,25 )
      COMMON /GEOPOT/ PHI( 53 , 45 ,7 ),  PI( 53 , 45 ,7 )
      COMMON /DEABLK/ US( 53 , 45 , 21 ),
     A     VS( 53 , 45 , 21 ),
     1     TS( 53 , 45 , 21 ),PSIG( 53 , 45 ,6),
     2     ST( 53 , 45 ),ICE( 53 , 45 ),
     3     COSZEN( 53 , 45 ),XM( 53 , 45 ),
     4     F( 53 , 45 ),CD( 53 , 45 ),
     5     SATW( 53 , 45 ,3),WS( 53 , 45 , 9 ),
     6     PREC( 53 , 45 ),ZSTAR( 53 , 45 ),
     7     ALON( 53 , 45 ),ALAT( 53 , 45 ),
     8     MF( 53 , 45 ),H2( 53 , 45 , 3 )
      COMMON /VERTV/ IVVEL( 53 , 45 , 8 )
      COMMON /CNST/ BTHICK,BTHIK1,BTHK3,DT,RDELX,
     1              DTDS0,DTDS1,DTDS2,DTDX,DS1DX,DS2DX,
     2              CP,R,ROCP,TSTRAT,CPTS,SATRH,RSAT60,
     3              RDT,BTHICH,BTHK3H,BTK398,RBT,A1BRN,
     4              A2BRN,TDTDX4,RPK,VVCNST
      COMMON /DIAG/ SUMK(8),SUMP1(8),SUMP2(8),SUMS(8),SUMF(8),SUMFD(8),
     1     SUMVOR(8),SUMDIV(8),DP(8),SUMP(8),SUMTS(8),SUMZ(8),
     2     SIGB1,SIGT1,SIGT2,SIGS1,SIGS2,RMSSFC,RMSTRP
      COMMON /FASTER/ PIE(1100),AX(120)
      COMMON /INDEX/ LI,LJ,LK,LI1,LJ1,LK1,LI2,NIJ,LOLD,LMID,LNEW,
     1     K7OLD,K7MID,K7NEW,K3OLD,K3MID,K3NEW,K2OLD,K2MID,K2NEW,
     2     K,K1,K2,K3,KL,KH
      COMMON /FDATE/  IYEAR, IMO, IDAYMO, IZTIME, IHR1, IOUT
      COMMON /SVHOUR/ NWDS, IHOUR1( 1205 ), HOUR1(8)
      COMMON /TTME/   MNSTEP,IODD,IHOUR,IMONTH,ITSW,IVEL,NPHOUR,
     1                SSLDC,CSLDC,SSLHR,CSLHR,SHR,CHR,
     2                ALP,XDAYMO
      COMMON /FORTAP/ LUNBND,LUNSIN,LUNS00,LUNS06,LUNS12,LUNV06,LUNV12,
     A                LABSIN(8),LABBND(8),LABS00(8),LABS06(8),LABS12(8),
     B                LABV06(8),LABV12(8),PARM(25)
      COMMON /PBNDPE/ ALARGE( 53 ,12, 23 ), BLARGE( 12, 33 ,23 )
      COMMON /PBNDRY/ AA( 53 ,12, 23 ), BB( 12, 33 ,23 )
      SAVE
C
      SV(T) = 6.1078E0 * EXP( 17.2694E0*T/(T + 237.3E0))
      EEP(T,SVA,P) = EXP((596.73E0-0.601E0*T) *
     2                   ((0.62197E0*SVA)/(P - SVA))/
     3                   (0.24E0*(T + 273.16E0)))
C----------------------------------------------------------------------
C  NOTE*****  THIS ROUTINE IS ONLY CALLED ONCE WHEN K = 7
C  USE VT(16) TO STORE RAIN ON THE WAY DOWN
C  USE VT(17) TO STORE SUPERSATURATION VALUE
C  USE VT(18) TO STORE TEMP SUPERS (B IN OLD CODE)
C----------------------------------------------------------------------
      DO 88890 IQ2W6E=1,NIJ
         VT(IQ2W6E,1,16)=0.E0
88890 CONTINUE
       DO 160 LL = 1,3
      DO 88900 IQ2W6E=1,NIJ
         VT(IQ2W6E,1,18)=VT(IQ2W6E,1,16)
88900 CONTINUE
       LAY = 4 - LL
       IF( LAY.EQ.3)THEN
      DO 88910 IQ2W6E=1,NIJ
         VT(IQ2W6E,1,19)=VT(IQ2W6E,1,10)
88910 CONTINUE
      END IF
       IF( LAY .EQ.1 )THEN
      DO 88920 IQ2W6E=1,NIJ
         VT(IQ2W6E,1,19)=BTHICK
88920 CONTINUE
      END IF
      DO 88930 IQ2W6E=1,NIJ
         VT(IQ2W6E,1,17)=WS(IQ2W6E,1,K3NEW+LAY-1)-SATW(IQ2W6E,1,LAY)
         VT(IQ2W6E,1,16)=VT(IQ2W6E,1,16)+VT(IQ2W6E,1,17)
88930 CONTINUE
C****  WHERE (VT(1,1,16  ;  NIJ).LE.0.E0)VT(1,1,17  ;  NIJ) =0.E0
         IQ2W6E=IQ2W6E
      DO 88950 IQ2W6E=1,NIJ
         IF(.NOT.(VT(IQ2W6E,1,16).LE.0.E0))GO TO 88950
         VT(IQ2W6E,1,17)=0.E0
88950 CONTINUE
         IQ2W6E=IQ2W6E
C****  WHERE (VT(1,1,16  ;  NIJ).GE.0.E0)VT(1,1,18  ;  NIJ) =0.E0
         IQ2W6E=IQ2W6E
      DO 88960 IQ2W6E=1,NIJ
         IF(.NOT.(VT(IQ2W6E,1,16).GE.0.E0))GO TO 88960
         VT(IQ2W6E,1,18)=0.E0
88960 CONTINUE
         IQ2W6E=IQ2W6E
C****  WHERE (VT(1,1,16  ;  NIJ).LT.0.E0)VT(1,1,16  ;  NIJ) =0.E0
C****  VT(1,1,17  ;  NIJ) = VT(1,1,17  ;  NIJ) - VT(1,1,18  ;  NIJ)
         IQ2W6E=IQ2W6E
      DO 88970 IQ2W6E=1,NIJ
         IF(.NOT.(VT(IQ2W6E,1,16).LT.0.E0))GO TO 88970
         VT(IQ2W6E,1,16)=0.E0
88970 CONTINUE
         IQ2W6E=IQ2W6E
      DO 88980 IQ2W6E=1,NIJ
         VT(IQ2W6E,1,17)=VT(IQ2W6E,1,17)-VT(IQ2W6E,1,18)
         WS(IQ2W6E,1,K3NEW+LAY-1)=WS(IQ2W6E,1,K3NEW+LAY-1)-VT(IQ2W6E,1
     *   ,17)
88980 CONTINUE
       IF( IHOUR .LE. 3 ) GO TO 160
      DO 89000 IQ2W6E=1,NIJ
         VT(IQ2W6E,1,20)=1102.4145E0*VT(IQ2W6E,1,17)/(PI(IQ2W6E,1,LAY)
     *   *VT(IQ2W6E,1,19))
         TS(IQ2W6E,1,K7MID+LAY-7)=TS(IQ2W6E,1,K7MID+LAY-7)+VT(IQ2W6E,1
     *   ,20)
         TS(IQ2W6E,1,K7NEW+LAY-7)=TS(IQ2W6E,1,K7NEW+LAY-7)+VT(IQ2W6E,1
     *   ,20)
89000 CONTINUE
160    CONTINUE
      DO 89030 IQ2W6E=1,NIJ
         PREC(IQ2W6E,1)=PREC(IQ2W6E,1)+VT(IQ2W6E,1,16)
89030 CONTINUE
C----------------------------------------------------------------------
C  MOIST CONVECTION HERE ONLY FOR MNSTEP EQUAL TO ONE
C  DRY ADJUSTMENT FOR ALL VALUES OF MNSTEP
C----------------------------------------------------------------------
C$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
C          CONVECTION ROUTINE    AT GRID POINTS
C     CHECK VERTICAL TEMPERATURE AT GRIDPOINTS FOR STABILITY
C
C        SKIP CONVECTION IF IN BOUNDARY ZONE
C
C
C        DO MOIST CONVECTIVE ADJUSTMENT EVERY TIME STEP
C        FOR THE FIRST FOUR HOURS OF THE FORECAST
C        (BUT DISCARD ANY LATENT HEAT AND RAIN RESULTING)
C
C        AFTER THEN, DO MOIST IN FIRST TIME STEP OF HOUR
C        AND KEEP RAIN AND LATENT HEAT. (MORE ENGINEERING).
C
C         DRY CONVECTIVE ADJUST DONE EVERY TIME, NO MATTER WHAT.
C
      JCONV = LJ - 5
      ICONV = LI - 5
      IF(IHOUR.LE.3)GO TO 8642
      IF(MNSTEP.NE.1)GO TO 2042
 8642 CONTINUE
      DO 89040 IQ2W6E=1,NIJ
         VT(IQ2W6E,1,1)=50.E0+3.E0*PSIG(IQ2W6E,1,K2NEW)+3.E0*PSIG
     *   (IQ2W6E,1,K2NEW+1)+BTHICH
         VT(IQ2W6E,1,2)=VT(IQ2W6E,1,1)-.5E0*PSIG(IQ2W6E,1,K2NEW)-BTHIC
     *   H
         VT(IQ2W6E,1,3)=VT(IQ2W6E,1,2)-PSIG(IQ2W6E,1,K2NEW)
         VT(IQ2W6E,1,4)=VT(IQ2W6E,1,3)-PSIG(IQ2W6E,1,K2NEW)
         VT(IQ2W6E,1,5)=BTHICK
         VT(IQ2W6E,1,6)=PSIG(IQ2W6E,1,K2NEW)
         VT(IQ2W6E,1,7)=PSIG(IQ2W6E,1,K2NEW)
         VT(IQ2W6E,1,8)=PSIG(IQ2W6E,1,K2NEW)
89040 CONTINUE
      DO 830 J = 6,JCONV
      DO 830 I = 6,ICONV
      DO 830 L = 1,3
      IF (WS(I,J,K3NEW+L-1) .LT. WS(I,J,K3MID+L-1)) GO TO 830
      RH = WS(I,J,K3NEW+L-1) / SATW(I,J,L)
      CONDIN = .FALSE.
      IF (RH.GE.1.E0) GO TO 810
      IF (RH.LT.0.75E0) GO TO 830
C     TEST FOR CONDITIONAL INSTABILITY
C     FIRST COMPUTE LCL  ,  NEEDS POTENTIAL TEMP AND MIXING RATIO
C     RETURNS PRESSURE AND TEMP  (DEG C)
      THE = TS(I,J,K7NEW+L-7) + 1.5E0
      TC  = THE * PI(I,J,L ) - 273.16E0
      ES  = SV(TC)
      SATMIX = .622E0 * (ES/(VT(I,J,L) - ES))
      RMIX = (.622E0 * SATMIX * RH)/(.622E0 + SATMIX*(1.E0-RH))
      CALL LCL(THE,RMIX,PLCL,TLCL,NS)
      IF (NS .GE. 20)  GO TO 2042
      IF (PLCL.LE.VT(I,J,L+1)) GO TO 830
C     GERE ONLY IF SATURATION REACHED BY RISING PARCEL BELOW MIDDLE OF
C     LAYER ABOVE
      ES = SV(TLCL)
      PSEPOT = THE * EEP(TLCL, ES, PLCL)
      CONDIN = .TRUE.
C   NOW MAKE ADJUSTMENTS IF NECESSARY  -  SAME CODE AS FOR SATURATED
      GO TO 820
C     COME TO 810 FOR SATURATED LAYER
810   THE = TS(I,J,K7NEW+L-7)
      TC = THE * PI(I,J,L) - 273.16E0
      ES = SV(TC)
      PSEPOT = THE * EEP(TC, ES, VT(I,J,L))
C     FIND TEMP ALONG MOIST ADIABAT IN LAYER ABOVE
  820 CONTINUE
      PIIN=1.E0/PI(I,J,L+1)
      CALL UNPSEP(PSEPOT,VT(I,J,L+1),PIIN,TC,TR,NS)
C  IF(NS .GE. 100)  SKIP CONVECTION AT THIS POINT
      IF (NS .GE. 100) GO TO 2042
      TABOV = PIIN * (TR+273.16E0)
      ADJ = TS(I,J,K7NEW+L-6) - TABOV
      IF (ADJ.GE.-0.1E0) GO TO 830
      DTH2 = -ADJ *.1E0 * NPHOUR
      CNRAIN = DTH2/PIIN*4.1004E-4*VT(I,J,L+5)
      CNRAIN = MIN(CNRAIN,.25E0*WS(I,J,K3NEW+L-1))
      DTH2   = CNRAIN*PIIN/(4.1004E-4*VT(I,J,L+5))
      DTH2   = DTH2*0.5E0
      WS(I,J,K3NEW+L-1) = WS(I,J,K3NEW+L-1) - CNRAIN
C  FOR  -LFM- IF LSW6  EQ 1 NO CONVECTIVE RAIN IN PRECIP
      IF (LSW6 .EQ. 1) CNRAIN = 0.E0
      PREC(I,J)=PREC(I,J) + CNRAIN
C
C        DISCARD CONVECTIVE LATENT HEAT IN FIRST FOUR HOURS
C
      IF (IHOUR.LE.3) DTH2 = 0.E0
      TS(I,J,K7NEW+L-6) = TS(I,J,K7NEW+L-6) + DTH2
      TS(I,J,K7MID+L-6) = TS(I,J,K7MID+L-6) + DTH2
  830 CONTINUE
 2042    CONTINUE
C
C        HERE DO THE TEST FOR DRY CONVECTIVE INSTABILITY WITH
C        ADJUSTMENTS AS NECESSARY, PRECEEDED BY A TEST
C        FOR THIN STRATOSPHERE
C
      DO 31041 J = 6,JCONV
      DO 31041 I = 6,ICONV
      IF (PSIG(I,J,K2NEW+1) .GE.15.E0 ) GO TO 3041
      THIN = .TRUE.
      LE = 4
      LB = 7
      GO TO 6041
C     TEST FOR SUPERADIABATIC (DRY) POINTS
 3041 THIN = .FALSE.
C     TEST FOR SUPERADIABATIC (DRY) POINTS
      DO 5041  L = 2,  7
      LE1 = L
      IF(TS(I,J,K7NEW+L-7) .LT. TS(I,J,K7NEW+L-8))GO TO 7041
 5041 CONTINUE
C      ALL LAYERS STABLE
        GO  TO  28041
C     ADJUST AND CORRECT SUPERADIABATIC (DRY) POINTS ITERATIVELY
C     WITH WEIGHTS TO CONSERVE INTERNAL AND POTENTIAL ENERGY
 7041 LE = LE1 - 1
      LB = LE1
6041  A = PSIG(I,J,K2NEW+1)
      B = PSIG(I,J,K2NEW)
      PSS(8) = 50.E0
      PSS(7) = PSS(8) + A
      PSS(6) = PSS(7) + A
      PSS(5) = PSS(6) + A
      PSS(4) = PSS(5) + B
      PSS(3) = PSS(4) + B
      PSS(2) = PSS(3) + B
      PSS(1) = PSS(2) + BTHICK
      A = (PSS(1)*.001)**REAL(ROCP)
      B = (PSS(2)*.001)**REAL(ROCP)
      C = (PSS(3)*.001)**REAL(ROCP)
      D = (PSS(4)*.001)**REAL(ROCP)
      E = (PSS(5)*.001)**REAL(ROCP)
      FF= (PSS(6)*.001)**REAL(ROCP)
      G = (PSS(7)*.001)**REAL(ROCP)
      H = (PSS(8)*.001)**REAL(ROCP)
      PSS(1) = PSS(1)*A - PSS(2)*B
      PSS(2) = PSS(2)*B - PSS(3)*C
      PSS(3) = PSS(3)*C - PSS(4)*D
      PSS(4) = PSS(4)*D - PSS(5)*E
      PSS(5) = PSS(5)*E - PSS(6)*FF
      PSS(6) = PSS(6)*FF- PSS(7)*G
      PSS(7) = PSS(7)*G - PSS(8)*H
15041 A = 0.E0
      B = 0.E0
      DO 19041 L = LE,LB
      A = A + TS(I,J,K7NEW+L-7) * PSS(L)
      B = B + PSS(L)
19041 CONTINUE
      T2=A/B
      DO 22041 L=LE,LB
      TS(I,J,K7MID+L-7) = TS(I,J,K7MID+L-7) + T2 - TS(I,J,K7NEW+L-7)
      TS(I,J,K7NEW+L-7) = T2
22041 CONTINUE
      IF (THIN) GO TO 3041
      IF (LB .GE.7) GO TO 28041
      IF (TS(I,J,K7NEW+LB-6) .GE. TS(I,J,K7NEW+LB-7)) GO TO 3041
      LB = LB + 1
       GO  TO  15041
28041 CONTINUE
31041 CONTINUE
      RETURN
      END
