      SUBROUTINE OUTSCALE( NG, NTV, EM, SCR)
C$$$  SUBPROGRAM DOCUMENTATION BLOCK
C
C SUBPROGRAM:    OUTSCALE    COMPUTE STEREOGRAPHIC MAP SCALE FACTOR
C   PRGMMR: N PHILLIPS       ORG: W/NMC22    DATE: 84-02-14
C
C ABSTRACT: THE FORMULA FOR EM IS
C   .
C   EM= DS(PROJECTION)/DS(EARTH)
C   EM = 1.0 + F * (DELTA/(2* EARTH RADIUS))**2.
C   .
C   WHERE  DELTA IS THE DISTANCE ON THE PROJECTION BETWEEN GRID
C   .      POINTS(= 2*EARTH RADIUS  /  (NH+.5) FOR GRID A  ),
C   .
C   .      F IS GIVEN BY
C   .
C   F = ( I - IP)**2 + (J-JP)**2
C   .
C   AND IP AND JP ( NON-INTEGERS) ARE THE COORDINATES OF THE
C   NORTH POLE.
C   THE ROUTINE IS TOLD THROUGH  NTV  WHETHER THE SCALE FACTOR
C   IS WANTED ON THE  H, HU, HV OR THE CENTER POINTS OF AN
C   NGM GRID SQUARE.
C   .
C PROGRAM HISTORY LOG:
C   84-02-14  N PHILLIPS
C   88-08-26  B SCHMIDT
C
C USAGE:  CALL OUTSCALE( NG, NTV, EM, SCR )
C   INPUT ARGUMENT LIST:
C     NG       - THE NUMBER OF THE NGM GRID( GRIDA=1,ETC).
C     NTV      - =1 FOR HU POINTS,
C                =2 FOR HV POINTS,
C                =3 FOR H  POINTS,
C                =4 FOR POINTS IN CENTER OF GRID SQUARE.
C     SCR      - SCRATCH ARRAY OF SIZE IMG(NG) * JMG(NG)
C
C   OUTPUT ARGUMENT LIST:
C     EM       - ARRAY OF MAP SCALE FACTOR
C
C   OUTPUT FILES:
C     IOUTUPRT - PRINTOUT OF ERROR MESSAGE
C
C   SUBPROGRAMS CALLED:
C     UNIQUE:    - ERRPRINT
C     LIBRARY:
C       COMMON   - COMBLANK
C                  COMCONST
C                  COMOUT
C
C ATTRIBUTES:
C   LANGUAGE: FORTRAN
C   MACHINE:  CRAY Y-MP
C
C$$$
C
      INCLUDE 'parmodel'
C...TRANSLATED BY FPP 3.00Z36 11/09/90  14:43:26  
C...SWITCHES: OPTON=I47,OPTOFF=VAE0
C
C     COMMON BLOCK /COMCONST/ CONTAINS GRID-RELATED PARAMETERS,
C          AND A FEW OTHER COMMON CONSTANTS.
      COMMON /COMCONST/ IJMAX, KM, LVLTOT, IJRAD, LOFCLDS(2,4),
     1                  ICALLRAD, IPHYSPL, NGRDUSE, NH,
     2                  NTIME, ITIME, NSTEPS,
     3                  IMG(INGRDUSE), JMG(INGRDUSE),
     4                  IAG(INGRDUS1), JAG(INGRDUS1),
     5                  IBG(INGRDUS1), JBG(INGRDUS1),
     6                  IADDRG(INIADDRS, INGRDUSE),
     7                  NPTSFH(2, INGRDUSE),
     8                  KUMULUS, LGRIDPPT, KLIFT1, KLIFT2, IBUCKET,
     9                  XPOLEH(INGRDUSE), YPOLEH(INGRDUSE), RADIUS,
     1                  DELSIG(IKM), PR(IKM), PRESS(IKM),
     2                  SIGINT(IKMP1),
     3                  DTOVDX, ANGVEL,
     4                  SIGMACC, SIGMAGSP, SIGMADHQ, CRITCONV,
     5                  SATDEL, RHFACTOR, QBOUND,
     6                  ANEM, BLKDR, CHARN, CONAUST, DDORF, PKATO,
     7                  SCALEHT, SIGDOT, DLAMNGM
C
      DIMENSION EM(*),SCR(*)
C
C
C              SPECIFY THE UNIT NUMBER OF THE PRINTER.
      IOUTUPRT = 6
C
      IM=IMG(NG)
      JM=JMG(NG)
C          GET THE FACTOR GRID INTERVAL / TWICE EARTH RADIUS
      DEL=1.E0 / ( FLOAT(NH) + .5E0 )
C          REDUCE TO VALUE FOR GRID NG.
      DO 10 N=1,NGRDUSE
      IF( N .EQ. NG ) GO TO 30
      DEL=.5E0*DEL
   10 CONTINUE
C          NG IS TOO LARGE
      WRITE (IOUTUPRT, 20) NG
   20 FORMAT(1H1,2X,'********SR OUTSCALE (IN OUTPUT OPERATION) GIVEN',
     1 ' TOO LARGE NG=',I9,', NTV=',I5)
C*****  Code Expanded From Routine:  ERRPRINT
      PRINT 77001
77001 FORMAT (1H1, '  **********  PRINT FROM SUBROUTINE ERRPRINT ',
     1             'FOLLOWS. ***********')
C
      PRINT 77002, IJMAX, KM, LVLTOT, NGRDUSE, NH
77002 FORMAT (1H1, 2X, 'IJMAX, KM, LVLTOT, NGRDUSE, NH =', 5I10)
C
      PRINT 77003, NTIME, ITIME, NSTEPS
77003 FORMAT (1H0, 2X, 'NTIME, ITIME, NSTEPS= ', 3I10 /)
C*****  End of Code Expanded From Routine:  ERRPRINT
C
      CALL EXIT(16)
C
   30 CONTINUE
C
C          WE REALLY NEED DEL**2
      DEL2=DEL*DEL
C
C          IP AND JP FOR H POINTS
      XP=XPOLEH(NG)
      YP=YPOLEH(NG)
C          IS THIS FOR HU POINTS?
      IF( NTV .EQ. 1 ) YP=YP-.5E0
C          IS THIS FOR HV POINTS?
      IF( NTV .EQ. 2 ) XP=XP-.5E0
      IF( NTV .NE. 4 ) GO TO 5
      XP=XP-.5E0
      YP=YP-.5E0
C
    5 CONTINUE
C
C
C          GET IM ARRAY OF DEL2 * (I-IP)**2
CMIC$ DO ALL VECTOR SHARED(IM, XP, DEL2, SCR) PRIVATE(IQ2, IQ2W6E)
      DO 1001 IQ2 = 1, IM
         SCR(IQ2) = FLOAT(IQ2)
         SCR(IQ2) = SCR(IQ2) - XP
         SCR(IQ2) = SCR(IQ2)*SCR(IQ2)
         SCR(IQ2) = DEL2*SCR(IQ2)
 1001 CONTINUE
C
C          FILL OUT THE ENTIRE ARRAY BY ADDING J-DEPENDENT PART.
      DJ=-YP
      IAD=1-IM
C
      DO 40 J=1,JM
      DJ=DJ + 1.E0
      DJ2=DEL2*DJ*DJ + 1.E0
      IAD=IAD + IM
CMIC$ DO ALL VECTOR SHARED(IM, DJ2, IAD, SCR, EM) PRIVATE(IQ2W6E)
      DO 88920 IQ2W6E=1,IM
         EM(IAD+IQ2W6E-1)=DJ2+SCR(IQ2W6E)
88920 CONTINUE
C
   40 CONTINUE
C
C
      RETURN
      END
