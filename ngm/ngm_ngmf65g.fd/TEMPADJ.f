      SUBROUTINE TEMPADJ( DTNOW,DTACCUM)
C$$$  SUBPROGRAM DOCUMENTATION BLOCK
C
C SUBPROGRAM:    TEMPADJ     CORRECT POTENTIAL TEMPERATURE VALUES
C   PRGMMR:  J TUCCILLO        ORG: W/NMC4      DATE: 90-06-17
C
C ABSTRACT: CORRECT POTENTIAL TEMPERATURE VALUES SO
C   .       THAT THE HORIZONTAL AVERAGE VALUE IN EACH
C   .       SIGMA LAYER IS RESTORED TO ITS ORIGINAL VALUE
C   AN AREA WEIGHTED VALUE OF THETA IS COMPUTED AND USED TO
C   GET A UNIFORM CORRECTION TO RESTORE THE HORIZONTAL AVERAGE.
C   THE  AREA ELEMENT  E  IS PROPORTIONAL TO SQUARE OF THE MAP FACTOR
C   .
C   .     DA = CONSTANT *  E  WHERE
C   .
C   .      E = ESS(GRID) / EM**2
C   .
C   .     ESS = SQUARE OF DELTAX / (2*RADIUS EARTH)
C   .
C   .      EM = 1 + ESS(GRID)*( (I-XPOLE)**2 + (J-YPOLE)**2 )
C   .
C   IF SPT DENOTES A SUM OVER THE FORECAST PTS OF A GRID, AND
C   SGD DENOTES A SUM OVER ALL FORECAST GRIDS, THEN THE
C   HORIZONTALLY AVERAGED THETA IS GIVEN BY
C   .
C   .                       SGD SPT ( E * THETA )
C   .        THETA AVG  =  ----------------------
C   .                         SGD SPT ( E )
C   .
C PROGRAM HISTORY LOG:
C   90-06-17  J TUCCILLO
C
C USAGE:  CALL TEMPADJ ( DTNOW,DTACCUM)
C   OUTPUT ARGUMENT LIST:
C     DTNOW    - CHANGE THAT WILL BE MADE TO THETA FIELD
C     DTACCUM  - ACCUMULATED CHANGES SINCE START OF FCST.
C
C   SUBPROGRAMS CALLED:
C     LIBRARY:
C       COMMON   - COMCONST
C                  COMBLANK
C
C REMARKS:
C   - - - - - - - - I N P U T   V A R I A B L E S  - - - - - - - - -
C   .
C   NAMES       MEANING/CONTENT/PURPOSE/UNITS/TYPE        INTERFACE
C   -----       ----------------------------------        ---------
C   IMG,JMG     HORIZONTAL GRID DIMENSIONS OF ALL GRIDS   COMMON
C   .
C   IADDRG      INITIAL ADDRESSES OF DIFFERENT TYPE
C   .           VARIABLES AND GRIDS IN THE ARRAY VBL      COMMON
C   .
C   VBL         ARRAY CONTAINING ALL VBLS FOR ALL GRIDS   COMMON
C   .
C   - - - - - - - - O U T P U T   V A R I A B L E S - - - - - - - - - -
C   .
C   NAMES       MEANING/CONTENT/PURPOSE/UNITS/TYPE        INTERFACE
C   -----       ----------------------------------        ---------
C   VBL         THETA FIELD HAS NOW BEEN ADJUSTED          COMMON
C
C ATTRIBUTES:
C   LANGUAGE: FORTRAN
C   MACHINE:  CRAY Y-MP
C
C$$$
C
      INCLUDE 'parmodel'
C...TRANSLATED BY FPP 3.00Z36 11/09/90  15:04:34  
C...SWITCHES: OPTON=I47,OPTOFF=VAE0
      REAL SUM1U
C
C     COMMON BLOCK /COMCONST/ CONTAINS GRID-RELATED PARAMETERS,
C          AND A FEW OTHER COMMON CONSTANTS.
      COMMON /COMCONST/ IJMAX, KM, LVLTOT, IJRAD, LOFCLDS(2,4),
     1                  ICALLRAD, IPHYSPL, NGRDUSE, NH,
     2                  NTIME, ITIME, NSTEPS,
     3                  IMG(INGRDUSE), JMG(INGRDUSE),
     4                  IAG(INGRDUS1), JAG(INGRDUS1),
     5                  IBG(INGRDUS1), JBG(INGRDUS1),
     6                  IADDRG(INIADDRS, INGRDUSE),
     7                  NPTSFH(2, INGRDUSE),
     8                  KUMULUS, LGRIDPPT, KLIFT1, KLIFT2, IBUCKET,
     9                  XPOLEH(INGRDUSE), YPOLEH(INGRDUSE), RADIUS,
     1                  DELSIG(IKM), PR(IKM), PRESS(IKM),
     2                  SIGINT(IKMP1),
     3                  DTOVDX, ANGVEL,
     4                  SIGMACC, SIGMAGSP, SIGMADHQ, CRITCONV,
     5                  SATDEL, RHFACTOR, QBOUND,
     6                  ANEM, BLKDR, CHARN, CONAUST, DDORF, PKATO,
     7                  SCALEHT, SIGDOT, DLAMNGM
C
      COMMON            SCR     (IIJMAX,  INSCR),
     1                  SCRGEOG (IIJMAX,  INSCRGEO),
     2                  SCR3    (IIJKMAX, INSCR3),
     3                  FILLER  (INFILLER),
     4                  VBL     (INVBL),
     5                  BITGRDH (IIJMAX, 2, INGRDUSE),
     6                  BITGRDU (IIJMAX, 2, INGRDUSE),
     7                  BITGRDV (IIJMAX, 2, INGRDUSE),
     8                  BITSEA  (IIJMAX, INGRDUSE),
     9                  BITSNO  (IIJMAX, INGRDUSE),
     1                  BITWVL  (IIJMAX, INGRDUSE)
C
      LOGICAL BITGRDH, BITGRDU, BITGRDV, BITSEA, BITSNO, BITWVL
C
      COMMON /COM1WAY/ ITIMSTEP, ITBOUND, INGLB
      DIMENSION DTNOW(1), DTACCUM(1), ESS(INGRDUSE),TBAR0(IKM),
     1 TBAR(IKM)
C
      DATA ICALL /0/
C
      NGRDBAK = NGRDUSE
      IF( INGLB .NE. 0 ) NGRDUSE = 1
C
      IF( ICALL .NE. 0 ) GO TO 100
C           FIRST CALL
C
C            COMPUTE GRID FACTOR = SQUARE OF ( DELTAX  / 2 * RADIUS )
C
      DNH = FLOAT ( NH) + 0.5E0
      ESS(1) = 1.0 / ( DNH*DNH )
      IF( NGRDUSE .EQ. 1 ) GO TO 10
CDIR@ NEXTSCALAR
      DO 5 NG = 2,NGRDUSE
      ESS(NG) = 0.25 * ESS(NG-1)
    5 CONTINUE
C
   10 CONTINUE
C
C           COMPUTE INITIAL VALUES OF THETA BAR
C
C             GO TO THE AVERAGE VALUE ROUTINE
      IRET = 1
      GO TO 1000
C
   20 CONTINUE
C      AREASUM HAS ALSO BEEN COMPUTED. SAVE THE INITIAL MEAN VALUES
C              AND ZERO THE OUTPUT ARRAYS
CMIC$ DO ALL VECTOR SHARED(KM, TBAR, TBAR0, DTNOW, DTACCUM) PRIVATE(K)
      DO 25 K = 1,KM
      TBAR0(K) = TBAR(K)
      DTNOW(K) = 0.E0
      DTACCUM(K) = 0.E0
   25 CONTINUE
C
C                PRINT INITIAL VALUES
      DO 35 KK = 1,KM
      K = KM - KK + 1
      PRINT 30, K, TBAR0(K)
   30 FORMAT(1H0,5X,'AT LEVEL',I4,' MEAN THETA AT T= 0 IS',F12.4 )
   35 CONTINUE
C
C              THIS IS ALL THAT IS NECESSARY ON THE FIRST CALL
      ICALL = 1
      NGRDUSE = NGRDBAK
C
      RETURN
C
C--------------------------------------------------------------
C                SECOND AND LATER ENTRANCE
  100 CONTINUE
C             COMPUTE THE CURRENT AVERAGED THETAS
      IRET = 2
      GO TO 1000
C
  110 CONTINUE
C        STORE THE CHANGES
CMIC$ DO ALL VECTOR SHARED(KM,TBAR0,TBAR,DTNOW,DTACCUM)PRIVATE(KK,K)
      DO 115 KK = 1,KM
      K = KM + 1 - KK
      DTNOW(K) = TBAR0(K) - TBAR(K)
      DTACCUM(K) = DTACCUM(K) + DTNOW(K)
  115 CONTINUE
C
C            MAKE THE CORRECTION
      NGRDUSE = NGRDBAK
      DO 150 NG = 1,NGRDUSE
      IM = IMG(NG)
      JM = JMG(NG)
      IJ = IM*JM
      IADH = IADDRG(5,NG)
      IADT = IADDRG(3,NG)
        DO 120 K = 1,KM
        DELTA = DTNOW(K)
CMIC$ DO ALL VECTOR IF (ABS(IADT-IADH).GE.IJ .OR. IADT-IADH.EQ.0)
CMIC$1    SHARED(IJ, IADT, DELTA, IADH, VBL) PRIVATE(IQ2W6E)
      DO 88890 IQ2W6E=1,IJ
       VBL(IADT+IQ2W6E-1)=VBL(IADT+IQ2W6E-1)+DELTA*VBL(IADH+IQ2W6E-1)
88890 CONTINUE
C
        IADT = IADT + IJ
  120   CONTINUE
C
  150 CONTINUE
      RETURN
C
C
C
C
C              ROUTINE TO COMPUTE THE HORIZONTAL AVERAGE OF THETA
 1000 CONTINUE
C         ZERO THE ARRAY FOR THE AREA SUMS
CMIC$ DO ALL VECTOR SHARED(KM, TBAR) PRIVATE(K)
      DO 1005 K = 1,KM
      TBAR(K) = 0.E0
 1005 CONTINUE
C                ZERO CONDITIONAL SUM OF AREAS
      AREASUN = 0.E0
C
      DO 1100 NG = 1,NGRDUSE
      IM = IMG(NG)
      JM = JMG(NG)
      IJ = IM*JM
C
C         NEED THE AREA FACTOR FOR EACH POINT
C
C         FIRST GET FIELD OF ( I - XPOLE )**2
      X1 = 1.E0- XPOLEH(NG)
        DO 1010 I = 1,IM
        SCR(I,2) = X1*X1
        X1 = X1 + 1.E0
 1010   CONTINUE
      IAD = IM+1
CMIC$ DO ALL SHARED(JM, IM, IAD, SCR) PRIVATE(J, IQ2W6E)
      DO 1015 J = 1, JM - 1
         DO 77001 IQ2W6E = 1, IM
            SCR(IAD+IQ2W6E-1+(J-1)*IM,2) = SCR(IQ2W6E,2)
77001    CONTINUE
 1015 CONTINUE
C             ADD THE TERM ( J - YPOLE )**2
      IAD = 1
      Y1 = 1.0 - YPOLEH(NG)
        DO 1020 J = 1,JM
        Y2 = Y1*Y1
CMIC$ DO ALL VECTOR SHARED(IM, IAD, Y2, SCR) PRIVATE(IQ2W6E)
      DO 88910 IQ2W6E=1,IM
         SCR(IAD+IQ2W6E-1,2)=SCR(IAD+IQ2W6E-1,2)+Y2
88910 CONTINUE
        IAD = IAD + IM
        Y1 = Y1 + 1.E0
 1020   CONTINUE
C            NOW THE MAP SCALE FACTOR
      XX = ESS(NG)
CMIC$ DO ALL VECTOR SHARED(IJ, XX, SCR) PRIVATE(IQ2W6E)
      DO 88920 IQ2W6E=1,IJ
         SCR(IQ2W6E,2)=1.0E0 / (1.0E0+XX*SCR(IQ2W6E,2))
C          SQUARE IT
C          FINALLY THE AREA ELEMENT
         SCR(IQ2W6E,1)=XX * SCR(IQ2W6E,2)*SCR(IQ2W6E,2)
88920 CONTINUE
C            ON FIRST CALL ACCUMULATE THE AREA SUM
      IF(ICALL.NE.0) GO TO 1025
      SUM = 0.
      DO 7001 IQ2 = 1, IJ
       IF ( BITGRDH(IQ2,1,NG) ) SUM = SUM + SCR(IQ2,1)
7001  CONTINUE
      AREASUN = AREASUN + SUM
C
 1025 CONTINUE
C            DIVIDE AREA ELEMENT BY H
      IADH = IADDRG(5,NG)
CMIC$ DO ALL VECTOR SHARED(IJ, IADH, SCR, VBL) PRIVATE(IQ2W6E)
      DO 88970 IQ2W6E=1,IJ
         SCR(IQ2W6E,1)=SCR(IQ2W6E,1)/VBL(IADH+IQ2W6E-1)
88970 CONTINUE
C
C             ACCUMULATE THE AREA SUM OF THETA AT EACH LEVEL
      IADT = IADDRG(3,NG)
CMIC$ DO ALL SHARED(KM, IJ, NG, IADT, BITGRDH, VBL, SCR, TBAR) PRIVATE(
CMIC$1   SUM, K, IQ2, SUM1U)
      DO 1030 K = 1, KM
         SUM1U = 0.
         DO 77002 IQ2 = 1, IJ
            IF (BITGRDH(IQ2,1,NG)) SUM1U = SUM1U + (VBL(IADT+IQ2-1+(K-1)
     1         *IJ)*SCR(IQ2,1))
77002    CONTINUE
         TBAR(K) = TBAR(K) + SUM1U
 1030 CONTINUE
C
C
C
C            END OF THE GRID LOOP
 1100 CONTINUE
C
C         FINISH THE AREASUM COMPUTATION
      IF( ICALL .EQ. 0 ) AREASUM = 1.0 / AREASUN
C
C         CONVERT SUMS TO AVERAGE VALUES
CMIC$ DO ALL VECTOR SHARED(KM, AREASUM, TBAR) PRIVATE(K)
      DO 1200 K = 1,KM
      TBAR(K) = TBAR(K) * AREASUM
 1200 CONTINUE
C
      GO TO ( 20   , 110  ) , IRET
C
C------------------------------------------------------------------
C
C
      END
