      SUBROUTINE MSTADB(H,HKAPPA,TENV,QENV,SATDEL,N,KTOP,PRESS,
     1      PR, L1, L2, SC, DY, ISCR,JTBL,TCLD,QCLD,KBUOY)
C$$$  SUBPROGRAM DOCUMENTATION BLOCK
C
C SUBPROGRAM:    MSTADB      COMPUTE MOIST ADIABATIC CLOUD SOUNDINGS
C   PRGMMR: J TUCCILLO       ORG: W/NMC4     DATE: 90-06-17
C
C ABSTRACT: INPUT ARRAYS OF N ATMOSPHERIC COLUMNS OF TEMPERATURE
C   AND SPECIFIC HUMIDITY ARE EXAMINED FOR CONDITIONAL INSTABILITY
C   FOR PARCELS ORIGINATING IN THE LAYERS L=L1,L2.  ARRAYS OF
C   CLOUD TEMPERATURE AND SATURATED SPECIFIC HUMIDITY ARE
C   RETURNED, IN WHICH THE INPUT ENVIRONMENTAL VALUES ARE REPLACED
C   BY THE WARMEST PARCEL VALUE IF THAT EXCEEDS THE ENVIRONMENTAL
C   TEMPERATURE.
C   LIFTING CONDENSATION LEVEL IS COMPUTED FROM A FORMULA USING
C   THE TEMPERATURE AND DEWPOINT DEPRESSION OF THE PARCEL IN LAYER
C   L.  EQUIVALENT POTENTIAL TEMPERATURE (THETAE) IS COMPUTED FROM
C   A TWO-DIMENSIONAL TABLE AS A FUNCTION OF TEMPERATURE AND
C   PRESSURE**KAPPA AT THE LIFTING CONDENSATION LEVEL.  TEMPERATURE
C   AND SPECIFIC HUMIDITY OF THE ASCENDING PARCEL ARE COMPUTED (FROM
C   TWO OTHER TWO-DIMENSIONAL TABLES) AS A FUNCTION OF THETAE AND
C   PRESSURE**KAPPA PROVIDED BY A THIRD INPUT ARRAY.
C   TABLES ARE COMPUTED ON THE FIRST CALL.
C   .
C   NUMERICAL VALUES FOR THE SIX PARAMETERS MUST BE DEFINED PRIOR
C   TO COMPILATION.  THE FIRST 5 DEFINE THE TABLE SIZES. THE VALUES
C   GIVEN THEM HERE ARE SUCH THAT THEY, TOGETHER WITH THE ASSIGNED
C   FIRST AND LAST VALUES OF TABLE INPUT VARIABLES, RESULT IN CLOUD
C   PROPERTIES WITH AN ERROR OF (AT MOST) ABOUT 0.1 DEGREES.
C   .
C   THE PARAMETER  NBOY  SHOULD EQUAL THE LARGEST EXPECTED VALUE
C   OF THE INPUT INTEGER  N  .
C
C PROGRAM HISTORY LOG:
C   90-06-17  J TUCCILLO
C
C USAGE:  CALL MSTADB( H, HKAPPA, TENV, QENV, SATDEL, N, KTOP, PRESS,
C       1 PR, L1, L2, SC, DY, ISCR, JTBL, TCLD, QCLD, KBUOY )
C   INPUT ARGUMENT LIST:
C     H        - ARRAY (SIZE N ) OF SURFACE PRESSURE
C                IN UNITS OF 100 CENTIBARS.
C     HKAPPA   -  ONE-DIMENSIONAL ARRAY (I=1, N)
C                 OF (SURFACE PRESSURE/100 CB)**KAPPA
C                 I DENOTES THE COLUMN NUMBER.
C     TENV     -  TWO-DIMENSIONAL ARRAY (I=1,N AND K=1,KTOP)
C                 OF INPUT 'ENVIRONMENT' TEMPS.
C                 I DENOTES THE COLUMN NUMBER, K THE VERTICAL
C                 LEVEL.
C     QENV     -  SIMILAR ARRAY FOR INPUT SPECIFIC HUMIDITIES
C     SATDEL   -  PARCEL SPECIFIC HUMIDITIES AT ORIGIN LEVEL
C                 WILL BE SET EQUAL TO (1 +SATDEL) * QENV.
C                 CURRENTLY THIS HAS BEEN MODIFIED SO THAT
C                 1 IS USED INSTEAD OF (1 + SATDEL).
C     N        -  THE NUMBER OF ATMOSPHERIC COLUMNS.
C     KTOP     -  THE NUMBER OF SIGMA LAYERS IN A COLUMN
C                 (K=1,KTOP INCREASES UPWARDS).
C     PRESS    -  ARRAY OF KTOP NUMBERS SUCH THAT
C                 PRESSURE(COLUMN I AT LEVEL K) =
C                 H(FOR COLUMN I) * PRESS(K).
C     PR       -  ARRAY OF KTOP NUMBERS SUCH THAT
C                 PI (COLUMN I AT LEVEL K) =
C                 H TO THE KAPPA POWER (FOR COLUMN I)
C                 * PR(K) * 2.
C     L1,L2    -  THE LAYERS L=L1,L2 FROM WHICH PARCELS
C                 ARE TO ORIGINATE.
C     ***  THE ABOVE INPUT DATA IS UNCHANGED UPON RETURN ***
C     SC       -  HALF-PRECISION WORK SPACE OF LENGTH N*4
C     DY       -  HALF-PRECISION WORK SPACE OF LENGTH N*KTOP
C     ISCR     -  INTEGER WORK SPACE OF LENGTH N
C     JTBL     -  INTEGER WORK SPACE OF LENGTH N*KTOP
C
C   OUTPUT ARGUMENT LIST:
C     TCLD     -  ARRAY (I,K) OF CLOUD TEMPERATURES EQUAL
C                 TO EITHER THE INPUT VALUE TENV, OR, IF
C                 SOME PARCEL HAD A TEMPERATURE .GT.TENV,
C                 THE WARMEST SUCH PARCEL TEMPERATURE.
C     QCLD     -  ARRAY (I,K) CONTAINING EITHER THE INPUT
C                 VALUE QENV, OR, IF TCLD .GT. TENV,
C                 THE SATURATED SPEC. HUMIDITY FOR TENV.
C     KBUOY    -  ARRAY OF KTOP INTEGERS.
C                 KTOP(K)=0 IF NO COLUMN HAS TCLD .GT. TENV
C                 AT THIS VALUE OF K.  IF TCLD IS .GT. TENV,
C                 KBUOY(K) WILL BE AN INTEGER .GE. THE
C                 NUMBER OF COLUMNS FOR WHICH THIS IS TRUE.
C
C   OUTPUT FILES:
C     IOUTUPRT - FOR PRINTOUT
C
C   SUBPROGRAMS CALLED:
C     UNIQUE:    - DEWPOINT
C     LIBRARY:
C
C ATTRIBUTES:
C   LANGUAGE: FORTRAN
C   MACHINE:  CRAY Y-MP
C
C$$$
C
      INCLUDE 'parmodel'
C
C*****     DIMENSIONS FOR TABLES AND THE BUOYANCY BIT VECTOR  BOY .
C*****    NWK SHOULD BE THE LARGER OF NXTHETBL OR NYTHETBL
C
      PARAMETER( NXTHETBL=41,NYTHETBL=10,NWK=41,NXCLDTBL=41,NYCLDTBL=41,
     1  NBOY= IIJMAX)
C...TRANSLATED BY FPP 3.00Z36 11/09/90  15:01:56  
C...SWITCHES: OPTON=I47,OPTOFF=VAE0
C
C          INPUT ARRAYS FROM CALL STATEMENT ARE
      DIMENSION     H(N), HKAPPA(1),  TENV(1), QENV(1),PRESS(KTOP),
     1  PR(KTOP),
     2  SC(N,4), DY(N,KTOP),ISCR(N),JTBL(N,KTOP),
     3  TCLD(1),  QCLD(1), KBUOY(KTOP)
C          THE TABLES CONSTRUCTED AND USED IN THIS SUBROUTINE ARE
      DIMENSION THETATBL(NXTHETBL,NYTHETBL), TCLDTBL(NXCLDTBL,NYCLDTBL),
     1          QCLDTBL(NXCLDTBL,NYCLDTBL)
C          A WORK ARRAY LOCAL TO THIS SUBROUTINE IS
      DIMENSION   ZQ(NWK,4)
C
      CHARACTER*35 ERRMSG(4)
C
      LOGICAL BCOLD( NBOY ), BOY( NBOY )
C
      INTEGER I1X,I2X,I3X,I4X,I5X,I6X,I7X,I8X,I9X,I10X,I11X,I12X
      DATA ICALL/0/
C
C
C          SPECIFY THE UNIT NUMBER OF THE PRINTER.
C
C
C          SPECIFY THE UNIT NUMBER OF THE PRINTER.
      IOUTUPRT = 6
C
      IF( ICALL .GT. 0 ) GO TO 500
C
      ICALL=1
C          COMPUTE TABLES, ETC.  FIRST SOME COMMON CONSTANTS.
      ZCSUBP=1005.E0
      ZRGASD=287.05E0
      ZRGASV=461.5E0
      ZKAPPA=ZRGASD/ZCSUBP
      ZKAPINV=1.E0/ZKAPPA
      ZMINKAP=-ZKAPPA
C          CONSTANTS NEEDED FOR VAPOR PRESSURE RELATIONS
C       TRIPLE POINT
      ZT3=273.16E0
C       LATENT HEAT AT TRIPLE POINT
      ZEL3=2.501E6
C       SPECIFIC HEAT OF LIQUID WATER
      ZCL=4187.E0
C       SPEC. HEAT AT CONSTANT PRESS. FOR VAPOR
      ZCPV=1876.5E0
C       SATURATION VAPOR PRESS(IN CBS) AT TRIPLE POINT
      ZVAP3=0.611E0
C           ZVAP3/100 FOR USE IN COMPUTING SPECIFIC HUMIDITY.
      ZVAP3P=.01E0*ZVAP3
C          RATIO OF GAS CONSTANTS
      ZEPS=ZRGASD/ZRGASV
C
C          THE LIFTING CONDENSATION LEVEL TEMPERATURE FORMULA IS
C
C     T(LCL)=T - DEP*( CLCL1+CLCL2*T + DEP*(CLCL3+CLCL4*T) )
C
C          WHERE   DEP IS EQUAL TO T MINUS THE DEW POINT.
C          THE CONSTANTS ARE AS FOLLOWS.
      CLCL1=0.954442E0
      CLCL2=0.967772E-3
      CLCL3=-0.710321E-3
      CLCL4=-0.270742E-5
C        (THIS HAS AN ERROR OF ABOUT 0.03 DEG FOR DEP=30 DEG)
C
C
C          CALCULATE THETAE TABLE, GIVING EQUIV. POTENTIAL
C          TEMPERATURE (USING THE DEFINITION BY ROSSBY ), AS A
C          FUNCTION OF TEMPERATURE(1ST DIMENSION) AND PRESSURE
C          TO THE KAPPA POWER(2ND DIMENSION).
C               THE TEMPERATURE RANGES
      ZT1=253.16E0
      ZT2=303.16E0
C          THE RANGE IN PRESSURE
      ZP1=0.5E0
      ZP2=1.1E0
C          CONVERT THESE INTO LIMITS OF P**KAPPA(=PI).
      ZPI1=ZP1**ZKAPPA
      ZPI2=ZP2**ZKAPPA
C          INCREMENTS IN T AND PI
      ZNXTHETA=FLOAT(NXTHETBL)
      ZNYTHETA=FLOAT(NYTHETBL)
      ZTINC=(ZT2-ZT1)/(ZNXTHETA-1.E0)
      ZPIINC=(ZPI2-ZPI1)/(ZNYTHETA-1.E0)
C          STORETHE TEMP AND PI VALUES IN ZQ(I,1) AND ZQ(I,3)
CMIC$ PARALLEL SHARED(ZPI1, ZPIINC, ZQ, ZT1, ZTINC) PRIVATE(I)
CMIC$ DO PARALLEL VECTOR
      DO 4001 I = 1, NXTHETBL
         ZQ(I,1) = ZT1 + ZTINC*FLOAT(I-1)
4001  CONTINUE
CMIC$ DO PARALLEL VECTOR
      DO 4002 I = 1, NYTHETBL
         ZQ(I,3) = ZPI1 + ZPIINC*FLOAT(I-1)
4002  CONTINUE
CMIC$ END PARALLEL
C          GET SAT.VAPOR PRESS / 100 CBS AT TABLE TEMPS. INTO ZQ(I,2)
      ZAA=(ZCL-ZCPV)/ZRGASV
      ZBB=ZEL3/(ZRGASV*ZT3)
      ZAB=ZAA+ZBB
C
CMIC$ PARALLEL SHARED(ZKAPINV, ZQ, ZT3, ZVAP3P, ZAA, ZAB) PRIVATE(I, Z1)
CMIC$ DO PARALLEL VECTOR
      DO 22 I=1,NXTHETBL
      Z1=ZT3/ZQ(I,1)
      ZQ(I,2)=ZVAP3P * (Z1**ZAA) * EXP( ZAB*(1.E0-Z1) )
   22 CONTINUE
C
C          GET PRESSURES(DVDED BY 100 CBS) FOR TABLE PI VALUES
C               INTO ZQ(I,4)
CMIC$ DO PARALLEL VECTOR
      DO 30 I=1,NYTHETBL
      ZQ(I,4)=ZQ(I,3)**ZKAPINV
   30 CONTINUE
CMIC$ END PARALLEL
C
C          LATENT HEAT( AS FCN OF TEMP) INTO ZQ(I,3)
      ZDEL=ZCPV-ZCL
      ZEL1=ZEL3+ZDEL*(ZQ(1,1)-ZT3)
      Z1=ZDEL*ZTINC
CMIC$ DO ALL VECTOR SHARED(ZEL1, Z1, ZQ) PRIVATE(I)
      DO 7001 I = 1, NXTHETBL
         ZQ(I,3) = ZEL1 + Z1*FLOAT(I-1)	
7001  CONTINUE
C          NOW REPLACE THIS WITH THE PURELY TEMPERATURE
C              DEPENDENT PART OF THE EXPONENT
      ZEPCP=ZEPS/ZCSUBP
CMIC$ PARALLEL SHARED(ZMINKAP, ZQ, THETATBL, ZEPCP) PRIVATE(J, ZPRES, I
CMIC$1   , ZPDRY, ZEXPO, ZTHETAE, IQ2W6E)
CMIC$ DO PARALLEL VECTOR
      DO 88890 IQ2W6E=1,NXTHETBL
         ZQ(IQ2W6E,3)=ZEPCP*ZQ(IQ2W6E,3)*ZQ(IQ2W6E,2)
         ZQ(IQ2W6E,3)=ZQ(IQ2W6E,3)/ZQ(IQ2W6E,1)
88890 CONTINUE
C          CAN NOW EASILY FILL OUT THE TABLE OF THETAE.
CMIC$ DO PARALLEL
      DO 34 J=1,NYTHETBL
      ZPRES=ZQ(J,4)
        DO 32 I=1,NXTHETBL
C          ZPDRY IS PRESSURE OF DRY AIR DIVIDED BY 100 CBS.
        ZPDRY=ZPRES-ZQ(I,2)
        ZEXPO=ZQ(I,3)/ZPDRY
        ZTHETAE=ZQ(I,1) * EXP(ZEXPO) * ZPDRY**ZMINKAP
        THETATBL(I,J)=ZTHETAE
   32   CONTINUE
   34 CONTINUE
CMIC$ END PARALLEL
C          CONSTANTS TO CONVERT T AND PI INTO TABLE ENTRIES.
      C1ITHE=1.E0-(ZT1/ZTINC)
      C2ITHE=1.E0/ZTINC
      C1JTHE=1.E0-(ZPI1/ZPIINC)
      C2JTHE=1.E0/ZPIINC
      ENDITHET=FLOAT(NXTHETBL) -.01E0
      ENDJTHET=FLOAT(NYTHETBL) -.01E0
C
C          CHANGE THETATBL(I,1) TO THE SMALLEST VALUE IN TABLE.
C          THIS WILL RULE OUT BUOYANCY FOR LCL PRESSURES LESS
C          THAN THAT AT LEVEL 2 IN THE TABLE( WHERE P**KAPPA
C          EQUALS ZPI1 + ZPIINC ).
      C1 = THETATBL(1,NYTHETBL)
CMIC$ DO ALL VECTOR SHARED(C1, THETATBL) PRIVATE(IQ2W6E)
      DO 88910 IQ2W6E=1,NXTHETBL
         THETATBL(IQ2W6E,1)=C1
88910 CONTINUE
C
C          COMPUTE THE TABLES TCLDTBL(I,J) AND QCLDTBL(I,J) TO
C          GET TEMPERATURE AND SPECIFIC HUMIDITY FROM
C          THETAE (I) AND PRESSURE (J).
C               RANGE IN THETAE AND PRESSURE.
      ZTHE1=248.E0
      ZTHE2=500.E0
      ZP1=0.05E0
      ZP2=1.1E0
C          CHANGE TO PI AS THE TABLE ORDINATE(2ND DIMENSION).
      ZPI1=ZP1 ** ZKAPPA
      ZPI2=ZP2 ** ZKAPPA
C
      ZNXCLD=FLOAT(NXCLDTBL)
      ZNYCLD=FLOAT(NYCLDTBL)
C          TABLE INCREMENTS IN THETAE AND PI.
      ZTINC=(ZTHE2-ZTHE1)/(ZNXCLD-1.E0)
      ZPIINC=(ZPI2-ZPI1)/(ZNYCLD-1.E0)
C          SOME CONSTANTS FOR THE NEWTON ITERATION FOR TEMPERATURE.
      ZEL0=ZEL3-ZDEL*ZT3
      Z1OVRV=1.E0/ZRGASV
C          TEST CRITERION
      ZTEST=1.E-4
      ZPI=ZPI1-ZPIINC
C
      DO 44 J=1,NYCLDTBL
      ZPI= ZPI + ZPIINC
      ZPRES=ZPI ** ZKAPINV
C
      ZTHE=ZTHE1-ZTINC
C          A REASONABLE FIRST GUESS FOR ZGES=TEMPERATURE
      ZGES=ZTHE1 * ZPI
C
        DO 42 I=1,NXCLDTBL
        ZTHE=ZTHE+ZTINC
C
C          ***** ENTER NEWTON ITERATION FOR TEMPERATURE=ZGES.
   40     Z1OVT=1.E0/ZGES
C          GET SATN PRESS DVDED BY 100 CBS.
          Z1=ZT3*Z1OVT
          ZVAP=ZVAP3P * (Z1**ZAA) * EXP( ZAB*(1.E0-Z1) )
C          PRESSURE OF DRY AIR / 100 CBS.
          ZPDRY=ZPRES-ZVAP
          Z1OVPDRY=1.E0/ZPDRY
C          THE LATENT HEAT
          ZEL=ZEL0+ZDEL*ZGES
C          ROSSBY'S EXPONENT
          ZEXPO=ZEPCP*ZEL*ZVAP*Z1OVT*Z1OVPDRY
C          CURRENT VALUE OF THETAE USING ZGES FOR TEMPERATURE.
          ZFUN=ZGES * EXP(ZEXPO) * (ZPDRY**ZMINKAP)
C          GET THE T DERIVATIVE OF (ZTHE-FUN)
          ZDER=-ZFUN*( 1.E0 + ZEXPO*(  Z1OVRV*ZEL*ZPRES*Z1OVT
     1         *Z1OVPDRY + ZDEL*ZGES/ZEL )  )*Z1OVT
          ZCHG=-(ZTHE-ZFUN)/ZDER
          ZGES=ZGES+ZCHG
          IF( ABS(ZCHG) .GT. ZTEST ) GO TO 40
C          ENUF ITERATIONS
C
        Z1=ZT3/ZGES
        ZVAP=ZVAP3P * (Z1**ZAA) * EXP( ZAB*(1.E0-Z1) )
C          THE SATURATED SPECIFIC HUMIDITY
        ZQQ=ZEPS*ZVAP/(ZPRES-ZVAP)
        TCLDTBL(I,J)=ZGES
        QCLDTBL(I,J)=ZQQ
   42   CONTINUE
   44 CONTINUE
C
C          CONSTANTS TO GET TABLE ENTRIES.
      C1ITFM=1.E0-ZTHE1/ZTINC
      C2ITFM=1.E0/ZTINC
      C1JTFM=1.E0-ZPI1/ZPIINC
      C2JTFM=2.E0/ZPIINC
      ENDJTCLD=FLOAT(NYCLDTBL) -.01E0
C
C          CONSTANTS TO GET VAPOR PRESSURE FROM SPECIFIC HUMIDITY.
      CEPS=ZEPS
      C2=CEPS/(1.E0-CEPS)
      C3=100.E0/(1.E0-CEPS)
C
C          ENSURE THAT VALUES OF THETAE FROM THETATBL ARE WITHIN
C          THE RANGE ALLOWED FOR TCLDTBL AND QCLDTBL.
      LEN=NXTHETBL*NYTHETBL
      C1=ZTHE1 + .01E0
CMIC$ DO ALL VECTOR SHARED(C1, THETATBL) PRIVATE(IQ2W6E)
      DO 88920 IQ2W6E = 1, 410
         IF (THETATBL(IQ2W6E,1) .LT. C1) THETATBL(IQ2W6E,1) = C1
88920 CONTINUE
      C1=ZTHE2-.01E0
CMIC$ DO ALL VECTOR SHARED(C1, C2ITFM, C1ITFM, THETATBL) PRIVATE(IQ2W6E)
      DO 88930 IQ2W6E = 1, 410
         IF (THETATBL(IQ2W6E,1) .GE. C1) THETATBL(IQ2W6E,1) = C1
         THETATBL(IQ2W6E,1) = C2ITFM*THETATBL(IQ2W6E,1)
         THETATBL(IQ2W6E,1) = C1ITFM + THETATBL(IQ2W6E,1)
88930 CONTINUE
C
C
C********************   ENTRANCE TO COMPUTE TCLD AND QCLD.  *******
C
  500 CONTINUE
C
C          FIRST MAKE SURE THAT THE BIT VECTOR  BOY  IS LARGE ENUF.
      NNBOY=NBOY
      IF( N .LE. NNBOY ) GO TO 502
C          IT ISNT LONG ENOUGH.
      WRITE (IOUTUPRT, 501) NNBOY,N
  501 FORMAT(1H1,2X,'***** BIT VECTOR BOY IN SR MSTADB WITH LENGTH',
     1 I8,', IS LESS THAN ARRAY LENGTH N=',I10)
C
C
      CALL EXIT(16)
C
  502 CONTINUE
C
C          ADDRESSES FOR ENTRY INTO TCLDTBL WILL BE PUT IN JTBL(I,1).
C          X-INCREMENTS FOR THETAE ARGUMENT IN USING TABLE TCLDTBL
C          WILL BE PUT INTO DY(I,1). (IT WILL ALSO BE USED TEMPORARILY
C          IN COMPUTING THETAE.)
C
C          FIRST ZERO THE BUOYANCY ARRAY KBUOY AND COPY TENV AND
C          QENV INTO TCLD AND QCLD
C
C          COEFFICIENT FOR PARCEL INITIAL SPEC. HUMIDITY.
C          THE CODE IS CURRENTLY CHANGED TO NOT INCLUDE THE
C          EFFECT OF SATDEL IN DETERMINING THIS SPECIFIC HUMIDITY.
      CSATDEL= 1.E0
C
      IAD=1-N
CMIC$ DO ALL SHARED(KTOP, IAD, N, KBUOY, TENV, TCLD, QENV, QCLD)
CMIC$1    PRIVATE(K, IQ2W6E)
      DO 505 K = 1, KTOP
         KBUOY(K) = 0
         DO 77068 IQ2W6E = 1, N
            TCLD(IAD+IQ2W6E-1+K*N) = TENV(IAD+IQ2W6E-1+K*N)
            QCLD(IAD+IQ2W6E-1+K*N) = QENV(IAD+IQ2W6E-1+K*N)
77068    CONTINUE
  505 CONTINUE
C
C          GET J-PART OF TCLDTBL TABLE ADDRESSES AND FRACTIONAL
C          PARTS OF Y-INCREMENTS INTO JTBL(I,K) AND DY(I,K) FOR
C          THE K-LEVELS K=2,KTOP.
      IADJ=1
CMIC$ DO ALL SHARED(KTOP, C2JTFM, IADJ, N, C1JTFM, ENDJTCLD, PR, HKAPPA
CMIC$1   , JTBL, DY) PRIVATE(K, C2JTFMK, IQ2W6E, SC2, SC3)
      DO 510 K = 1, KTOP
         C2JTFMK = C2JTFM*PR(K)
C              COMPLETE THE MULTIPLICATION BY PI.
         DO 77069 IQ2W6E = 1, N
            SC2=AMIN1(AMAX1(C2JTFMK*HKAPPA(IQ2W6E)+C1JTFM,1.),ENDJTCLD)
            SC3 = AINT(SC2)
            JTBL(IQ2W6E,K) = INT(SC3)*41
C          THE FRACTIONAL Y INCREMENT
            DY(IQ2W6E,K) = SC2 - SC3
77069    CONTINUE
  510 CONTINUE
C
C          ENTER THE LOOP L FOR THE PARCEL ORIGIN LAYER.
      DO 580 L=L1,L2
C          INITIAL ADDRESS FOR LAYER L
      IADL=(L-1)*N+1
C          WILL USE DESCRIPTORS  TLD  AND  QLD FOR
C          TENV AND QENV AT LEVEL L.
C
      C1=C3*PRESS(L)
C          GET VAPOR PRESSURE FROM Q OF LAYER L
CMIC$ DO ALL VECTOR SHARED(N, CSATDEL, IADL, C1, C2, QENV, H, SC)
CMIC$1    PRIVATE(IQ2W6E, SC4)
      DO 89080 IQ2W6E=1,N
         SC4=CSATDEL*QENV(IADL+IQ2W6E-1)
         SC(IQ2W6E,1)=(C1*H(IQ2W6E)*SC4)/  (C2+SC4)
C          THE VAPOR PRESSURE IN CBS.
89080 CONTINUE
C          GET DEWPOINT INTO ARRAY SC(I,2)
C
      CALL DEWPOINT(SC(1,1),SC(1,2),N)
C
C          DEWPOINT DEPRESSION INTO SC(I,1)
      C4 = 2.0E0 * PR(L)
      C2ITHEK = C2ITHE / C4
CMIC$ PARALLEL SHARED(N, ISCR, THETATBL, SC, IADL, CLCL3, CLCL4, CLCL2, 
CMIC$1   CLCL1, C4, C2ITHEK, C1ITHE, ENDITHET, C2JTHE, C1JTHE, ENDJTHET
CMIC$2   , TENV, HKAPPA, BCOLD, BOY, KTOP, JTBL) PRIVATE(I1X, I2X, 
CMIC$3   IQ2W6E)
CMIC$ DO PARALLEL VECTOR
      DO 89120 IQ2W6E=1,N
         SC(IQ2W6E,1)=TENV(IADL+IQ2W6E-1)-SC(IQ2W6E,2)
C          PUT LIFTING CONDENSATION LEVEL TEMPERATURE
C          MULTIPLIED BY C4 INTO SC(I,1).
         SC(IQ2W6E,3)=CLCL3+CLCL4*TENV(IADL+IQ2W6E-1)
         SC(IQ2W6E,3)=SC(IQ2W6E,1)*SC(IQ2W6E,3)
         SC(IQ2W6E,3)=SC(IQ2W6E,3)+CLCL2*TENV(IADL+IQ2W6E-1)
         SC(IQ2W6E,3)=SC(IQ2W6E,1)*(CLCL1+SC(IQ2W6E,3))
         SC(IQ2W6E,1)=(TENV(IADL+IQ2W6E-1)-SC(IQ2W6E,3))*C4
C          GET PI(=P**KAPPA) OF THE LCL INTO SC(I,2)
         SC(IQ2W6E,3)=SC(IQ2W6E,1)*HKAPPA(IQ2W6E)
         SC(IQ2W6E,2)=SC(IQ2W6E,3)/TENV(IADL+IQ2W6E-1)
C          USE TEMP TIMES C4 AND PI AT LCL TO GET EQUIV. POT. TEMP
         SC(IQ2W6E,3)=C2ITHEK*SC(IQ2W6E,1)
         SC(IQ2W6E,3)=C1ITHE+SC(IQ2W6E,3)
         BCOLD(IQ2W6E)=SC(IQ2W6E,3).LT.1.E0
         IF ( BCOLD(IQ2W6E)) THEN
             SC(IQ2W6E,3)=1.E0
         END IF
C          (BCOLDD WILL ALSO BE USED LATER TO IGNORE THESE POINTS
C          EVEN IF THEY HAVE BUOYANCY, BECAUSE THIS BUOYANCY
C          MAY BE ARTIFICIAL.)
C
         BOY(IQ2W6E)=SC(IQ2W6E,3).GE.ENDITHET
         IF ( BOY(IQ2W6E)) THEN
            SC(IQ2W6E,3)=ENDITHET
         END IF
C          TRUNCATE TO WHOLE NUMBERS
         SC(IQ2W6E,1)= AINT ( SC(IQ2W6E,3) )
C          INTEGER I VALUES FOR TABLE ENTRIES.
         ISCR(IQ2W6E)=INT ( SC(IQ2W6E,1) )
C          THE FRACTIONAL I-PARTS( DX ) INTO SC(I,1)
         SC(IQ2W6E,1)=SC(IQ2W6E,3)-SC(IQ2W6E,1)
C         DO THE SAME FOR THE SECOND DIMENSION FOR TABLE THETAE.
         SC(IQ2W6E,3)=C2JTHE*SC(IQ2W6E,2)
         SC(IQ2W6E,3)=C1JTHE+SC(IQ2W6E,3)
         BOY(IQ2W6E)=SC(IQ2W6E,3).LT.1.E0
         IF ( BOY(IQ2W6E)) THEN	
            SC(IQ2W6E,3)=1.E0
         END IF
         BOY(IQ2W6E)=SC(IQ2W6E,3).GE.ENDJTHET
         IF ( BOY(IQ2W6E)) THEN
            SC(IQ2W6E,3)=ENDJTHET
         END IF
C          TRUNCATE TO WHOLE NUMBERS
         SC(IQ2W6E,2)= AINT ( SC(IQ2W6E,3) )
C          J INTEGERS INTO JTBL(I,1)
         JTBL(IQ2W6E,1)= INT (SC(IQ2W6E,2)  )
C          THE J FRACTION PART INTO SC(I,2)
         SC(IQ2W6E,2)=SC(IQ2W6E,3)-SC(IQ2W6E,2)
C
C          COMPUTE THETAE (ACTUALLY THE I-VALUE FOR ENTRY INTO
C          TABLE  TCLDTBL  ) FOR THIS L-LEVEL.
C
C          TABLE ADDRESSES PLUS NXTHETBL INTO ID=ISCR(I,1).
         ISCR(IQ2W6E)=ISCR(IQ2W6E)+NXTHETBL*JTBL(IQ2W6E,1)
89120 CONTINUE
C          GATHER THE LOWER LEFT AND UPPER LEFT TABLE VALUES INTO
C          SC(I,3) AND SC(I,4)
C*****  Code Expanded From Routine:  RDHGATHR
CMIC$ DO PARALLEL VECTOR
      DO 77055 I1X = 1, N
         SC(I1X,3) = THETATBL(ISCR(I1X)-41,1)
         SC(I1X,4) = THETATBL(ISCR(I1X),1)
77055 CONTINUE
CMIC$ END PARALLEL
C*****  End of Code Expanded From Routine:  RDHGATHR
CMIC$ PARALLEL SHARED(N, ISCR, THETATBL, SC, KTOP, DY) PRIVATE(I3X, I4X
CMIC$1   , IQ2W6E)
CMIC$ DO PARALLEL VECTOR
      DO 89390 IQ2W6E=1,N
         SC(IQ2W6E,3)=(1.E0-SC(IQ2W6E,2))*SC(IQ2W6E,3)
         SC(IQ2W6E,4)=SC(IQ2W6E,2)*SC(IQ2W6E,4)
         SC(IQ2W6E,3)=SC(IQ2W6E,3)+SC(IQ2W6E,4)
         DY(IQ2W6E,1)=(1.E0-SC(IQ2W6E,1))*SC(IQ2W6E,3)
89390 CONTINUE
C          GATHER UPPER RIGHT AND LOWER RIGHT TABLE VALUES INTO
C          SC(I,4) AND SC(I,3)
C*****  Code Expanded From Routine:  RDHGATHR
CMIC$ DO PARALLEL VECTOR
      DO 77057 I3X = 1, N
         SC(I3X,4) = THETATBL(ISCR(I3X)+1,1)
         SC(I3X,3) = THETATBL(ISCR(I3X)-40,1)
77057 CONTINUE
CMIC$ END PARALLEL
C*****  End of Code Expanded From Routine:  RDHGATHR
C          FINISH THE INTERPOLATION, PUTTING THE I-VALUE IN SC(I,1)
CMIC$ DO ALL VECTOR SHARED(N, SC, KTOP, DY, ISCR) PRIVATE(IQ2W6E)
      DO 89430 IQ2W6E=1,N
         SC(IQ2W6E,3)=(1.E0-SC(IQ2W6E,2))*SC(IQ2W6E,3)
         SC(IQ2W6E,4)=SC(IQ2W6E,2)*SC(IQ2W6E,4)
         SC(IQ2W6E,2)=SC(IQ2W6E,3)+SC(IQ2W6E,4)
         SC(IQ2W6E,2)=SC(IQ2W6E,2)*SC(IQ2W6E,1)
         SC(IQ2W6E,1)=SC(IQ2W6E,2)+DY(IQ2W6E,1)
C          GET THE I INTEGERS AND THE DX VALUES FOR
C          ENTRY INTO THE TABLES TCLDTBL AND QCLDTBL.
         SC(IQ2W6E,2)=AINT ( SC(IQ2W6E,1)  )
C          PUT I-INTEGERS FOR TCLDTBL TABLE INTO ISCR(I,1).
         ISCR(IQ2W6E)= INT ( SC(IQ2W6E,2)  )
C          FRACTIONAL PARTS( DX ) INTO DY(I,1)
         DY(IQ2W6E,1)=SC(IQ2W6E,1)-SC(IQ2W6E,2)
89430 CONTINUE
C
C          WE ARE ALMOST READY TO ENTER THE LOOP ON K
C          AS THE PARCELS 'ASCEND' INTO THE ATMOSPHERE.
C          IN ADDITION TO THE J INTEGER AND DY FOR THE
C          SECOND ARGUMENT OF TABLE TCLDTBL THAT WAS DONE
C          BEFORE THE L-LOOP, WE HAVE NOW ARRANGED IT SO THAT
C
C          ID CONTAINS THE I-INTEGER TO ENTER TABLE TCLDTBL,
C          AND XD CONTAINS THE DX VALUES FOR TCLDTBL.
C          (SINCE THESE DEPEND ONLY ON THETAE, THEY DO NOT
C          CHANGE DURING THE FOLLOWING K-LOOP.)
C
C          KSOMEPT WILL BE 0 UNTIL BUOYANCY IS ACHIEVED AT SOME LEVEL
      KSOMEPT=0
C          KONCE WILL BE ZERO UNTIL, AFTER KSOMEPT=1, A LEVEL IS
C          REACHED THAT HAS NO BUOYANT POINTS.
      KONCE=0
C
C
C          ENTER LOOP ON THE K-LEVELS THRU WHICH THE CLOUD PARCELS
C          ARE ASCENDING.
C
        DO 570 K = L   ,KTOP
        IAD=1+(K-1)*N
C          COMPUTE FULL ADDRESS FOR TABLE TCLDTBL, PUT IN JTBL(I,1).
CMIC$ PARALLEL SHARED(N, KTOP, JTBL, TCLDTBL, SC, K, ISCR) PRIVATE(I5X, 
CMIC$1   I6X, IQ2W6E)
CMIC$ DO PARALLEL VECTOR
      DO 89510 IQ2W6E=1,N
         JTBL(IQ2W6E,1)=ISCR(IQ2W6E)+JTBL(IQ2W6E,K)-NXCLDTBL
89510 CONTINUE
C
C          USE DESCRIPTOR  YD  FOR THE Y FRACTIONAL PARTS THAT
C          WILL BE USED IN GETTING VALUES FROM TABLES TCLDTBL AND
C          QCLDTBL.
C
C          COMPUTE CLOUD TEMPERATURE
C          UPPER LEFT AND LOWER LEFT VALUES INTO SC(I,4) AND SC(I,3)
C*****  Code Expanded From Routine:  RDHGATHR
CMIC$ DO PARALLEL VECTOR
      DO 77059 I5X = 1, N
         SC(I5X,4) = TCLDTBL(JTBL(I5X,1)+41,1)
         SC(I5X,3) = TCLDTBL(JTBL(I5X,1),1)
77059 CONTINUE
CMIC$ END PARALLEL
C*****  End of Code Expanded From Routine:  RDHGATHR
CMIC$ PARALLEL SHARED(N, KTOP, JTBL, TCLDTBL, SC, K, DY) PRIVATE(I7X, 
CMIC$1   I8X, IQ2W6E)
CMIC$ DO PARALLEL VECTOR
      DO 89520 IQ2W6E=1,N
         SC(IQ2W6E,3)=(1.E0-DY(IQ2W6E,K))*SC(IQ2W6E,3)
         SC(IQ2W6E,4)=DY(IQ2W6E,K)*SC(IQ2W6E,4)
         SC(IQ2W6E,3)=SC(IQ2W6E,3)+SC(IQ2W6E,4)
         SC(IQ2W6E,2)=(1.E0-DY(IQ2W6E,1))*SC(IQ2W6E,3)
89520 CONTINUE
C          GATHER THE UPPER RIGHT AND LOWER RIGHT TABLE VALUES
C          INTO SC(I,4) AND SC(I,3)
C*****  Code Expanded From Routine:  RDHGATHR
CMIC$ DO PARALLEL VECTOR
      DO 77061 I7X = 1, N
         SC(I7X,4) = TCLDTBL(JTBL(I7X,1)+42,1)
         SC(I7X,3) = TCLDTBL(JTBL(I7X,1)+1,1)
77061 CONTINUE
CMIC$ END PARALLEL
C*****  End of Code Expanded From Routine:  RDHGATHR
C          FINISH THE INTERPOLATION PROCESS.
CMIC$ DO ALL VECTOR SHARED(N, K, IAD, SC, KTOP, DY, TCLD, BOY, BCOLD)
CMIC$1    PRIVATE(IQ2W6E)
      DO 89560 IQ2W6E=1,N
         SC(IQ2W6E,4)=SC(IQ2W6E,4)*DY(IQ2W6E,K)
         SC(IQ2W6E,3)=(1.E0-DY(IQ2W6E,K))*SC(IQ2W6E,3)
         SC(IQ2W6E,3)=SC(IQ2W6E,3)+SC(IQ2W6E,4)
         SC(IQ2W6E,3)=SC(IQ2W6E,3)*DY(IQ2W6E,1)
C          TEMP FROM TCLDTBL FOR LEVEL K INTO SC(I,2)
         SC(IQ2W6E,2)=SC(IQ2W6E,2)+SC(IQ2W6E,3)
C
C          SET THE BIT VECTOR  BOY  =1 WHERE BUOYANCY EXISTS.
         BOY(IQ2W6E)=SC(IQ2W6E,2).GT.TCLD(IAD+IQ2W6E-1)
C
C          FURTHER RESTRICT THESE POINTS TO THOSE WHICH WERE NOT
C          TOO COLD AT THE LIFTING CONDENSATION LEVEL.
C
         BOY(IQ2W6E)=BOY(IQ2W6E).AND.(.NOT.BCOLD(IQ2W6E))
89560 CONTINUE
C
C          HOW MANY POINTS HAD BUOYANCY,,,,,
        ICOUNT = 0
        DO 3001 IQ2W6E = 1, N
           IF ( BOY(IQ2W6E) ) ICOUNT = ICOUNT + 1
3001    CONTINUE
C          MAKE THE SUBSTITUTIONS IF BUOYANCY EXISTS.
        IF( ICOUNT .GT. 0 ) GO TO 560
C
C          NO POINTS WITH BUOYANCY,,IF THIS WAS TRUE FOR ALL PREVIOUS
C          K-LEVELS GO TO THE NEXT K-LEVEL.
        IF( KSOMEPT .EQ. 0 ) GO TO 570
C
C          ICOUNT IS ZERO, AND KSOMEPT IS ONE.  IF THIS IS NOT THE
C          FIRST TIME FOR THIS VALUE OF L, GO TO THE THE NEXT L VALUE.
        IF( KONCE .EQ. 1 ) GO TO 580
C
C       THIS IS THE FIRST TIME AFTER KSOMEPT BECAME 1 THAT ICOUNT
C       WAS ZERO FOR THIS L-VALUE.
C       SEE IF THIS HAPPENS ON THE NEXT K-LEVEL
C
        KONCE=1
        GO TO 570
C
C          HAVE POINTS WITH POSITIVE BUOYANCY.
  560   KSOMEPT=1
        KBUOY(K)=KBUOY(K) + ICOUNT
C
CMIC$ PARALLEL SHARED(N, KTOP, JTBL, QCLDTBL, SC, IAD, BOY, TCLD)
CMIC$1    PRIVATE(I9X, I10X, IQ2W6E)
CMIC$ DO PARALLEL VECTOR
      DO 89630 IQ2W6E=1,N
         IF ( BOY(IQ2W6E) ) THEN
            TCLD(IAD+IQ2W6E-1)=SC(IQ2W6E,2)
         END IF
89630 CONTINUE
C
C          GET THE CLOUD SPECIFIC HUMIDITIES INTO QCLD
C          UPPER LEFT AND LOWER LEFT VALUES INTO SC(I,4) AND SC(I,3)
C*****  Code Expanded From Routine:  RDHGATHR
CMIC$ DO PARALLEL VECTOR
      DO 77063 I9X = 1, N
         SC(I9X,4) = QCLDTBL(JTBL(I9X,1)+41,1)
         SC(I9X,3) = QCLDTBL(JTBL(I9X,1),1)
77063 CONTINUE
CMIC$ END PARALLEL
C*****  End of Code Expanded From Routine:  RDHGATHR
CMIC$ PARALLEL SHARED(N, KTOP, JTBL, QCLDTBL, SC, K, DY) PRIVATE(I11X, 
CMIC$1   I12X, IQ2W6E)
CMIC$ DO PARALLEL VECTOR
      DO 89640 IQ2W6E=1,N
         SC(IQ2W6E,3)=(1.E0-DY(IQ2W6E,K))*SC(IQ2W6E,3)
         SC(IQ2W6E,4)=DY(IQ2W6E,K)*SC(IQ2W6E,4)
         SC(IQ2W6E,3)=SC(IQ2W6E,3)+SC(IQ2W6E,4)
         SC(IQ2W6E,2)=(1.E0-DY(IQ2W6E,1))*SC(IQ2W6E,3)
89640 CONTINUE
C          GATHER THE UPPER RIGHT AND LOWER RIGHT TABLE VALUES
C          INTO SC(I,4) AND SC(I,3)
C*****  Code Expanded From Routine:  RDHGATHR
CMIC$ DO PARALLEL VECTOR
      DO 77065 I11X = 1, N
         SC(I11X,4) = QCLDTBL(JTBL(I11X,1)+42,1)
         SC(I11X,3) = QCLDTBL(JTBL(I11X,1)+1,1)
77065 CONTINUE
CMIC$ END PARALLEL
C*****  End of Code Expanded From Routine:  RDHGATHR
C          FINISH THE INTERPOLATION FOR QCLD.
CMIC$ DO ALL VECTOR SHARED(N, K, IAD, SC, KTOP, DY, QCLD, BCOLD)
CMIC$1    PRIVATE(IQ2W6E)
      DO 89680 IQ2W6E=1,N
         SC(IQ2W6E,4)=SC(IQ2W6E,4)*DY(IQ2W6E,K)
         SC(IQ2W6E,3)=(1.E0-DY(IQ2W6E,K))*SC(IQ2W6E,3)
         SC(IQ2W6E,3)=SC(IQ2W6E,3)+SC(IQ2W6E,4)
         SC(IQ2W6E,3)=SC(IQ2W6E,3)*DY(IQ2W6E,1)
C          CLOUD Q FROM QCLDTBL FOR LEVEL K INTO SC(I,2)
         SC(IQ2W6E,2)=SC(IQ2W6E,2)+SC(IQ2W6E,3)
C
         IF ( (SC(IQ2W6E,2).GT.QCLD(IAD+IQ2W6E-1)) .AND.
     *        (.NOT. BCOLD(IQ2W6E) ) ) THEN
             QCLD(IAD+IQ2W6E-1)=SC(IQ2W6E,2)
         END IF
89680 CONTINUE
C
C          END OF THE K-LAYER LOOP
  570   CONTINUE
C
C          DONE WITH THE CLOUD PARCELS THAT BEGAN IN LAYER L.
C
  580 CONTINUE
C
C          WE ARE DONE WITH ALL CLOUDS
C
      RETURN
      END
