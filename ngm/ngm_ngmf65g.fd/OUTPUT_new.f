       SUBROUTINE OUTPUT
CFPP$ NOCONCUR R
C
C$$$  SUBPROGRAM DOCUMENTATION BLOCK
C
C SUBPROGRAM:    OUTPUT      COMPUTE OUTPUT ARRAYS
C   PRGMMR: N PHILLIPS       ORG: W/NMC22    DATE: 83-11-01
C
C ABSTRACT: THIS PROGRAM DOES THE FOLLOWING TASKS IN SEQUENCE.
C   1. DETERMINES THE CHARACTER OF THE OUTPUT GRID FROM INFORMATION
C   .  IN  LABELLED COMMON /COMOUT/,
C   2. INITIALIZES NORMAL VALUES OF 7 OFFICE NOTE 84 LABEL NUMBERS
C   .  THAT SELDOM CHANGE,
C   3. ESTABLISHES WHETHER AIRCRAFT DATA ( I.E. FREEZING LEVEL,
C   .  FD LEVEL WINDS AND TEMPS, OR TROPOPAUSE FIELDS) ARE NEEDED.
C   4. CALLS  OUTPREP   TO ALLOCATE STORAGE SPACE AND SET UP
C   .  INTERPOLATION MACHINERY,
C   5. PRODUCE OUTPUT ARRAYS FOR THE PACKER CODE (WITH UPDATED
C   .  O.N.84 LABEL INFORMATION),AS DIRECTED BY 'OUTPUT DATA CARDS',
C   .  EITHER DIRECTLY, OR BY CALLING SPECIALIZED SUBROUTINES.
C   6. ACCUMULATES DATA FOR TIME SECTIONS AT SIX LOCATIONS ON
C   .  GRID NGRDUSE, AND PRINTS THESE ON THE 9TH CALL TO
C   .  KGTYPE = NGDSPEC
C   .
C   .        SOME OTHER DIAGNOSTIC PRINTS ARE MADE
C   .                 AS FRINGE BENEFITS
C   .
C
C PROGRAM HISTORY LOG:
C   83-11-01  N PHILLIPS
C   84-04-01  N PHILLIPS   COMPLETED ORIGINAL IMPLEMENTATION
C   85-08-01  N PHILLIPS   ADD OPTION FOR OLD REL HUM LABEL
C                          AND CHG SATDEL FROM .05 TO .10
C   85-11-01  N PHILLIPS   CHG SATDEL BACK TO 0.05 AND DEFINE
C                          NEW ROSTER OF 6 STNS FOR TIME SXNS.
C   85-11-15  N PHILLIPS   THE TEMPORARY STORAGE OF VALUES OF Q IN
C                          THE HQ LOCATIONS OF ARRAY VBL WAS REMOVED
C                          SO THAT CALLING THIS SUBROUTINE WOULD NO
C                          LONGER CHANGE THE FORECAST.
C   85-12-01  N PHILLIPS   ENFORCE AN UPPER LIMIT TO RELATIVE HUMIDITY
C   86-03-01  N PHILLIPS   ADD CALL TO OUTPHYS
C                          ADD OUTPUT OF WINDS AT PROFILER SITES
C                          REMOVE AD-HOC SPECIFICATION OF SATDEL, SINCE
C                          SATDEL IS NOW READ INTO COMCONST BY MAIN
C                          CODE. (CHANGED CALL TO OUTLIFT)
C   86-04-01  N PHILLIPS   REMOVE THE DIVISION BY ZERO POSSIBILITY IN
C                          THE DETERMINATION OF WIND DIRECTION FOR THE
C                          TIME-HEIGHT CROSS-SECTION PRINT.
C   86-06-01  N PHILLIPS   ADD ANEM WINDS TO TIME CROSS-SECTIONS
C   86-06-15  N PHILLIPS   REVISED LABELS FOR MSL PRESS ADJMNT,
C                          GRND TEMP, SOIL TEMP COEFF.  ADD OUTPUT OF
C                          ACCUMULATED EVAPORATION.
C   86-08-01  N PHILLIPS   ADD OUTPUT OF GRIDDED ANEMOMETER WINDS
C   86-10-01  N PHILLIPS   ADD OUTPUT OF SNOW COVER
C   87-01-15  N PHILLIPS   ADD LOWER LIMIT RELHMIN TO RELATIVE
C                          HUMIDITY.  THIS WAS DONE TO REMOVE FROM THE
C                          POSTPROCESSED FIELDS THE NEGATIVE RELATIVE
C                          HUMIDITIES PRODUCED BY THE SMOOTHING.
C   87-02-01  N PHILLIPS   GET ALL TIME SXN DATA FROM FINEST GRID
C                          IN VBL AND PHYSDIAG.
C                          REPLACE SPEC OUTPUT TEST ON KGTYPE = 100 BY
C                          KGTYPE = NGDSPEC
C   87-08-01  N PHILLIPS   FOR GRID TYPE 101, AMOUNTS LESS THAN .01
C                          INCH ARE NOT SET TO -.01 INCH.
C   87-09-01  N PHILLIPS   CANCEL OUTPUT OF DATA AT THE FOUR PROFILER
C                          SITES( ALSO CANCELLED IN CRDOUT )
C   87-10-01  N PHILLIPS   RESTRUCTURED VBL
C   87-12-01  N PHILLIPS   ADD OUTPUT OF MOISTURE CONVERGENCE
C   88-02-01  N PHILLIPS   ADD CALL TO GR WAVE DRAG OUTPUT (INACTIVE)
C   88-03-01  M PECNICK    REVISED LOCATIONS FOR 6-HRLY COLUMN OUTPUT
C                          FROM GRID TO LAT-LON COORDINATES
C
C USAGE:    CALL OUTPUT
C   INPUT FILES:
C     VBL      - THE BASIC SET OF NGM VARIABLES (FROM COMMON)
C                ALSO SEE COMMENTS IN REMARKS SECTION
C
C   OUTPUT FILES:
C     OUTNULAB - SUBROUTINE THROUGH WHICH MUCH OUTPUT OCCURS
C     OUTPACK  - SUBROUTINE THROUGH WHICH MUCH OUTPUT OCCURS
C                SEE COMMENTS ON THESE SUBROUTINES IN REMARKS SECTION
C
C   SUBROUTINES CALLED:
C     UNIQUE:    - OUTABVOR  OUTPUT ABSOLUTE VORTICITY (IN NGMTEMP2)
C
C                  OUTAREA   SPECIAL AREAL WEIGHTED INTERPOLATION
C                            PROGRAM USED TO MAP PRECIPITATION
C                            FROM AN NGM GRID OF FINER RESOLUTION
C                            ONTO AN OUTPUT GRID OF COARSER RESOLU-
C                            TION. (IN NGMNET)
C
C                  OUTLIFT   OUTPUT LIFTED STABILITY INDEX (IN OUTPUT)
C
C                  OUTFDTUV  OUTPUT TEMP,U, AND V AT FD HEIGHTS
C                            (IN OUTPUT)
C
C                  OUTGRWD   OUTPUT GRAVITY WAVE STRESS AT GRND
C                            (TEMPORARILY COMMENTED OUT)  (IN OUTPUT)
C                  OUTHORIZ  HORIZONTAL INTERPOLATION FROM NGM
C                            GRIDS TO THE OUTPUT GRID (IN NGMTEMP2)
C
C                  OUTHYDRO  COMPUTE HEIGHTS OF SIGMA SFCS. THEN
C                            COMPUTE AND OUTPUT HEIGHTS OF ISOBARIC
C                            SFCS. AND PRESSURE AT SEA-LEVEL.
C                            (IN OUTPUT)
C
C                  OUTLOLA   OUTPUT LONGITUDE AND/OR LATITUDE
C                            (IN NGMTEMP2)
C
C                  OUTNULAB  UPDATE THE O.N.84 LABEL (IN NGMTEMP2)
C
C                  OUTMCONV  OUTPUT MOISTURE CONVERGENCE (IN NGMTEMP)
C
C                  OUTOMEGA  OUTPUT OMEGA AND SFC. PRESSURE
C                            TENDENCY.  (IN NGMTEMP2)
C
C                  OUTPACK   PACK THE ARRAY AND AFFIX LABEL (IN OUTPUT)
C
C                  OUTPREP   ORGANIZE SCRATCH STORAGE SPACE AND
C                            SET UP INTERPOLATION MACHINERY (IN OUTPUT)
C
C                  OUTSIG2P  OUTPUT FIELDS ON PRESSURE SFCS FROM
C                            NGM GRIDS ON SIGMA SURFACES. (IN OUTPUT)
C
C                  OUTSIGMA  OUTPUT FIELDS ON SIGMA SFCS FROM
C                            NGM GRIDS ON SIGMA SURFACES. (IN OUTPUT)
C
C                  OUTSMOO   SMOOTH FIELDS ON OUTPUT GRID AS DESIRED
C                            (IN NGMNET)
C
C                  OUTRPAUS  OUTPUT PRESSURE, TEMPERATURE, U, AND V
C                            AT THE TROPOPAUSE.  (IN OUTPUT)
C
C                  P2KAP     COMPUTE PRESSURE TO KAPPA POWER
C                            (IN NGMFCST2)
C
C                  VAPTAB    COMPUTE SATURATION VAPOR PRESSURE
C                            (IN NGMFCST2)
C     LIBRARY:
C       COMMON   - COMBLANK
C                  COMCONST
C                  COMOUT
C                  COMDIAG
C
C REMARKS:
C   THIS SUBROUTINE WILL EXECUTE ONLY AFTER THE 13 INPUT QUANTITIES
C   IN /COMOUT/, AS LISTED BELOW, HAVE BEEN GIVEN APPROPRIATE VALUES.
C
C  - THE FOLLOWING  9 NUMBERS AND 4 ARRAYS CONTROL THE OUTPUT
C      AND ARE LOCATED IN LABELLED COMMON /COMOUT/
C
C   IOUTUNIT       NUMBER OF DISK FOR PACKER CODE TO WRITE ON
C
C   KGTYPE        GRID TYPE ( O.N.84 TABLE 7 )
C
C   IMOUT         I-DIMENSION OF OUTPUT GRID
C
C   JMOUT         J-DIMENSION OF OUTPUT GRID
C
C   DNPEQOUT      NUMBER OF GRID INTERVALS BETWEEN THE NORTH POLE
C                  AND THE EQUATOR ON THE OUTPUT GRID. (THIS NEED
C                  NOT BE AN INTEGER. )
C
C   DLAMOUT       LONGITUDE EAST OF GREENWICH OF THE X-AXIS OF THE
C                 OUTPUT GRID
C
C   XIPOUT,YJPOUT  I- AND J- COORDINATES OF THE NORTH POLE ON THE
C                OUTPUT GRID
C
C   LQTYPE          ARRAY OF VARIABLE TYPES(O.N.84 TABLE 1)
C
C   LSTYPE          ARRAY OF CORRESPONDING OUTPUT SFCS(O.N.84 TABLE 1)
C
C   DESCRIPT        ARRAY OF 20 CHARACTER STRINGS THAT DESCRIBE THE
C                   OUTPUT VARIABLES
C
C   LEVELS          ARRAY  OF 1'S OR 0'S THAT TELL WHETHER A VARIABLE
C                   IS WANTED ON THIS CALL TO  OUTPUT  .
C
C   NOUTVBLS        THE NUMBER OF 'OUTPUT DATA CARDS' .
C
C -------------------------------------------------------------------
C
C   MUCH OUTPUT FROM THIS ROUTINE TAKES PLACE THROUGH CALLS
C   TO THE SUBROUTINES  OUTNULAB  AND OUTPACK
C
C   FOR OUTNULAB, THE FOLLOWING LABEL INFORMATION IS PREPARED, AND
C               PLACED IN /COMOUT/.
C
C   LABQTYPE        VARIABLE TYPE (O.N.84 TABLE 1)
C
C   LABSSUB1 AND     OUTPUT SURFACE TYPES (O.N.84 TABLE 1)
C   LABSSUB2
C
C   S1VALUE AND     VALUES OF THE OUTPUT SURFACE VARIABLE
C   S2VALUE
C
C   LABLMDIF         LABEL DIFFERENCE MARKER(O.N.84 TABLE 3 )
C
C   LABFSUB2         SECOND TIME DIFFERENCE VALUE(F2) IN O.N.84
C                    TABLE  2
C   LABTMARK         TIME MARKER(O.N.84 TABLE 2 ).
C
C   -  ON CALLS TO SR   OUTPACK   , THE FOLLOWING TYPE OF INFORMATION
C              IS SUPPLIED AS ARGUMENTS
C        CALL OUTPUT ( X, IJOUT, Y, DESCRIPT(N), LABEL84, IOUTUNIT)
C   NAMES         MEANING
C
C   X              HORIZONTAL ARRAY OF THE OUTPUT FIELD
C
C   IJOUT          THE SIZE OF THE OUTPUT GRID
C
C   Y              SCRATCH SPACE FOR PACKER CODE(SIZE IJOUT)
C
C   DESCRIPT(N)    20 CHARACTER STRING TO DESCRIBE OUTPUT
C                   (N IS THE NUMBER OF THE 'OUTPUT DATA CARD')
C
C   LABEL84        ARRAY IN COMOUT CONTAINING LABEL INFO.
C
C   IOUTUNIT       DISK UNIT NUMBER FOR PACKER TO WRITE ON.
C
C ATTRIBUTES:
C   LANGUAGE: FORTRAN
C   MACHINE:  CRAY Y-MP
C
C$$$
C
      INCLUDE 'parmodel'
C...TRANSLATED BY FPP 3.00Z36 11/09/90  15:11:35  
C...SWITCHES: OPTON=I47,OPTOFF=VAE0
C
      COMMON            SCR     (IIJMAX,  INSCR),
     1                  SCRGEOG (IIJMAX,  INSCRGEO),
     2                  SCR3    (IIJKMAX, INSCR3),
     3                  FILLER  (INFILLER),
     4                  VBL     (INVBL),
     5                  BITGRDH (IIJMAX, 2, INGRDUSE),
     6                  BITGRDU (IIJMAX, 2, INGRDUSE),
     7                  BITGRDV (IIJMAX, 2, INGRDUSE),
     8                  BITSEA  (IIJMAX, INGRDUSE),
     9                  BITSNO  (IIJMAX, INGRDUSE),
     1                  BITWVL  (IIJMAX, INGRDUSE)
C
      LOGICAL BITGRDH, BITGRDU, BITGRDV, BITSEA, BITSNO, BITWVL
C
C     COMMON BLOCK /COMCONST/ CONTAINS GRID-RELATED PARAMETERS,
C          AND A FEW OTHER COMMON CONSTANTS.
      COMMON /COMCONST/ IJMAX, KM, LVLTOT, IJRAD, LOFCLDS(2,4),
     1                  ICALLRAD, IPHYSPL, NGRDUSE, NH,
     2                  NTIME, ITIME, NSTEPS,
     3                  IMG(INGRDUSE), JMG(INGRDUSE),
     4                  IAG(INGRDUS1), JAG(INGRDUS1),
     5                  IBG(INGRDUS1), JBG(INGRDUS1),
     6                  IADDRG(INIADDRS, INGRDUSE),
     7                  NPTSFH(2, INGRDUSE),
     8                  KUMULUS, LGRIDPPT, KLIFT1, KLIFT2, IBUCKET,
     9                  XPOLEH(INGRDUSE), YPOLEH(INGRDUSE), RADIUS,
     1                  DELSIG(IKM), PR(IKM), PRESS(IKM),
     2                  SIGINT(IKMP1),
     3                  DTOVDX, ANGVEL,
     4                  SIGMACC, SIGMAGSP, SIGMADHQ, CRITCONV,
     5                  SATDEL, RHFACTOR, QBOUND,
     6                  ANEM, BLKDR, CHARN, CONAUST, DDORF, PKATO,
     7                  SCALEHT, SIGDOT, DLAMNGM
C
C     COMMON BLOCK /COMOUT/ CONTAINS OUTPUT CODE PARAMETERS
C               AND ARRAYS.
C
      CHARACTER*20 DESCRIPT
C
      COMMON /COMOUT/
C
C          THE FOLLOWING ARE STORED BY OUT2FILE FROM DATA CARDS.
C          (THE LAST 6 WILL BE OVERWRITTEN BY  OUTPUT  IF KGTYPE
C          IS 5 OR 26 (I.E. AN LFM GRID DEFINED IN TABLE 7 OF
C          OFFICE NOTE 84.))
C
     1     INUNIT, IOUTUNIT, IOUTGRIB,
     2     KGTYPE, IMOUT, JMOUT, DNPEQOUT, DLAMOUT, XIPOUT, YJPOUT,
C
C          THE FOLLOWING COME FROM  MAIN  READING THE DATA CARDS.
     2   LQTYPE(IMAXOUTV),   LSTYPE(IMAXOUTV),
     3   DESCRIPT(IMAXOUTV), LEVELS(ILMOUT,IMAXOUTV),  NOUTVBLS,
C
C          THE FOLLOWING ARE DERIVED BY   OUTPUT  .
     4       IJOUT, LMOUT, NFILLER, NS2, NS3NGM, NS3OUT,
     5       COSOUT,   SINOUT,    DXOUT,    ZSIGLYR(IKM),
C
C           ARRAYS  PLOUT  AND  HTFD  ARE SET BY DATA STATEMENTS IN
C           THE SR  OUTPUT  .  'PADDER' FILLS OUT TO FULL WORD BNDRY.
     6      PLOUT(ILMOUT),   HTFD( 6),  PADDER,
C
C          THE FOLLOWING ADDRESSES AND ADDRESS ARRAYS ARE SET UP
C          BY   OUTPREP  WHEN IT IS CALLED BY   OUTPUT  .
     7  J1(INGRDUSE),          J2(INGRDUSE),   JADDK2L(INGRDUSE,2),
     8  JADDFNGM(INGRDUSE), JHREC(INGRDUSE),   JHKAP(INGRDUSE),
     9  JSCR2(12),    JSCR3NGM(INGRDUSE,12),   JSCR3OUT(12),
     A  LENGD(INGRDUSE), LTYPE(ILMOUT,INGRDUSE), MB1, MB2, MINT,
     B   MSOUT1,  MSOUT2,  MZGNDOUT,  MNGM3,  MHOUT, MZFR, MZTRO,
     C      MSZGND(INGRDUSE), NGRIDATA(INGRDUSE),
C
C            NUMGDREQ, THE NUMBER OF NGM GRIDS NEEDED TO COVER THE
C            OUTPUT GRID, AND ZLOUT, ARE SET BY  OUTPREP  .
     D                NUMGDREQ,    ZLOUT(ILMOUT),
C
C          OUTPREP ALSO ASSIGNS THE FOLLOWING DESCRIPTORS TO BE
C          USED BY  OUTHORIZ  FOR HORIZONTAL INTERPOLATION.
     E    AHORD,BHORD,CHORD,DHORD, ILLD,IULD,  SCRHORD,  OUTHORD,
C
C
C          THE FOLLOWING ARRAY CONTAINS THE INTEGERS NEEDED TO
C          FORM THE LABEL THAT GOES WITH EACH OUTPUT ARRAY.
     F               LABEL84( 27 ),
C
C          THE FOLLOWING SYMBOLS REPRESENT TEMPORARY VALUES OF
C          INTEGERS TO GO INTO  LABEL84 WHEN THE OUTPUT ARRAY
C          HAS BEEN PREPARED FOR PACKING.
C
     G  LABQTYPE, LABSSUB1, LABTMARK,  S1VALUE,  S2VALUE,
     H  LABMLDIF, LABSSUB2, LABFSUB2, LABKGRID, LABNUMPT
C
C     COMMON BLOCK /COMDIAG/ CONTAINS QUANTITIES SAVED FOR
C          DIAGNOSTIC PURPOSES.
      COMMON /COMDIAG/  KADIAB( IKM, INGRDUSE ),
     1                  NPTSDHQ (2, INGRDUSE),
     2                  KKCLOUD2(2, INGRDUSE), NPTSBUOY(2, INGRDUSE),
     3                  NPTSWATR(2, INGRDUSE), NPTSCC  (2, INGRDUSE),
     4                  KKGSP2  (2, INGRDUSE),
     5                  KKGSE2  (2, INGRDUSE),
     6                  NPTSSAT (IKM, 2, INGRDUSE),
     7                  NPTSEVAP(IKM, 2, INGRDUSE),
     8                  NPTSGSP (2, INGRDUSE), NUMPROF,
     9                  PPTCC   (2, INGRDUSE), PPTGSP  (2, INGRDUSE),
     1                  ALATPR  (IMAXPROF),    ALONPR  (IMAXPROF),
     2                  DESCRP  (IMAXPROF)
C
      COMMON/ADDRS/MIILL,MIIUL,MSA,MSB,MSC,MSD
C
      CHARACTER*24 DESCRP
C
      LOGICAL BITS
C
      CHARACTER*20 PMSL
C
      CHARACTER*1  PERCENT
C
C          NAMES AND VALUES FOR OFF. NOTE 84 LABELS.
      INTEGER I1X,I2X,I3X,I4X,I5X,I6X,I7X,I8X,I9X,stdout
      REAL COFD1,COFD2,COFD3,COFD4,COFN1,COFN2,COFN3
      PARAMETER (COFD1 = 1., COFD2 = 5.44053037, COFD3 = 2.27693825, 
     1   COFD4 = -0.0869930591, COFN1 = 0.34757549, COFN2 = 4.36732956, 
     2   COFN3 = 3.91557032)
      DATA LABHGT/1/,    LABPRES/8/,  LABTEMP/16/, LABPOT/19/,
     1     LABVVEL/40/,  LABUGRD/48/, LABVGRD/49/,
     2     LABABSV/72/,  LABRELH/88/, LABPWAT/89/,  LABTOPCP/90/,
     3     LABCOPCP/94/, LABSPFH/95/, LABMSL/128/, LABIFWS/392/,
     4     LABSFC/129/,  LABTRO/130/, LABSIG/148/,  LABGSPCP/105/,
     5     LABPADJ/8/,LABSTMP/22/,LABDIST/6/,LABSNOW/93/,
     6     LABDEPTH/7/,LABACEV/117/,LABMCV/103/
C
      DATA PMSL    /'MSL PRESS-UNADJUSTED'/
C
      DATA PERCENT /'%'/
C
C          STAGING ARRAY FOR DATA TO BE HORIZONTALLY INTERPOLATED.
      DIMENSION FNGM(INSUMG)
      DIMENSION IGATHFZ ( INSUMG )
C
C          REFERENCE SCRATCH ARRAYS TO REDEFINE SPACE IN /COMSCR/
      DIMENSION S(INSUMG),IN(INSUMG),BITS(INSUMG)
C
      EQUIVALENCE (SCR(1,1),S(1),IN(1),BITS(1),FNGM(1) )
C
C            THE FOLLOWING NUMBER DEFINES THE VALUE OF KGTYPE FOR
C                WHICH SPECIAL OUTPUTS WILL BE MADE
      DATA NGDSPEC /100/
C
C          THE FOLLOWING STMNT DEFINES THE OUTPUT PRESSURE LEVELS
C          ( THE UNITS ARE PRESSURE DIVIDED BY 1000 MBS.)
C
c     DATA PLOUT/1.E0,.95E0,.9E0,.85E0,.8E0,.75E0,.7E0,.65E0,
c    1           .6E0,.55E0,.5E0,.45E0,.4E0,.35E0,.3E0,.25E0,
c    2           .2E0,.15E0,.1E0,.05E0/
C
C         THE FOLLOWING ARE THE HEIGHTS OF THE 'FD' WINDS.
c     DATA HTFD/914.E0,1524.E0,1829.E0,2134.E0,2743.E0,3658.E0/
C         UPPER LIMIT ALLOWED FOR RELATIVE HUMIDITY (IN PER CENT)
      DATA RELHMAX /100.E0/
C         LOWER LIMIT ALLOWED FOR RELATIVE HUMIDITY (IN PER CENT)
      DATA RELHMIN /0.01E0/
C
C              SIGMA LEVELS FOR MOISTURE CONVERGENCE
      DATA SIGMC1/0.E0/ , SIGMC2 /0.15E0/
C$$$$$$$$$$$$
C
C-----------ARRAYS TO ACCUMULATE VERTICAL PROFILES AT SIX POINTS
C              FOR 9 (6-HRLY) TIMES FROM GRID C.
C            ONE ARRAY FOR ALL REAL DATA
      DIMENSION COLDATA( 864 + 216*IKM )
C
      DIMENSION TCOL(IKM,6,9),RCOL(IKM,6,9),UCOL(IKM,6,9),
     1  VCOL(IKM,6,9),ICOL(6),JCOL(6),HCOL(6,9),ISPD(9),IDIR(9),
     2  ITIMCOL(9),ISTCOL(6),PRECOL(6,9),COLSCR(9),
     3  TGDCOL(6,9), QGDCOL(6,9), AVMCOL(6,9),
     4  SWDCOL(6,9), SENCOL(6,9), EVPCOL(6,9),
     5  DLWCOL(6,9), TLWCOL(6,9), SEXCOL(6,9),
     6  CLDLO(6,9),   CLDME(6,9),  CLDHI(6,9),
     7  ULWCOL(6,9),  Q1COL(6,9)
C
      EQUIVALENCE (COLDATA(1),HCOL(1,1)), (COLDATA(55),PRECOL(1,1) ),
     1   (COLDATA(109),TGDCOL(1,1) ),  (COLDATA(163),QGDCOL(1,1) ),
     2   (COLDATA(217),AVMCOL(1,1) ),  (COLDATA(271),SWDCOL(1,1) ),
     3   (COLDATA(325),SENCOL(1,1) ),  (COLDATA(379),EVPCOL(1,1) ),
     4   (COLDATA(433),DLWCOL(1,1) ),  (COLDATA(487),TLWCOL(1,1) ),
     5   (COLDATA(541),SEXCOL(1,1) ),  (COLDATA(595),ULWCOL(1,1) ),
     6   (COLDATA(649), CLDLO(1,1) ),  (COLDATA(703), CLDME(1,1) ),
     5   (COLDATA(757), CLDHI(1,1) ),  (COLDATA(811), Q1COL(1,1) ),
     6       (COLDATA(865          ),TCOL(1,1,1) ),
     7       (COLDATA(865+ 54*IKM  ),RCOL(1,1,1) ),
     6       (COLDATA(865+108*IKM  ),UCOL(1,1,1) ),
     6       (COLDATA(865+162*IKM  ),VCOL(1,1,1) )
C
      DIMENSION
     *   IN00H(IMAXPROF),  IN00U(IMAXPROF),  IN00V(IMAXPROF),
     *  NGRIDH(IMAXPROF), NGRIDU(IMAXPROF), NGRIDV(IMAXPROF),
     *   CF00H(IMAXPROF),  CF10H(IMAXPROF),
     *   CF01H(IMAXPROF),  CF11H(IMAXPROF),
     *   CF00U(IMAXPROF),  CF10U(IMAXPROF),
     *   CF01U(IMAXPROF),  CF11U(IMAXPROF),
     *   CF00V(IMAXPROF),  CF10V(IMAXPROF),
     *   CF01V(IMAXPROF),  CF11V(IMAXPROF),
     *   XSAVE(IMAXPROF),  YSAVE(IMAXPROF)
C
CER
      INTEGER IDGRBE(25)
C
C             TIME COUNTER FOR 6-COLUMN STN PRINTOUT
      DATA IPRCOL /0/
C             SPECIFY PI.
      DATA PI /3.141592654E0/
      data stdout / 6 /
C
      PLOUT(1) = 1.E0
      PLOUT(2) = .95E0
      PLOUT(3) = .90E0
      PLOUT(4) = .85E0
      PLOUT(5) = .80E0
      PLOUT(6) = .75E0
      PLOUT(7) = .70E0
      PLOUT(8) = .65E0
      PLOUT(9) = .60E0
      PLOUT(10) = .55E0
      PLOUT(11) = .50E0
      PLOUT(12) = .45E0
      PLOUT(13) = .40E0
      PLOUT(14) = .35E0
      PLOUT(15) = .30E0
      PLOUT(16) = .25E0
      PLOUT(17) = .20E0
      PLOUT(18) = .15E0
      PLOUT(19) = .10E0
      PLOUT(20) = .05E0
C
c     DATA HTFD/914.E0,1524.E0,1829.E0,2134.E0,2743.E0,3658.E0/
      HTFD(1) = 914.E0
      HTFD(2) = 1524.E0
      HTFD(3) = 1829.E0
      HTFD(4) = 2134.E0
      HTFD(5) = 2743.E0
      HTFD(6) = 3658.E0
C
C-------------------------------------
C         PRINT THE FACT THAT WE HAVE ENTERED THE SUBROUTINE.
C          ITIME IS THE NUMBER OF SECONDS INTO THE FORECAST SINCE
C          THE INITIAL CONDITIONS
C          CONVERT TO HOURS FOR EASIER INTERPRETATION
C
      TIMEHRS = FLOAT(ITIME) / 3600.0E0
      PRINT 1899, NSTEPS, ITIME, TIMEHRS, INUNIT, KGTYPE, IOUTUNIT
C
 1899       FORMAT('0', 'FOR NSTEPS =', I5,
     1                  ', ITIME =', I8, ' S, TIMEHRS =',
     2                  F8.4, ' H AFTER I.C.:' /
     3             ' ', 4X, 'FIELDS (SPECIFIED ON UNIT', I3,
     4                  ') WITH GRID TYPE', I4,
     5                  ' WILL BE POSTPROCESSED AND WRITTEN TO DISK ',
     6                  'ON OUTPUT UNIT', I3, '.')
C
C          ESTABLISH OUTPUT GRID PARAMETERS FROM THE DATA CARD
C          THAT WAS READ INTO COMOUT BY THE MAIN PROGRAM.
C
C          KGTYPE DENOTES THE GRID TYPE.  IF THIS IS AN LFM-TYPE
C          GRID( KGTYPE=5 OR 26), WE WILL NOT USE THE CARD VALUES.
C
      IF( KGTYPE .EQ. 5 ) GO TO 2
      IF( KGTYPE .EQ. 26) GO TO 3
      GO TO 5
C
C         LFM VALUES FROM TABLE 7
    2 JMOUT=57
      GO TO 4
    3 JMOUT=45
    4 IMOUT=53
      XIPOUT=27.E0
      YJPOUT=49.E0
C          LONGITUDE OF X-AXIS OF OUTPUT GRID IN DEGREES.
C
      DLAMOUT=-15.E0
      DNPEQOUT=2.E0*RADIUS*((1.E0+.86603E0)*.5E0)/190500.E0
C
C          COMMON ENTRY FOR NGM OR LFM GRIDS
    5 IJOUT=IMOUT*JMOUT
C          ANGLE(RADS) FROM X-AXIS OF OUTPUT GRID TO
C          X-AXIS OF NGM GRIDS.
      DLAM=(DLAMNGM-DLAMOUT)*.0174532925E0
      COSOUT=COS(DLAM)
      SINOUT=SIN(DLAM)
      DXOUT=2.E0*RADIUS/DNPEQOUT
C
C   CALL LL2GR TO FIND THE INTERPOLATION COEFICIENTS FOR U,V,AND H
C   TO BE USED FOR THE 6-HRLY PROFILES
C
      IOUTUPRT = 6
      IF (NUMPROF .EQ. 0) GO TO 8999
      DO 8998 NUMPT = 1, NUMPROF
         CALL LL2GR ( ALATPR(NUMPT), ALONPR(NUMPT), 0,
     1       XSAVE(NUMPT),YSAVE(NUMPT),IN00H(NUMPT),NGRIDH(NUMPT),
     2       CF00H(NUMPT),CF10H(NUMPT),CF01H(NUMPT),CF11H(NUMPT),IERRH)
         CALL LL2GR ( ALATPR(NUMPT), ALONPR(NUMPT), 1,
     1       DUM3,DUM4,IN00U(NUMPT),NGRIDU(NUMPT),
     2       CF00U(NUMPT),CF10U(NUMPT),CF01U(NUMPT),CF11U(NUMPT),IERRU)
         CALL LL2GR ( ALATPR(NUMPT), ALONPR(NUMPT), 2,
     1       DUM5,DUM6,IN00V(NUMPT),NGRIDV(NUMPT),
     2       CF00V(NUMPT),CF10V(NUMPT),CF01V(NUMPT),CF11V(NUMPT),IERRV)
 8998 CONTINUE
 8999 CONTINUE
C
C          NUMBER OF PRESSURE SFC OUTPUT LEVELS
      LMOUT=ILMOUT
C
C          AMOUNT OF FILLER SPACE IN /COMSCR/
      NFILLER=INFILLER
C
C          THE TIME VALUE IN HRS IS TO BE PUT IN LABEL84 ARRAY
      LABEL84(3) = NINT( FLOAT( ITIME ) / 3600.E0 )
C
C          SET UP THE NORMAL VALUES FOR QUANTITIES TO BE PUT
C          INTO ARRAY LABEL84 BY THE SUBROUTINE  OUTNULAB
C
      GRAVITY = 9.8 E0
C
C
C       THE T MARKER WILL BE 3 ONLY FOR PRECIPITATION
      LABTMARK=0
C       AND NORMALLY THE TIME INTERVAL WILL BE ZERO
      LABFSUB2=0
C       FEW IF ANY VARIABLES WILL INVOLVE A SECOND SURFACE
      LABSSUB2=0
      S2VALUE=0.E0
C           THE LEVEL DIFFERENCE MARKER(TABLE 3) IS NORMALLY ZERO.
      LABMLDIF=0
C          THE GRID TYPE WILL NOT CHANGE
      LABKGRID=KGTYPE
C          NOR WILL THE NUMBER OF OUTPUT POINTS
      LABNUMPT=IJOUT
C
C----------  DO HORIZONTAL STATISTICS FOR UP TO 4 NGM GRIDS
C              EACH TIME OUTPUT GRID IS KGTYPE=NGDSPEC
C              ( MUST DO THIS WHILE ARRAY SCR IS STILL AVAILABLE)
C
C
C--------------------------------------------------------
C          COMPUT  ZSIGLYR(K) WHERE
C     Z = -LOG(P/100CBS) = -LOG( PRESS(K)*H )
C       = -LOG(PRESS(K)) -LOG(H)
C       = ZSIGLYR(K)  - LOG(H).
      DO 6 K=1,KM
      ZSIGLYR(K)=-LOG(PRESS(K) )
    6 CONTINUE
C
C          TO SAVE COMPUTATION, SEE IF CERTAIN MANDATORY OUTPUT
C          DATA IS REQUIRED.
C     IF TROPOPAUSE VBLS ARE NEEDED, MAKE ITROPDO .GT. 0.
      ITROPDO=0
      DO 9001 N=1,NOUTVBLS
      IF( LSTYPE(N) .NE. LABTRO ) GO TO 9001
      ITROPDO=ITROPDO + LEVELS(1,N)
 9001 CONTINUE
C
C     IF U,V, OR TEMP WANTED AT FD HEIGHTS, MAKE IFDDO .GT. 0
      IFDDO = 0
      DO 9004 N=1,NOUTVBLS
      IF( LSTYPE(N) .NE. LABHGT ) GO TO 9004
      IF( LQTYPE(N) .EQ. LABTEMP) GO TO 9002
      IF( LQTYPE(N) .EQ. LABUGRD) GO TO 9002
      IF( LQTYPE(N) .EQ. LABVGRD) GO TO 9002
      GO TO 9004
 9002   DO 9003 L=1,6
        IFDDO=IFDDO+LEVELS(L,N)
 9003   CONTINUE
C
 9004 CONTINUE
C
C     IF FREEZING LEVEL HGT OR REL HUM WANTED, MAKE IFRZDO .GT. 0
      IFRZDO=0
      DO 9006 N=1,NOUTVBLS
      IF( LSTYPE(N) .NE. LABTEMP ) GO TO 9006
      IF( LQTYPE(N) .EQ. LABHGT  ) GO TO 9005
      IF( LQTYPE(N) .NE. LABRELH ) GO TO 9006
 9005 IFRZDO=IFRZDO+LEVELS(1,N)
 9006 CONTINUE
C
C
C               PREPARE TO CALL OUTPREP
C*******  THE FOLLOWING THREE NUMBERS ( NS2,NS3NGM,NS3OUT) MUST NOT
C*******  EXCEED THE LITERAL DIMENSION OF 12 FOR THE DIMENSIONS IN
C*******  /COMOUT/ OF THE ADDRESS ARRAYS JSCR2,JSCR3NGM,JSCR3OUT.
C
C          NS2 = NUMBER OF HORIZONTAL SCRATCH ARRAYS OF SIZE
C                MSIZEMAX = MAX( IJMAX, OR IJOUT) TO BE SET UP.
      NS2=8
C
C          NS3NGM = NUMBER OF DESIRED  SETS  OF NUMGDREQ THREE
C                   DIMENSIONAL NGM ARRAYS (KM*IJMAX) TO BE SET UP.
C                   (NUMGDREQ, TO BE DETERMINED BY SR  OUTPREP  ,
C                   IS THE NUMBER OF THE NGM GRIDS NEEDED TO COVER
C                   THE OUTPUT GRID.)
      NS3NGM=3
C
C          NS3OUT = NUMBER OF THREE DIMENSIONAL ARRAYS (IJOUT * KM)
C          THAT ARE TO BE SET UP FOR SIGMA DATA ON OUTPUT GRID.
      NS3OUT=5
C
C          CALL SR OUTPREP NOW TO
C          A)  SET UP GATHER INTEGERS AND COEFFICIENTS FOR
C            VERTICAL AND HORIZONTAL INTERPOLATION FROM NGM GRIDS.
C
C          B)  SET UP TEMPORARY SCRATCH ARRAYS FOR THIS CODE, IN
C            THE SPACE OCCUPIED BY /COMSCR/.
C
           CALL OUTPREP
C
C     *************************************************
C
C          WE NOW HAVE THE FOLLOWING SCRATCH ARRAYS AVAILABLE
C     ( MSIZEMAX IS THE LARGER OF  IJMAX  OR  IJOUT,
C       NUMGDREQ IS THE NUMBER OF NGM GRIDS NEEDED TO COVER THE
C      THE OUTPUT GRID.)
C
C TYPE BIT:
C       BITS(MB1) AND BITS(MB2)   EACH OF LENGTH MSIZEMAX
C
C TYPE INTEGER:
C       IN(MINT)                  ONE OF LENGTH MSIZEMAX
C
C TYPE HALF PRECISION:
C       S(MSOUT1) AND S(MSOUT2)   EACH OF LENGTH IJOUT.  USED BY
C                                 SUBROUTINES  OUTHORIZ AND OUTPACK.
C
C       S(JSCR2(I),I=1,NS2)       EACH OF LENGTH MSIZEMAX
C
C       S( JSCR3NGM(I,J),         EACH OF LENGTH  KM * IJMAX
C         I=1,NUMGDREQ AND
C         J=1,NS3NGM )
C
C       S( JSCR3OUT(I),I=1,NS3OUT ) EACH OF LENGTH KM * IJOUT
C
C       S( MNGM3 )                 ONE OF LENGTH KM * IJMAX
C
C*******  IN ADDITION,,,,,,,,,
C     SR OUTPREP HAS STORED ARRAYS OF
C          Z = - LOG(PRESSURE/100 CBS) FOR THE NGM GRIDS AS FOLLOWS.
C
C          LET    NN=1,2,3,,NUMGDREQ.
C
C            THEN  NGRIDATA(NN) CONTAINS THE GRID NUMBER  NG  OF
C       THE NEEDED GRID.
C
C       J1(NG) GIVES THE LOWEST J-VALUE OF DATA NEEDED FROM GRID N G.
C       J2(NG) GIVES THE LARGEST J-VALUE OF DATA NEEDED FROM GRID NG.
C       LENGD(NG) = IMG(NG) *(J2(NG)-J1(NG)+1) IS THE SIZE OF THE
C           HORIZONTAL ARRAYS OF DATA NEEDED FROM GRID NG.
C
C     VALUES OF Z AT THE GROUND(I.E. - LOG(H) ) ARE STORED IN
C     S( MSZGND( NGRIDATA(NN) ) ) FOR NN=1,NUMGDREQ
C                EACH ARRAY BEING OF LENGTH LENGD(NGRIDATA(NN) )
C     VALUES OF Z AT THE KM SIGMA LEVELS ARE STORED IN
C     S( JSCR3NGM(NN,3) ) FOR NN=1,NUMGDREQ
C
C          SR  OUTPREP  HAS ALSO ASSIGNED  NUMGDREQ  ARRAYS OF SIZE
C          IJMAX TO BE USED FOR STORAGE OF (1/H) AND (H**KAPPA)
C          FOR EACH NEEDED GRID.  THEY ARE LOCATED IN S(MS), WHERE
C          MS IS RECORDED IN
C            JHREC(NG)    AND JHKAP(NG)
C
C          AN ARRAY S(MHOUT) AND AN ARRAY S(MZGNDOUT), BOTH OF SIZE
C          IJOUT, HAVE ALSO BEEN SET ASIDE TO CONTAIN  H   AND
C          ZGND= -LOG(H) ON THE OUTPUT GRID.
C          SIMILAR ARRAYS FOR Z(=-LOG(P) ) AT THE FREEZING AND TROPO-
C          PAUSE LVLS ARE IN  S(MZFR) AND  S(MZTRO).
C
C    *********************************************************
C
      RGASD=287.05E0
      RGASV=461.5E0
      CSUBP=1005.E0
C
      CALL OUTGRWD
C
C----------------------------------------------------------
C               LATITUDE AND/OR LONGITUDE
C
           CALL OUTLOLA
C
C----------------------------------------------------------
C
C----------------------------------------------------------
C                      ICE-FREE WATER
C
      DO 60 N=1,NOUTVBLS
      NCARD=N
      IF( LQTYPE(N).EQ.LABIFWS .AND. LSTYPE(N).EQ.LABSFC) GO TO 61
   60 CONTINUE
C              NO CARD
      GO TO 63
C                FOUND CARD
   61 IF( LEVELS(1,NCARD) .LE. 0 ) GO TO 63
C               CONSTRUCT FIELD OF 100 TIMES BITSEA SPECIFICATION
      DO 62 NN=1,NUMGDREQ
      NG = NGRIDATA(NN)
      IM = IMG(NG)
      JM = JMG(NG)
      IJ = IM * JM
      IADF = JADDFNGM(NG)
      DO 88890 IQ2W6E=1,IJ
         S(IADF+IQ2W6E-1)=0.E0
88890 CONTINUE
      DO 88900 IQ2W6E=1,IJ
       IF ( BITSEA(IQ2W6E,NG) ) THEN
         S(IADF+IQ2W6E-1)=100.E0
       END IF
88900 CONTINUE
   62 CONTINUE
C
C                 INTERPOLATE TO OUTPUT GRID
            CALL OUTHORIZ(IN(MIILL),IN(MIIUL),S(MSA),S(MSB),S(MSC),
     *                    S(MSD),S(MSOUT1),S(MSOUT2))
C                 UPDATE THE LABEL
      LABQTYPE = LABIFWS
      LABSSUB1 = LABSFC
      S1VALUE = 0.E0
              CALL OUTNULAB
c     do k = 1, 27
c       print *,' output ',k,label84(k)
c     enddo
C
C  SET UP PDS INFO
C
      CALL LAB2PDS(LABEL84,IDGRBE)
      IDGRBE(7) =   0
      IDGRBE(8) = 201
      IDGRBE(9) =   1
      IDGRBE(10) =  0
      IDGRBE(11) =  0
      IDGRBE(18) =  LABEL84(3)
      IDGRBE(19) =  0
      IDGRBE(20) =  0
C     
C                     GO TO THE PACKER CODE
c     CALL OUTPACK(S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
c    1             LABEL84,IOUTUNIT )
      CALL GRIBITN (S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
     1             IDGRBE,IOUTGRIB,LABEL84 )
C
   63 CONTINUE
C
C-----------------------------------------------------------------
C
C-----------------------------------------------------------------
C          SNOW-COVER  (100 FOR SNOW,,, 0 FOR NO SNOW )
C
      DO 38 N=1,NOUTVBLS
      NCARD=N
      IF( LQTYPE(N).EQ.LABSNOW .AND. LSTYPE(N).EQ.LABSFC) GO TO 39
   38 CONTINUE
C              NO CARD,, GO TO EXIT
      GO TO 45
C                FOUND CARD
   39 IF( LEVELS(1,NCARD) .LE. 0 ) GO TO 45
C            CONSTRUCT FIELD OF 100 TIMES SNOW COVER SPECIFICATION
      DO 44 NN=1,NUMGDREQ
      NG = NGRIDATA(NN)
      IM = IMG(NG)
      JM = JMG(NG)
      IJ = IM * JM
      IADF = JADDFNGM(NG)
      DO 88910 IQ2W6E=1,IJ
         S(IADF+IQ2W6E-1)=0.E0
88910 CONTINUE
      DO 88920 IQ2W6E=1,IJ
       IF ( BITSNO(IQ2W6E,NG) ) THEN
         S(IADF+IQ2W6E-1)=100.E0
       END IF
88920 CONTINUE
   44 CONTINUE
C
C                 INTERPOLATE TO OUTPUT GRID
            CALL OUTHORIZ(IN(MIILL),IN(MIIUL),S(MSA),S(MSB),S(MSC),
     *                    S(MSD),S(MSOUT1),S(MSOUT2))
C                 UPDATE THE LABEL
      LABQTYPE = LABSNOW
      LABSSUB1 = LABSFC
      S1VALUE = 0.E0
              CALL OUTNULAB
C
C  SET UP PDS INFO
C
      CALL LAB2PDS(LABEL84,IDGRBE)
      IDGRBE(7) =   0
      IDGRBE(8) =  66
      IDGRBE(9) =   1
      IDGRBE(10) =  0
      IDGRBE(11) =  0
      IDGRBE(18) =  LABEL84(3)
      IDGRBE(19) =  0
      IDGRBE(20) =  0
C                     GO TO THE PACKER CODE
c     CALL OUTPACK(S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
c    1             LABEL84,IOUTUNIT )
      CALL GRIBITN (S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
     1             IDGRBE,IOUTGRIB,LABEL84 )
C
   45 CONTINUE
C
C-----------------------------------------------------------------
C
C-----------------------------------------------------------------
C           PRECIPITABLE WATER IN ENTIRE COLUMN
C
C          (THE DATA CARD FOR THIS HAS LQTYPE=LABPWAT(I.E.89),
C          LSTYPE=LABSIG(I.E.148),AND LEVELS(1,N)=1.
C
      DO 7 N=1,NOUTVBLS
      NCARD=N
      IF(LQTYPE(N).EQ.LABPWAT .AND. LSTYPE(N).EQ.LABSIG ) GO TO 8
    7 CONTINUE
C          NOT WANTED
      GO TO 11
C
    8 CONTINUE
C
C           CHECK FOR THE 1 IN LEVELS
      IF(LEVELS(1,NCARD) .LE. 0 ) GO TO 11
C          THE FOLLOWING COEFFICIENT HAS 1000 FOR TONS TO KILOGRAMS,
C          100 FOR SFC PRESSURE TO CENTIBARS, AND GRAVITY IN THE
C          DENOMINATOR.
      C1=1.E5/GRAVITY
C          (THIS GIVES KILOGRAMS PER SQUARE METER.)
      DO 10 NN=1,NUMGDREQ
      NG=NGRIDATA(NN)
      IM=IMG(NG)
      JM=JMG(NG)
      IJ=IM*JM
      JJ1=J1(NG)
      JADDM1=(JJ1-1)*IM
      LEN=LENGD(NG)
      IADF=JADDFNGM(NG) + JADDM1
      IADHQ=IADDRG(4,NG) + JADDM1
C
      DEL=C1*DELSIG(1)
      DO 88930 IQ2W6E=1,LEN
         FNGM(IADF+IQ2W6E-1)=DEL*VBL(IADHQ+IQ2W6E-1)
88930 CONTINUE
C
        DO 9 K=2,KM
        IADHQ=IADHQ + IJ
        DEL=C1*DELSIG(K)
      DO 88940 IQ2W6E=1,LEN
         FNGM(IADF+IQ2W6E-1)=FNGM(IADF+IQ2W6E-1)+DEL*VBL(IADHQ+IQ2W6E-
     *   1)
88940 CONTINUE
    9   CONTINUE
   10 CONTINUE
C
C          INTERPOLATE TO OUTPUT GRID
            CALL OUTHORIZ(IN(MIILL),IN(MIIUL),S(MSA),S(MSB),S(MSC),
     *                    S(MSD),S(MSOUT1),S(MSOUT2))
C
C         (OUTPUT GRID VALUES ARE NOW IN S(MSOUT2).
C
C          UPDATE THE LABEL
      LABQTYPE=LABPWAT
      LABSSUB1=LABSIG
      S1VALUE=0.E0
      LABSSUB2=LABSIG
      S2VALUE=1.E0
      LABMLDIF=2
C
        CALL OUTNULAB
C
C  SET UP PDS INFO
C
      CALL LAB2PDS(LABEL84,IDGRBE)
      IDGRBE(7) =    0
      IDGRBE(8) =   54
      IDGRBE(9) =  108
      IDGRBE(10) =   0
      IDGRBE(11) = 100
      IDGRBE(18) =   LABEL84(3)
      IDGRBE(19) =   0
      IDGRBE(20) =   0
C
C                     GO TO THE PACKER CODE
c     CALL OUTPACK(S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
c    1             LABEL84,IOUTUNIT )
      CALL GRIBITN (S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
     1             IDGRBE,IOUTGRIB,LABEL84 )

C          RESTORE PART OF LABEL NUMBERS TO USUAL VALUES.
      LABMLDIF=0
      S2VALUE=0.E0
      LABSSUB2=0
C
   11 CONTINUE
C
C---------------------------------------------------------
C
C
C--------------------------------------------------------
C              ACCUMULATED EVAPORATION
C
      DO 17 N=1,NOUTVBLS
      NCARD = N
      IF( LQTYPE(N).EQ.LABACEV) GO TO 18
   17 CONTINUE
C          NO CARD
      GO TO 37
C
   18 IF(LEVELS(1,NCARD) .NE. 1 ) GO TO 37
C
      DO 29 NN=1,NUMGDREQ
      NG=NGRIDATA(NN)
      IADF=JADDFNGM(NG)
      IM=IMG(NG)
      JM=JMG(NG)
      IJ=IM*JM
      DO 88950 IQ2W6E=1,IJ
         FNGM(IADF+IQ2W6E-1)=VBL(IADDRG(39,NG)+IQ2W6E-1)
88950 CONTINUE
   29 CONTINUE
C              INTERPOLATE TO OUTPUT GRID
            CALL OUTHORIZ(IN(MIILL),IN(MIIUL),S(MSA),S(MSB),S(MSC),
     *                    S(MSD),S(MSOUT1),S(MSOUT2))
C
      LABQTYPE=LABACEV
      LABSSUB1=LABSFC
      S1VALUE=0.E0
C            NEED T MARKER = 3, JUST AS IN PRECIP OUTPUT LABEL
      LABTMARK = 3
C
        CALL OUTNULAB
C
C  SET UP PDS INFO
C
      CALL LAB2PDS(LABEL84,IDGRBE)
      IDGRBE(7) =    0
      IDGRBE(8) =   57
      IDGRBE(9) =    1
      IDGRBE(10) =   0
      IDGRBE(11) =   0
      IDGRBE(18) =   LABEL84(3) - LABEL84(10)
      IDGRBE(19) =   LABEL84(3)
      IDGRBE(20) =   5
C
C                     GO TO THE PACKER CODE
c     CALL OUTPACK(S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
c    1             LABEL84,IOUTUNIT )
      CALL GRIBITN (S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
     1             IDGRBE,IOUTGRIB,LABEL84 )
C
C              RESTORE LABTMARK TO ZERO
      LABTMARK = 0
C
   37 CONTINUE
C------------------------------------------------------------------
C
C------------------------------------------------------------------
C             CONVECTIVE, TOTAL, AND/OR LARGE SCALE PRECIP
C
C          CHANGE THE VALUE OF F SUB 2
C          IBUCKET=TIME(SECS) INTO FCST WHEN BUCKETS WERE LAST EMPTIED
C          ITIME  =TIME (SECS) INTO THE FORECAST
C
      LABFSUB2= NINT( FLOAT(ITIME-IBUCKET) / 3600.E0 )
C
C          NEED A BIT VECTOR TO LOCATE INSIGNIFICANT PRECIP. AMTS.
C
C          FIRST THE CONVECTIVE PRECIPITATION
       LLPTYPE=LABCOPCP
      CCONV=1.E0
      CLSCL=0.E0
C
      DO 16 NAP=1,3
        DO 12 N=1,NOUTVBLS
        NCARD=N
        IF(LQTYPE(N).EQ.LLPTYPE .AND. LEVELS(1,N).EQ.1) GO TO 13
   12   CONTINUE
C
C          THIS TYPE IS UNWANTED
      GO TO 15
C
   13 CONTINUE
C
        DO 14 NN=1,NUMGDREQ
        NG=NGRIDATA(NN)
        IM=IMG(NG)
        JJ1=J1(NG)
        LEN=LENGD(NG)
        J1AD=(JJ1-1)*IM
C          ADDRESS OF CONV. PRECIP IN ARRAY VBL
        IADC=IADDRG(12,NG) + J1AD
C          ADDRESS OF LARGE-SCALE PRECIP IN ARRAY VBL
        IADL=IADDRG(13,NG) + J1AD
C          ADDRESS IN ARRAY FNGM
        IADF=JADDFNGM(NG) + J1AD
C          STORE THE DESIRED COMBINATION IN THIS PART OF FNGM.
      DO 88960 IQ2W6E=1,LEN
         FNGM(IADF+IQ2W6E-1)=CCONV*VBL(IADC+IQ2W6E-1)+CLSCL*VBL(I
     *   ADL+IQ2W6E-1)
88960 CONTINUE
C
   14   CONTINUE
C
C          INTERPOLATE TO THE OUTPUT GRID
            CALL OUTHORIZ(IN(MIILL),IN(MIIUL),S(MSA),S(MSB),S(MSC),
     *                    S(MSD),S(MSOUT1),S(MSOUT2))
C
C          ELIMINATE TRIVIAL PRECIPITATION AMOUNTS (LT .O1 INCH),
C          UNLESS THIS IS GRID TYPE 101.
C****      IF THE FOLLOWING THRESHOLD VALUES ARE CHANGED, CONTACT
C****      TDL / SYNOPTIC-SCALE TECHNIQUES BRANCH (PAUL DALLAVALLE AND
C****      JOHN JENSENIUS).  THEY MAY BE USING IT IN ONE OF THEIR
C****      PACKING CODES.
      IF (KGTYPE .NE. 101) THEN
      DO 88970 IQ2W6E=1,IJOUT
        BITS(MB1+IQ2W6E-1)=S(MSOUT2+IQ2W6E-1).LT.0.000254E0
        IF ( BITS(MB1+IQ2W6E-1) ) THEN
           S(MSOUT2+IQ2W6E-1) = -0.000254E0
        END IF
88970 CONTINUE
      END IF
C         --------------------------------
C          CONSIDER REPLACING THE INTERPOLATED VALUES NOW IN
C          S(MSOUT2) WITH AREA-WEIGHTED VALUES.
C       WE MUST HAVE THE SAME LONGITUDE ORIENTATION
      IF( ABS(DLAMOUT-DLAMNGM) .GT. 0.01E0 ) GO TO 3100
C       WE MUST HAVE FINER RESOLUTION ON AT LEAST ONE OF THE
C       NGM FORECAST GRIDS.
      DNPNGMA = FLOAT(NH) + 0.5E0
      EQPFNST = DNPNGMA * (2**(NGRDUSE-1) )
      IF( EQPFNST .LT. 1.01*DNPEQOUT ) GO TO 3100
C            IT IS WORTHWHILE TO PROCEED
C       SOME USEFUL ADDRESS CONSTANTS
C          FOR THE NGM GRID PRECIP VALUES
      LNGM=JSCR2(1)
C          OUTPUT GRID FROM SUBROUTINE OUTAREA
      LOUTA=JSCR2(2)
C          SCRATCH AREA FOR SUBROUTINE OUTAREA
      LOUTS=JSCR2(3)
C          EXAMINE ALL NGM GRIDS FOR POSSIBLE CONTRIBUTIONS
      FEQPFF=0.5E0
      DO 3010 NG=1,NGRDUSE
C          SKIP THE COARSER GRIDS
      FEQPFF= 2.E0 * FEQPFF
      EQPFF = FEQPFF * DNPNGMA
      IF( EQPFF .LT. 1.01E0*DNPEQOUT ) GO TO 3010
C          DO THIS GRID
      IMFF=IMG(NG)
      JMFF=JMG(NG)
      XPFF=XPOLEH(NG)
      YPFF=YPOLEH(NG)
C          PUT THIS NGM PRECIP FIELD INTO S( JSCR2(1) ).
      IJFF = IMFF * JMFF
      IADC = IADDRG(12,NG)
      IADL = IADDRG(13,NG)
      DO 88980 IQ2W6E=1,IJFF
         S(LNGM+IQ2W6E-1)=CCONV*VBL(IADC+IQ2W6E-1)+CLSCL*VBL(IADL
     *   +IQ2W6E-1)
88980 CONTINUE
C
      CALL OUTAREA( S(LNGM), IMFF, JMFF, XPFF, YPFF, EQPFF,
     1  IMOUT, JMOUT, XIPOUT, YJPOUT, DNPEQOUT, S(LOUTA ),
     2  S(LOUTS ), IN(MINT), II11, II22, JJ11, JJ22, IER )
C
C         CHECK THE ERROR RETURN--   1 = WRONG GRID SIZE OR ELSE
C             THAT THIS NGM GRID HAS NO AREA ON THE OUTPUT GRID.
      IF( IER .GT. 0 ) GO TO 3010
C             OKEH,,,,INSERT THE REVISED VALUES INTO S(MSOUT2)
C              THEY ARE FOR I=(II11,II22) AND J=(JJ11,JJ22).
      IADELT=-1 + II11 + (JJ11-2)*IMOUT
      IAD1 = LOUTA + IADELT
      IAD2 = MSOUT2 + IADELT
      LENP = II22 - II11 + 1
        DO 3000 J=JJ11,JJ22
        IAD1 = IAD1 + IMOUT
        IAD2 = IAD2 + IMOUT
      DO 88990 IQ2W6E=1,LENP
         S(IAD2+IQ2W6E-1)=S(IAD1+IQ2W6E-1)
88990 CONTINUE
 3000   CONTINUE
C
 3010 CONTINUE
C           AGAIN, ELIMINATE ANY TRIVIAL PRECIP AMTS.
      IF (KGTYPE .NE. 101) THEN
      DO 89000 IQ2W6E=1,IJOUT
        BITS(MB1+IQ2W6E-1)=S(MSOUT2+IQ2W6E-1).LT.0.000254E0
        IF ( BITS(MB1+IQ2W6E-1) ) THEN
           S(MSOUT2+IQ2W6E-1) = -0.000254E0
        END IF
89000 CONTINUE
      END IF
C
C          -------------------------------
C          LANDING SPOT FOR WHEN OUTAREA OPERATION IS SKIPPED
 3100 CONTINUE
C
C          UPDATE THE LABEL INFORMATION
      LABQTYPE=LLPTYPE
      LABSSUB1=LABSFC
      S1VALUE=0.E0
C          THE TIME MARKER
      LABTMARK=3
C
        CALL OUTNULAB
C
C  SET UP PDS INFO
C
      CALL LAB2PDS(LABEL84,IDGRBE)
c     do k = 1, 27
c       print *,' output precip ',k,label84(k)
c     enddo
      IDGRBE(7) =    0
      IF(NAP.EQ.1) IDGRBE(8) = 63
      IF(NAP.EQ.2) IDGRBE(8) = 61
      IF(NAP.EQ.3) IDGRBE(8) = 62
      IDGRBE(9) =    1
      IDGRBE(10) =   0
      IDGRBE(11) =   0
      IDGRBE(18) =   LABEL84(3) - LABEL84(10)
      IDGRBE(19) =   LABEL84(3)
      IDGRBE(20) =   4
C
C                     GO TO THE PACKER CODE
c     CALL OUTPACK(S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
c    1             LABEL84,IOUTUNIT )
      CALL GRIBITN (S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
     1             IDGRBE,IOUTGRIB,LABEL84 )
C
C          RESTORE THE TIME MARKER
      LABTMARK=0
C
   15 CONTINUE
C
C          PREPARE FOR TOTAL PRECIP ON SECOND PASS
C
      LLPTYPE=LABTOPCP
      CCONV=1.E0
      CLSCL=1.E0
C
C         BUT ON THE THIRD PASS WE DO THE LARGE SCALE PRECIP
      IF( NAP .LT. 2 ) GO TO 16
C
      LLPTYPE=LABGSPCP
      CCONV=0.E0
      CLSCL=1.E0
C
   16 CONTINUE
C
C           RESTORE F SUB2
      LABFSUB2 = 0
C
C--------------------------------------------------------
C***********
      KKK=ITIME/3600
C
C      SEE IF POTENTIAL TEMPERATURE IS WANTED
      NCARDTHP=0
      NCARDTHS=0
      NTHETAP=0
      NTHETAS=0
      DO 31 N=1,NOUTVBLS
      IF( LQTYPE(N) .NE. LABPOT ) GO TO 31
      IF( LSTYPE(N) .EQ. LABPRES ) NCARDTHP=N
      IF( LSTYPE(N) .EQ. LABSIG  ) NCARDTHS=N
   31 CONTINUE
C
      IF( NCARDTHP .GT. 0) THEN
          NTHETAP= 0
          DO 1007 IQ2 = 1, 20
             NTHETAP = NTHETAP + LEVELS(IQ2,NCARDTHP)
1007      CONTINUE
      END IF
      IF( NCARDTHS .GT. 0)  THEN
          NTHETAS= 0
          DO 1008 IQ2 = 1, 20
             NTHETAS = NTHETAS + LEVELS(IQ2,NCARDTHS)
1008      CONTINUE
      END IF
C
C          (WILL USE THIS INFORMATION LATER)
C
C       FOR EACH NEEDED NGM GRID--
C       PUT H INTO FNGM FOR POSSIBLE OUTPUT IN NEXT STEP,
C          PUT 1/H INTO S(JHREC) FOR USE LATER,
C          PUT TEMPERATURE INTO S( JSCR3NGM(NN,1) ),
C          AND PUT POTENTIAL TEMPERATURE INTO S( JSCR3NGM(NN,2) )
C       IF ANY POTENTIAL TEMPERATURE OUTPUT IS WANTED.
      DO 20 NN=1,NUMGDREQ
      NG=NGRIDATA(NN)
      IM=IMG(NG)
      JM=JMG(NG)
      IJ=IM*JM
      IADREC=JHREC(NG)
      IADH=IADDRG(5,NG)
C          PUT  H  INTO FNGM
      IADF=JADDFNGM(NG)
      DO 89040 IQ2W6E=1,IJ
         FNGM(IADF+IQ2W6E-1)=VBL(IADH+IQ2W6E-1)
89040 CONTINUE
C
C          1/H
      DO 89050 IQ2W6E=1,IJ
         S(IADREC+IQ2W6E-1)=1.E0/VBL(IADH+IQ2W6E-1)
89050 CONTINUE
C
C          H**KAPPA
      IADS=JSCR2(1)
      IADKAP=JHKAP(NG)
C
C*****  Code Expanded From Routine:  P2KAP
      DO 77068 I1X = 1, IJ
         S(I1X+IADKAP-1) = (0.34757549+VBL(I1X+IADH-1)*(4.36732956+VBL(
     1      I1X+IADH-1)*3.91557032))/(1.+VBL(I1X+IADH-1)*(5.44053037+VBL
     2      (I1X+IADH-1)*(2.27693825+VBL(I1X+IADH-1)*(-0.0869930591))))
77068 CONTINUE
C*****  End of Code Expanded From Routine:  P2KAP
C
C          FOR ALL GRID POINTS IN ARRAY  VBL  ,
C          PUT TEMPERATURE  INTO  S( JSCR3NGM(NN,1) ).
      IADT=IADDRG(3,NG)-IJ
      IADJ3=JSCR3NGM(NN,1)-IJ
        DO 19 K=1,KM
        IADT=IADT+IJ
        IADJ3=IADJ3 + IJ
        C1=2.E0 * PR(K)
      DO 89060 IQ2W6E=1,IJ
         S(IADS+IQ2W6E-1)=C1*S(IADREC+IQ2W6E-1)*S(IADKAP+IQ2W6E-1)
         S(IADJ3+IQ2W6E-1)=VBL(IADT+IQ2W6E-1)*S(IADS+IQ2W6E-1)
89060 CONTINUE
   19   CONTINUE
C
C             IF POT TEMP IS WANTED, PUT IT INTO S(JSCR3NGM(NN,2) )
      IF( (NTHETAP + NTHETAS) .EQ. 0 ) GO TO 33
C
C             PUT IT THERE AFTER DIVIDING OUT THE H FACTOR
      IADHTH=IADDRG(3,NG) -IJ
      IADTH=JSCR3NGM(NN,2)-IJ
        DO 32 K=1,KM
        IADHTH=IADHTH+IJ
        IADTH =IADTH +IJ
      DO 89080 IQ2W6E=1,IJ
         S(IADTH+IQ2W6E-1)=VBL(IADHTH+IQ2W6E-1)*S(IADREC+IQ2W6E-1)
89080 CONTINUE
   32   CONTINUE
C
   33 CONTINUE
C            (WE'LL USE THESE ARRAYS IN A LITTLE WHILE)
C
   20 CONTINUE
C
C          INTERPOLATE  H  (IN FNGM) TO OUTPUT GRID AND PUT IN
C          S(MHOUT).
            CALL OUTHORIZ(IN(MIILL),IN(MIIUL),S(MSA),S(MSB),S(MSC),
     *                    S(MSD),S(MSOUT1),S(MHOUT))
C
C--------------------------------------------------------
C              DATA FOR 6HRLY SIX POINT TIME SECTIONS
C--------------------------------------------------------
C
      IF (NUMPROF .EQ. 0) GO TO 28
      IF(KGTYPE .NE. NGDSPEC ) GO TO 28
C           ADVANCE AND CONTROL CROSS SECTION COUNTS
      IPRCOL = IPRCOL + 1
      IF( IPRCOL .GT. 9 ) IPRCOL = 1
C
C         LOOP ON THE NUMPROF NUMBER OF POINTS
C
      DO 27 N=1, NUMPROF
C
C        DEFINE SHORTHAND VARIABLES TO MAKE INTERPOLATION CODE
C        LESS COMPLICATED
C
         NGH  = NGRIDH(N)
         NGU  = NGRIDU(N)
         NGV  = NGRIDV(N)
C
         IMH = IMG(NGH)
         IMU = IMG(NGU)
         IMV = IMG(NGV)
C
         JMH = JMG(NGH)
         JMU = JMG(NGU)
         JMV = JMG(NGV)
C
         IJH = IMH*JMH
         IJU = IMU*JMU
         IJV = IMV*JMV
C
         C00H = CF00H(N)
         C10H = CF10H(N)
         C01H = CF01H(N)
         C11H = CF11H(N)
C
         C00U = CF00U(N)
         C10U = CF10U(N)
         C01U = CF01U(N)
         C11U = CF11U(N)
C
         C00V = CF00V(N)
         C10V = CF10V(N)
         C01V = CF01V(N)
         C11V = CF11V(N)
C
         I00H = IN00H(N)
         I10H = I00H + 1
         I01H = I00H + IMH
         I11H = I00H + IMH + 1
C
         I00U = IN00U(N)
         I10U = I00U + 1
         I01U = I00U + IMU
         I11U = I00U + IMU + 1
C
         I00V = IN00V(N)
         I10V = I00V + 1
         I01V = I00V + IMV
         I11V = I00V + IMV + 1
C
         MADH = IADDRG(1,NGH) - IJH - 1
         MADU = IADDRG(1,NGU) - IJU - 1
         MADV = IADDRG(1,NGV) - IJV - 1
C
C
C     IAD1 = IMNGC*(JCOL(N) - 1 ) + ICOL(N) - 1
C           SURFACE PRESSURE AND FUNCTIONS OF IT.
C     IAD = IADDRG(5,NGC) + IAD1
C     HHCOL = VBL(IAD)
C
      IAD = IADDRG(5,NGH) - 1
      HHCOL = VBL(IAD + I00H)*C00H +
     1        VBL(IAD + I10H)*C10H +
     2        VBL(IAD + I01H)*C01H +
     3        VBL(IAD + I11H)*C11H
C
      HCOL(N,IPRCOL) = 1000.E0 * HHCOL
      HCOLKAP = HHCOL ** (0.285622E0)
      HCOLINV = 1.E0 / HHCOL
      H22H = HCOLINV * HCOLKAP * 2.0E0
C
C            ENTER LOOP ON K TO GET TEMP, REL H, AND WINDS
C            DEFINE IADK VARIABLES TO STEP IN THE VERTICAL
C
      IADKH = - IJH
      IADKU = - IJU
      IADKV = - IJV
C
        DO 55 K = 1,KM
         IADKH = IADKH + IJH
         IADKU = IADKU + IJU
         IADKV = IADKV + IJV
C       IADK = IADK + IJNGC
C
C            TEMPERATURE
C
        IAD = IADDRG(3,NGH) - 1 + IADKH
        TTCOL =(VBL(IAD + I00H)*C00H +
     1          VBL(IAD + I10H)*C10H +
     2          VBL(IAD + I01H)*C01H +
     3          VBL(IAD + I11H)*C11H) * H22H * PR(K)
C
        TCOL(K,N,IPRCOL) = TTCOL - 273.16E0
C
C            RELATIVE HUMIDITY IN PERCENT
C
        T3OT = 273.16E0 / TTCOL
        SATP = 0.611E0 * (T3OT ** 5.0065E0 )
     1           * EXP( 24.8457E0 * (1.E0 - T3OT)  )
C
        IAD = IADDRG(4,NGH) - 1 + IADKH
        SPHUM =(VBL(IAD + I00H)*C00H +
     1          VBL(IAD + I10H)*C10H +
     2          VBL(IAD + I01H)*C01H +
     3          VBL(IAD + I11H)*C11H) * HCOLINV
C
        PRTOT = HHCOL * PRESS(K) * 100.E0
        RHNUM = 100.E0 * SPHUM * (PRTOT - SATP)
        RHDEN = ( 1.E0 - SPHUM ) * SATP * 0.621993E0
        RCOL(K,N,IPRCOL) = RHNUM / RHDEN
C
C              GRID VELOCITIES
C
        IAD = IADDRG(1,NGU) -1 + IADKU
        UUCOL = HCOLINV*((VBL(IAD+I00U)+VBL(IAD+I00U-IMU))*C00U +
     1                   (VBL(IAD+I10U)+VBL(IAD+I10U-IMU))*C10U +
     2                   (VBL(IAD+I01U)+VBL(IAD+I01U-IMU))*C01U +
     3                   (VBL(IAD+I11U)+VBL(IAD+I11U-IMU))*C11U)
        IAD = IADDRG(2,NGV) -1 + IADKV
C       VVCOL = HCOLINV*(VBL(IAD) + VBL(IAD-1) )
        VVCOL = HCOLINV*((VBL(IAD+I00V)+VBL(IAD+I00V-1))*C00V +
     1                   (VBL(IAD+I10V)+VBL(IAD+I10V-1))*C10V +
     2                   (VBL(IAD+I01V)+VBL(IAD+I01V-1))*C01V +
     3                   (VBL(IAD+I11V)+VBL(IAD+I11V-1))*C11V)
        UCOL(K,N,IPRCOL) = 0.5E0 * UUCOL
        VCOL(K,N,IPRCOL) = 0.5E0 * VVCOL
C
   55   CONTINUE
C
C                 SAVE PHYSICS OUTPUT
C
      IADNUM = IADDRG(4,NGH) - 1
      IADDEM = IADDRG(5,NGH) - 1
       Q1COL(N,IPRCOL) =
     1    (VBL(IADNUM + I00H)/VBL(IADDEM + I00H))*C00H +
     2    (VBL(IADNUM + I10H)/VBL(IADDEM + I10H))*C10H +
     3    (VBL(IADNUM + I01H)/VBL(IADDEM + I01H))*C01H +
     4    (VBL(IADNUM + I11H)/VBL(IADDEM + I11H))*C11H
C
      IAD = IADDRG(6,NGH) - 1
      TGDCOL(N,IPRCOL) = (VBL(IAD + I00H)*C00H +
     1                    VBL(IAD + I10H)*C10H +
     2                    VBL(IAD + I01H)*C01H +
     3                    VBL(IAD + I11H)*C11H) - 273.16E0
C
      IAD = IADDRG(7,NGH) - 1
      QGDCOL(N,IPRCOL) = VBL(IAD + I00H)*C00H +
     1                   VBL(IAD + I10H)*C10H +
     2                   VBL(IAD + I01H)*C01H +
     3                   VBL(IAD + I11H)*C11H
C
      IAD = IADDRG(15,NGH) - 1
      DLWCOL(N,IPRCOL) = (VBL(IAD + I00H)*C00H +
     1                    VBL(IAD + I10H)*C10H +
     2                    VBL(IAD + I01H)*C01H +
     3                    VBL(IAD + I11H)*C11H)*1000.E0
C
      IAD = IADDRG(16,NGH) - 1
      SWDCOL(N,IPRCOL) = (VBL(IAD + I00H)*C00H +
     1                    VBL(IAD + I10H)*C10H +
     2                    VBL(IAD + I01H)*C01H +
     3                    VBL(IAD + I11H)*C11H)*1000.E0
C
      IAD = IADDRG(18,NGH) - 1
      AVMCOL(N,IPRCOL) = VBL(IAD + I00H)*C00H +
     1                   VBL(IAD + I10H)*C10H +
     2                   VBL(IAD + I01H)*C01H +
     3                   VBL(IAD + I11H)*C11H
C
      IAD = IADDRG(19,NGH) - 1
      SEXCOL(N,IPRCOL) = VBL(IAD + I00H)*C00H +
     1                   VBL(IAD + I10H)*C10H +
     2                   VBL(IAD + I01H)*C01H +
     3                   VBL(IAD + I11H)*C11H
C
      IAD = IADDRG(25,NGH) - 1
      ULWCOL(N,IPRCOL) = (VBL(IAD + I00H)*C00H +
     1                    VBL(IAD + I10H)*C10H +
     2                    VBL(IAD + I01H)*C01H +
     3                    VBL(IAD + I11H)*C11H)*1000.E0
C
      IAD = IADDRG(26,NGH) - 1
      TLWCOL(N,IPRCOL) = (VBL(IAD + I00H)*C00H +
     1                    VBL(IAD + I10H)*C10H +
     2                    VBL(IAD + I01H)*C01H +
     3                    VBL(IAD + I11H)*C11H)*1000.E0
C
      IAD = IADDRG(28,NGH) - 1
       CLDLO(N,IPRCOL) = (VBL(IAD + I00H)*C00H +
     1                    VBL(IAD + I10H)*C10H +
     2                    VBL(IAD + I01H)*C01H +
     3                    VBL(IAD + I11H)*C11H)*100.E0
C
      IAD = IADDRG(29,NGH) - 1
       CLDME(N,IPRCOL) = (VBL(IAD + I00H)*C00H +
     1                    VBL(IAD + I10H)*C10H +
     2                    VBL(IAD + I01H)*C01H +
     3                    VBL(IAD + I11H)*C11H)*100.E0
C
      IAD = IADDRG(30,NGH) - 1
       CLDHI(N,IPRCOL) = (VBL(IAD + I00H)*C00H +
     1                    VBL(IAD + I10H)*C10H +
     2                    VBL(IAD + I01H)*C01H +
     3                    VBL(IAD + I11H)*C11H)*100.E0
C
      IAD = IADDRG(36,NGH) - 1
      SENCOL(N,IPRCOL) = (VBL(IAD + I00H)*C00H +
     1                    VBL(IAD + I10H)*C10H +
     2                    VBL(IAD + I01H)*C01H +
     3                    VBL(IAD + I11H)*C11H)*1000.E0
C
      IAD = IADDRG(37,NGH) - 1
      EVPCOL(N,IPRCOL) = (VBL(IAD + I00H)*C00H +
     1                    VBL(IAD + I10H)*C10H +
     2                    VBL(IAD + I01H)*C01H +
     3                    VBL(IAD + I11H)*C11H)*2.5E9
C
C    ALSO SAVE TOTAL PRECIP IN INCHES DIRECTLY FROM GRID C
C
      IAD = IADDRG(12,NGH) - 1
      C1 = VBL(IAD + I00H)*C00H +
     1     VBL(IAD + I10H)*C10H +
     2     VBL(IAD + I01H)*C01H +
     3     VBL(IAD + I11H)*C11H
C
      IAD = IADDRG(13,NGH) - 1
      C2 = VBL(IAD + I00H)*C00H +
     1     VBL(IAD + I10H)*C10H +
     2     VBL(IAD + I01H)*C01H +
     3     VBL(IAD + I11H)*C11H
C
      IF(C1 .LT. 0.E0 ) C1 = 0.E0
      IF(C2 .LT. 0.E0 ) C2 = 0.E0
      PRECOL(N,IPRCOL) = (100.E0/2.54E0)*(C1 + C2 )
C
   27 CONTINUE
C
C             RECORD THE TIME IN HOURS
      ITIMCOL(IPRCOL) = KKK
   28 CONTINUE
C
C----------------------------------
C          SFC PRESS ( H ) IS IN S(MHOUT).  IS SFC PRESSURE WANTED?
      DO 21 N=1,NOUTVBLS
      NCARD=N
      IF( LQTYPE(N) .NE. LABPRES ) GO TO 21
      IF( LSTYPE(N) .NE.  LABSFC ) GO TO 21
      IF(LEVELS(1,N) .EQ.  1 )     GO TO 22
   21 CONTINUE
C          SFC PRESS NOT ASKED FOR
      GO TO 23
C
   22 CONTINUE
C
C          SINCE SFC PRESS IS WANTED, COPY IT (IN MBS) INTO
C          S(MSOUT2) AND SEND IT ON ITS WAY.
C
      DO 89090 IQ2W6E=1,IJOUT
         S(MSOUT2+IQ2W6E-1)=1000.E0*S(MHOUT+IQ2W6E-1)
89090 CONTINUE
C
C
      LABQTYPE=LABPRES
      LABSSUB1=LABSFC
      S1VALUE=0.E0
C           UPDATE THE ARRAY LABEL84
        CALL OUTNULAB
C
C  SET UP PDS INFO
C
      CALL LAB2PDS(LABEL84,IDGRBE)
      IDGRBE(7) =   0
      IDGRBE(8) =   1
      IDGRBE(9) =   1
      IDGRBE(10) =  0
      IDGRBE(11) =  0
      IDGRBE(18) =  LABEL84(3)
      IDGRBE(19) =  0
      IDGRBE(20) =  0
C
C                     GO TO THE PACKER CODE
c     CALL OUTPACK(S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
c    1             LABEL84,IOUTUNIT )
      CALL GRIBITN (S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
     1             IDGRBE,IOUTGRIB,LABEL84 )
C
   23 CONTINUE
C
C--------------------------------------------------------
C
C--------------------------------------------------------
C                     GROUND HEIGHT
C
      DO 24 N=1,NOUTVBLS
      NCARD=N
      IF( LQTYPE(N) .NE. LABHGT ) GO TO 24
      IF( LSTYPE(N) .NE. LABSFC ) GO TO 24
      IF( LEVELS(1,N) .EQ. 1    ) GO TO 25
   24 CONTINUE
      GO TO 30
C
C          PUT GND HEIGHT INTO FNGM
   25 C1=CSUBP/GRAVITY
      DO 26 NN=1,NUMGDREQ
      NG=NGRIDATA(NN)
      IADF=JADDFNGM(NG)
      IM=IMG(NG)
      JM=JMG(NG)
      IJ=IM*JM
      IADG=IADDRG(10,NG)
      DO 89100 IQ2W6E=1,IJ
         FNGM(IADF+IQ2W6E-1)=C1*VBL(IADG+IQ2W6E-1)
89100 CONTINUE
   26 CONTINUE
C
            CALL OUTHORIZ(IN(MIILL),IN(MIIUL),S(MSA),S(MSB),S(MSC),
     *                    S(MSD),S(MSOUT1),S(MSOUT2))
C
      LABQTYPE=LABHGT
      LABSSUB1=LABSFC
      S1VALUE=0.E0
        CALL OUTNULAB
C
C  SET UP PDS INFO
C
      CALL LAB2PDS(LABEL84,IDGRBE)
      IDGRBE(7) =   0
      IDGRBE(8) =   7
      IDGRBE(9) =   1
      IDGRBE(10) =  0
      IDGRBE(11) =  0
      IDGRBE(18) =  LABEL84(3)
      IDGRBE(19) =  0
      IDGRBE(20) =  0
C
C                     GO TO THE PACKER CODE
c     CALL OUTPACK(S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
c    1             LABEL84,IOUTUNIT )
      CALL GRIBITN (S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
     1             IDGRBE,IOUTGRIB,LABEL84 )
C
   30 CONTINUE
C
C--------------------------------------------------------
C         POTENTIAL TEMPERATURE ON PRESSURE SURFACES
      IF( NTHETAP .EQ. 0 ) GO TO 34
C
C           THETA ON PRESS SURFACES IS WANTED
      NDATA=2
      NWORK=1
      MB=MB1
C        FOR AN ISOTHERMAL LAYER, D(THETA)/D(-LOG(P) ) EQUALS
C             (R/CSUBP) * THETA
      GAMTOP=(287.05E0/1005.E0) * 650.E0
C         USE ADIABATIC LAYER BELOW K=1
C*********NOTE THAT THIS WILL NOT AGREE WITH PRESSURE REDUCTION
C*********BELOW LEVEL K=1.
      GAMBOT=0.E0
C          DO NOT SMOOTH
      ISM=0
C
        CALL OUTSIG2P(NDATA,NWORK,MB,LABPOT,GAMBOT,GAMTOP,ISM)
C
   34 CONTINUE
C
C--------------------------------------------------------------
C
C---------------------------------------------------------------
C           POTENTIAL TEMPERATURE ON SIGMA SURFACES
C
      IF( NTHETAS .EQ. 0 ) GO TO 36
C
C         MOVE THETA FROM THE NGM GRIDS TO  S(JSCR3OUT(1) )
      NFROM=2
      NTO=1
      IRET=8
      GO TO 900
C
   35 CONTINUE
C
      CALL OUTSIGMA( S(JSCR3OUT(1) ) , S(MSOUT1), LABPOT )
C
   36 CONTINUE
C
C----------------------------------------------------------------
C
C----------------------------------------------------------------
C            TEMPERATURE OF SOIL OR WATER SURFACE
C
      DO 40 N=1,NOUTVBLS
      NCARD = N
      IF( LQTYPE(N) .NE. LABSTMP ) GO TO 40
      IF( LSTYPE(N) .NE. LABDEPTH ) GO TO 40
      IF( LEVELS(1,N) .EQ. 1     ) GO TO 41
C               FOUND RIGHT CARD, BUT IT IS NOT WANTED
      GO TO 43
C
   40 CONTINUE
C              COULD NOT FIND RIGHT CARD
      GO TO 43
C
   41 CONTINUE
C             THIS TEMPERATURE IS WANTED
      DO 42 NN=1,NUMGDREQ
      NG = NGRIDATA(NN)
      IADF = JADDFNGM(NG)
      IM = IMG(NG)
      JM = JMG(NG)
      IJ = IM * JM
      IADG = IADDRG(6,NG)
      DO 89110 IQ2W6E=1,IJ
         FNGM(IADF+IQ2W6E-1)=VBL(IADG+IQ2W6E-1)
89110 CONTINUE
   42 CONTINUE
C
            CALL OUTHORIZ(IN(MIILL),IN(MIIUL),S(MSA),S(MSB),S(MSC),
     *                    S(MSD),S(MSOUT1),S(MSOUT2))
C
      LABQTYPE = LABSTMP
      LABSSUB1 = LABDEPTH
      S1VALUE = 0.E0
            CALL OUTNULAB
c     do k = 1, 27
c       print *,' output ',k,label84(k)
c     enddo
C
C  SET UP PDS INFO
C
      CALL LAB2PDS(LABEL84,IDGRBE)
      IDGRBE(7) =   0
      IDGRBE(8) =  85
      IDGRBE(9) = 111
      IDGRBE(10) =  0
      IDGRBE(11) =  0
      IDGRBE(18) =  LABEL84(3)
      IDGRBE(19) =  0
      IDGRBE(20) =  0
C
C          (NOTE THAT WE HAVE NOT SMOOTHED)
C
C                     GO TO THE PACKER CODE
c     CALL OUTPACK(S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
c    1             LABEL84,IOUTUNIT )
      CALL GRIBITN (S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
     1             IDGRBE,IOUTGRIB,LABEL84 )

   43 CONTINUE
C
C-----------------------------------------------------------------
C
C------------------------------------------------------------------
C
C          PREPARE FOR POSSIBLE OUTPUT OF TEMP ON PRESS SFCS.
      NDATA=1
      NWORK=1
      MB=MB1
C          THE DERIVATIVES OF TEMPERATURE WITH RESPECT TO -LOG(P).
      GAMTOP=0.E0
C          USE APPROXIMATELY -6.5 DEG/KM AT THE BOTTOM.
C        (NOTE THAT D(HEIGHT)= (R*T/G) * D( -LOG(P) )
      GAMBOT=(287.05E0*288.E0/GRAVITY) * (-.0065E0 )
C
C--------------------------------------------------------
C             TEMPERATURE ON PRESSURE SURFACES
C
C           DO NOT SMOOTH
      ISM=0
C
      CALL OUTSIG2P( NDATA,NWORK,MB, LABTEMP, GAMBOT,GAMTOP,ISM)
C
C--------------------------------------------------------
C
C          NEED TEMPERATURE AT SIGMA LEVELS ON THE OUTPUT GRID,
C          WILL PUT THEM IN THE ARRAY BEGINNING AT JSCR3OUT(1).
C
      NFROM=1
      NTO=1
      IRET=7
      GO TO 900
   50 CONTINUE
C
C---------------- MEAN TEMPS SIG LYRS GRID NGRDUSE
      IF( KGTYPE .NE. NGDSPEC ) GO TO 59
      KKK12=KKK/12
C               SET ISIT12 = 1 FOR KKK=MULTIPLE OF 12 HOURS
      ISIT12 = 0
      KKKTST = KKK - 12*KKK12
      IF(KKKTST .EQ. 0 ) ISIT12 = 1
C                DO THIS PRINT ONLY EVERY 12 HOURS
      IF( ISIT12 .NE. 1 ) GO TO 58
C
      DIJ = 1.E0 / FLOAT(IJOUT)
      DO 53 KK = 1,KM
      K = KM - KK + 1
      IAD = JSCR3OUT(1) + (K-1)*IJOUT
      TMEAN = 0.
      DO 8001 IQ2 = 1, IJOUT
         TMEAN = TMEAN + S(IAD+IQ2-1)
8001  CONTINUE
      TMEAN = TMEAN * DIJ
   53 CONTINUE
C
   58 CONTINUE
C
   59 CONTINUE
C
C-------------------------------------------------------------------
C-------------------------------------------------------------------
C              THE SEA-LEVEL PRESSURE ADJUSTMENT FIELD IN MBS
C
      DO 64 N=1,NOUTVBLS
      NCARD = N
      IF( LQTYPE(N).EQ.LABPADJ .AND. LSTYPE(N).EQ.1  ) GO TO 65
   64 CONTINUE
C            NO CARD, THEREFORE NO OUTPUT
      GO TO 67
C
   65 IF(LEVELS(1,NCARD) .NE. 1 ) GO TO 67
C              PUT FIELD IN THE ARRAY FNGM
      DO 66 NN=1,NUMGDREQ
      NG = NGRIDATA(NN)
      IM = IMG(NG)
      JJ1 = J1(NG)
      JADDM1 = (JJ1-1) * IM
      LEN = LENGD(NG)
      IADF = JADDFNGM(NG) + JADDM1
      IAD = IADDRG(9,NG) + JADDM1
      DO 89120 IQ2W6E=1,LEN
         FNGM(IADF+IQ2W6E-1)=VBL(IAD+IQ2W6E-1)*1000.E0
89120 CONTINUE
C
   66 CONTINUE
C
            CALL OUTHORIZ(IN(MIILL),IN(MIIUL),S(MSA),S(MSB),S(MSC),
     *                    S(MSD),S(MSOUT1),S(MSOUT2))
C          UPDATE LABEL TABLE AND SEND TO PACKER CODE
      LABQTYPE = LABPADJ
      LABSSUB1 = LABMSL
      S1VALUE = 0.E0
C             NEED VALUE OF 1 OF THE T MARKER
      LABTMARK = 1
C
      CALL OUTNULAB
C
C this is never posted so comment out call to packer
C
c     CALL OUTPACK(S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
c    1             LABEL84, IOUTUNIT )
c     CALL GRIBIT (S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
c    1             LABEL84, IOUTGRIB )
C
C             RESTORE LABTMARK TO ZERO
      LABTMARK = 0
   67 CONTINUE
C
C
C
C--------------------------------------------------------
C--------------------------------------------------------
C                TEMPERATURE ON SIGMA SURFACES
C
          CALL OUTSIGMA( S(JSCR3OUT(1) ) , S(MSOUT1), LABTEMP )
C
C--------------------------------------------------------
C
C          PUT Z=-LOG(PRESS/100 CBS) ON OUTPUT GRID INTO
C          ARRAY   JSCR3OUT(2) FOR THE K=1,KM LEVELS.
C
      NFROM=3
      NTO=2
      IRET=6
      GO TO 900
   70 CONTINUE
C
C
C          PUT Z AT THE GROUND INTO AN OUTPUT ARRAY.
      DO 80 NN=1,NUMGDREQ
      NG=NGRIDATA(NN)
      LEN=LENGD(NG)
      IM=IMG(NG)
      JJ1=J1(NG)
      J1ADD=IM*(JJ1-1) + 1
C          THE ADDRESS IN FNGM
      IADF=JADDFNGM(NG)+J1ADD-1
C          THE ADDRESS IN S OF Z(GND) FOR GRID NG
      IADS=MSZGND(NG)
      DO 89130 IQ2W6E=1,LEN
         FNGM(IADF+IQ2W6E-1)=S(IADS+IQ2W6E-1)
89130 CONTINUE
   80 CONTINUE
C
C          REDIRECT THE DESCRIPTOR  OUTHORD  .
C
            CALL OUTHORIZ(IN(MIILL),IN(MIIUL),S(MSA),S(MSB),S(MSC),
     *                    S(MSD),S(MSOUT1),S(MZGNDOUT))
C
C          IS HEIGHT OR REL HUMID AT FRZING LEVEL WANTED?
C          IF SO,,,
C          PUT Z(=-LOG(PRESS/100 CBS) ) AT THE FREEZING LEVEL INTO
C          THE ARRAY  S(MZFR)  , AND PUT GATHER INTEGERS FOR THE
C          K-LEVEL ABOVE THE FREEZING LEVEL ON THE OUTPUT GRID,INTO
C          AN INTEGER ARRAY  IGATHFZD IN DYNAMIC SPACE.
C
      IF( IFRZDO .EQ. 0 ) GO TO 100
C           WE MUST DO IT.
C
C          INITIALIZE THIS WITH THE HORIZONTAL GRID POINT NUMBERS.
      DO 9009 IQ2 = 1, IJOUT
         IGATHFZ(IQ2) = IQ2
9009  CONTINUE
C          NEED TWO BIT VECTORS
C
C          BIT1D=1 WILL RECORD POINTS WHOSE FREEZING LVL HAS BEEN
C          FOUND.    BIT2D WILL BE USED TO FIND ANEW AT EACH LEVEL
C          THOSE POINTS WITH FREEZING TEMPERATURES.
      T3=273.16E0
C          DO ANY POINTS HAVE T .LE. T3 AT K=1,,,,
      IADT=JSCR3OUT(1)
      DO 89140 IQ2W6E=1,IJOUT
         BITS(MB1+IQ2W6E-1)=S(IADT+IQ2W6E-1).LE.T3
89140 CONTINUE
C          FOR THESE POINTS SET S(MZFR)=-10.E0 AS A FLAG, AND LEAVE
C          THE GATHER INTEGER SET FOR LEVEL K=1.
      DO 89150 IQ2W6E=1,IJOUT
       IF ( BITS(MB1+IQ2W6E-1) ) THEN
         S(MZFR+IQ2W6E-1)=-10.E0
       END IF
89150 CONTINUE
C          TWO SCRATCH ARRAY ADDRESSES.
      IADS1=JSCR2(1)
      IADS2=JSCR2(2)
C          INITIALIZE ADDRESS FOR Z AND T TO THE K=1 LEVEL.
      IADZ=JSCR3OUT(2)
      IADT=JSCR3OUT(1)
C
      DO 90 K=2,KM
      IADZ=IADZ+IJOUT
      IADT=IADT+IJOUT
      DO 89160 IQ2W6E=1,IJOUT
         BITS(MB2+IQ2W6E-1)=S(IADT+IQ2W6E-1).LE.T3
89160 CONTINUE
C          RESTRICT BIT2D TO NEW POINTS,,
      DO 89170 IQ2W6E=1,IJOUT
         BITS(MB2+IQ2W6E-1)=BITS(MB2+IQ2W6E-1).AND..NOT.BITS(MB1+
     *   IQ2W6E-1)
89170 CONTINUE
      C1=ZSIGLYR(K)-ZSIGLYR(K-1)
      I1=(K-1)*IJOUT
C
C          ADJUST THE NEW GATHER INTEGERS
      DO 89180 IQ2W6E=1,IJOUT
       IF ( BITS(MB2+IQ2W6E-1) ) THEN
         IGATHFZ(IQ2W6E)=IGATHFZ(IQ2W6E)+I1
       END IF
89180 CONTINUE
C          COMPUTE Z AT THE FREEZING LEVEL
C             WITH THE FORMULA
C                          ( T3 - T(BELOW) )*( Z(ABOVE)-Z(BELOW) )
C   Z(FREEZE)=Z(BELOW) +  ---------------------------------------
C                                ( T(ABOVE)-T(BELOW) )
C
      DO 89190 IQ2W6E=1,IJOUT
       IF ( BITS(MB2+IQ2W6E-1) ) THEN
         S(IADS1+IQ2W6E-1)=S(IADT+IQ2W6E-1)-S(IADT-IJOUT+IQ2W6E-1)
         S(IADS2+IQ2W6E-1)=T3-S(IADT-IJOUT+IQ2W6E-1)
         S(IADS2+IQ2W6E-1)=S(IADS2+IQ2W6E-1)/S(IADS1+IQ2W6E-1)
       END IF
89190 CONTINUE
C
      DO 89220 IQ2W6E=1,IJOUT
       IF ( BITS(MB2+IQ2W6E-1) ) THEN
         S(MZFR+IQ2W6E-1)=S(IADZ-IJOUT+IQ2W6E-1)+C1*S(IADS2+IQ2W6E-1)
       END IF
89220 CONTINUE
C
C
C     ADJUST BIT1D TO INCLUDE NEW POINTS AND CHECK FOR COMPLETION.
      DO 89230 IQ2W6E=1,IJOUT
         BITS(MB1+IQ2W6E-1)=BITS(MB1+IQ2W6E-1).OR.BITS(MB2+IQ2W6E-1)
89230 CONTINUE
      ICOUNT = 0
      DO 7901 IQ2 = 1, IJOUT
         IF ( BITS(MB1+IQ2-1) ) ICOUNT = ICOUNT + 1
7901  CONTINUE
      IF( ICOUNT .GE. IJOUT ) GO TO 100
C
   90 CONTINUE
C
  100 CONTINUE
C
C
C--------------------------------------------------------
C
C--------------------------------------------------------
C
C     PUT RELATIVE HUMIDITY ( IN PERCENT) , J=J1,J2,, ON NEEDED
C     NGM GRIDS, INTO THE SET OF ARRAYS JSCR3NGM(NN,2)
C
      EPS=RGASD / RGASV
C          SCRATCH ARRAY ADDRESSES
      IADS1=JSCR2(1)
      IADS2=JSCR2(2)
      IADS3=JSCR2(3)
C
      DO 210 NN=1,NUMGDREQ
      NG=NGRIDATA(NN)
      IM=IMG(NG)
      JM=JMG(NG)
      IJ=IM*JM
      LEN=LENGD(NG)
      JJ1=J1(NG)
      J1ADD=(JJ1-1)*IM + 1
C
C          ADDRESS FOR 1/H TO GET Q FROM HQ
      IADREC = JHREC(NG) + J1ADD -1
C          ADDRESS(-IJ) OF FIRST T POINT IN JSCR3NGM(NN,1)
      IADT=JSCR3NGM(NN,1)+J1ADD -1 -IJ
C          ADDRESS OF FIRST Q POINT IN ARRAY VBL (-IJ).
      IADQ=IADDRG(4,NG) + J1ADD -1 -IJ
C          ADDRESS OF FIRST H POINT IN ARRAY VBL
      IADH=IADDRG(5,NG) + J1ADD -1
C          ADDRESS(-IJ) OF J1ADD PT IN JSCR3NGM(NN,2) FOR REL HUM.
      IADRH=JSCR3NGM(NN,2) + J1ADD -1 -IJ
        DO 200 K=1,KM
        IADT=IADT + IJ
        IADQ=IADQ + IJ
        IADRH=IADRH + IJ
C
      CALL VAPTAB( S(IADT), S(IADS1), LEN,1)
C
C          CONSTANT TO GET PRESSURES IN CENTIBARS.
        C2=100.E0 * PRESS(K)
C          PRESS (IN CBS) INTO S2D
      DO 89240 IQ2W6E=1,LEN
         S(IADS2+IQ2W6E-1)=C2*VBL(IADH+IQ2W6E-1)
89240 CONTINUE
C     THE FORMULA  IS
C                        Q * ( P - E(SAT) ) * 100
C     RH(PER CENT) = ---------------------------------
C                      ( 1-Q ) * EPS * E(SAT)
C
C             PUT Q INTO S3D
      DO 89250 IQ2W6E=1,LEN
         S(IADS3+IQ2W6E-1)=VBL(IADQ+IQ2W6E-1)*S(IADREC+IQ2W6E-1)
89250 CONTINUE
C
C          NUMERATOR INTO S2D
      DO 89260 IQ2W6E=1,LEN
         S(IADS2+IQ2W6E-1)=100.E0*(S(IADS2+IQ2W6E-1)-S(IADS1+IQ2W6E-1)
     *   )
         S(IADS2+IQ2W6E-1)=S(IADS2+IQ2W6E-1)*S(IADS3+IQ2W6E-1)
89260 CONTINUE
C          DENOMINATOR INTO S3D
      DO 89280 IQ2W6E=1,LEN
         S(IADS3+IQ2W6E-1)=1.E0-S(IADS3+IQ2W6E-1)
         S(IADS3+IQ2W6E-1)=S(IADS3+IQ2W6E-1)*S(IADS1+IQ2W6E-1)*EPS
89280 CONTINUE
C          RELATIVE HUMIDITY INTO JSCR3NGM ARRAY.
      DO 89300 IQ2W6E=1,LEN
         S(IADRH+IQ2W6E-1)=S(IADS2+IQ2W6E-1)/S(IADS3+IQ2W6E-1)
89300 CONTINUE
C               ENFORCE UPPER LIMIT OF RELHMAX
      DO 89310 IQ2W6E=1,LEN
         BITS(MB1+IQ2W6E-1)=S(IADRH+IQ2W6E-1).GT.RELHMAX
89310 CONTINUE
      DO 89320 IQ2W6E=1,LEN
       IF ( BITS(MB1+IQ2W6E-1) ) THEN
         S(IADRH+IQ2W6E-1)=RELHMAX
       END IF
89320 CONTINUE
C               ENFORCE LOWER LIMIT OF RELHMIN
      DO 89330 IQ2W6E=1,LEN
         BITS(MB1+IQ2W6E-1)=S(IADRH+IQ2W6E-1).LT.RELHMIN
89330 CONTINUE
      DO 89340 IQ2W6E=1,LEN
       IF ( BITS(MB1+IQ2W6E-1) ) THEN
         S(IADRH+IQ2W6E-1)=RELHMIN
       END IF
89340 CONTINUE
C
C
  200   CONTINUE
C
  210 CONTINUE
C
C--------------------------------------------------------
C              RELATIVE HUMIDITY ON PRESSURE SURFACES
C
      NDATA=2
      NWORK=1
      MB=MB1
      GAMBOT=0.E0
      GAMTOP=0.E0
C
C
C         DO NOT SMOOTH
      ISM=0
C
      CALL OUTSIG2P(NDATA,NWORK,MB,LABRELH,GAMBOT,GAMTOP,ISM)
C
C--------------------------------------------------------
C
C          NEED RELATIVE HUMIDITY ON SIGMA SFCS OF OUTPUT GRID.
C          WILL GET REL H FROM S ( JSCR3NGM(NN,2) )
      NFROM=2
C          WILL PUT IT IN S ( JSCR3OUT( 3 ) )
      NTO=3
C          GO TO THE NGM-OUTPUT SIGMA LEVEL ROUTINE
      IRET=1
      GO TO 900
  220 CONTINUE
C
C--------- AVERAGE REL HUMIDITY
      IF( KGTYPE .NE. NGDSPEC ) GO TO 219
C                SKIP HORIZ AVERAGES IF NOT AT 12,24,ETC HRS
      IF( ISIT12 .NE. 1 ) GO TO 216
C
      DIJ = 1.E0 /FLOAT(IJOUT)
      DO 213 KK= 1,KM
      K = KM - KK + 1
      IAD = JSCR3OUT(3) + (K-1) * IJOUT
      RHMEAN = 0.
      DO 5901 IQ2 = 1, IJOUT
         RHMEAN = RHMEAN + S ( IAD+IQ2-1)
5901  CONTINUE
      RHMEAN = RHMEAN * DIJ
  213 CONTINUE
C
  216 CONTINUE
C
C
  219 CONTINUE
C
C----------------
C
C--------------------------------------------------------
C              RELATIVE HUMIDITY ON SIGMA SURFACES
C
      IADSIG=JSCR3OUT(3)
      IADSCR=JSCR2(1)
C
         CALL OUTSIGMA(S(IADSIG), S(IADSCR), LABRELH )
C
C--------------------------------------------------------
C
C--------------------------------------------------------
C MEAN RELATIVE HUMIDITY IN SOME SIGMA LAYERS NEAR GROUND
C
C***   IF THE OLD LFM TYPE LABEL IS WANTED FOR THE SIGMA LVLS
C      1-9 AVERAGE (FOR GRAPHICS) , THE FLAG LFMOLD SHOULD BE
C      SET TO 1
                   LFMOLD = 0
C
C          THIS WILL BE DENOTED BY A DATA CARD WITH
C          LQTYPE=LABRELH(I.E. 88),LSTYPE=0(AN UNUSED VALUE),
C          AND LEVELS(1,NCARD)=1
C
      DO 224 N=1,NOUTVBLS
      NCARD=N
      IF(LQTYPE(N).EQ.LABRELH .AND. LSTYPE(N).EQ.0 ) GO TO 225
  224 CONTINUE
C     NO DATA CARD
      GO TO 227
C
  225 CONTINUE
C
C         SET UP SOME BASIC LABEL FORMATS
      LABQTYPE = LABRELH
      LABSSUB1 = LABSIG
      LABSSUB2 = LABSIG
      LABMLDIF = 2
C
C              WILL CONSIDER THREE OUTPUT FIELDS OF THIS TYPE
      DO 228 N=1,3
      IF( LEVELS(N,NCARD) .NE. 1 ) GO TO 228
C          FIRST ONE IS FOR LEVELS 1-9 (FOR GRAPHICS PANEL)
      K1 = 1
      K2 = 9
      IF( N .EQ. 1 ) GO TO 221
C          SECOND ONE IS FOR LEVELS 2-9 ( FOR FOUS)
      K1 = 2
      K2 = 9
      IF( N .EQ. 2 ) GO TO 221
C          THIRD ONE IS FOR LEVELS 10 - 13 ( FOR FOUS)
      K1 = 10
      K2 = 13
C
  221 CONTINUE
C
      DSIG = DELSIG(K1)
      IAD = JSCR3OUT(3) + (K1-1)*IJOUT
      DO 89350 IQ2W6E=1,IJOUT
         S(JSCR2(1)+IQ2W6E-1)=DSIG*S(IAD+IQ2W6E-1)
89350 CONTINUE
      TOTDSIG = DSIG
      K11 = K1 + 1
      DO 226 K=K11,K2
C
      DSIG=DELSIG(K)
      TOTDSIG=TOTDSIG + DSIG
      IAD=IAD+IJOUT
      DO 89360 IQ2W6E=1,IJOUT
       S(JSCR2(1)+IQ2W6E-1)=S(JSCR2(1)+IQ2W6E-1)+DSIG*S(IAD+IQ2W6E-1)
89360 CONTINUE
  226 CONTINUE
      DSIGR=1.E0/TOTDSIG
      DO 89370 IQ2W6E=1,IJOUT
         S(JSCR2(1)+IQ2W6E-1)=DSIGR*S(JSCR2(1)+IQ2W6E-1)
89370 CONTINUE
C
C          PREPARE REMAINING LABEL INFORMATION
C             FIRST THE(CONVENTIONAL) SIGMA AT BOTTOM OF 1ST LAYER
      S2VALUE = 1.E0
      IF( K1 .EQ. 1 ) GO TO 223
      KEND = K1 - 1
      DO 222 K = 1,KEND
      S2VALUE = S2VALUE - DELSIG(K)
  222 CONTINUE
C              NOW THE SIGMA AT TOP OF LAST AVERAGED LAYER
  223 S1VALUE = S2VALUE - TOTDSIG
C
C-------  CONSIDER USE OF OLD LFM LABEL FOR GRAPHICS PRODUCT
      IF ( N .NE. 1 ) GO TO 229
      IF (LFMOLD .NE. 1) GO TO 229
      LABSSUB1 = 145
      LABSSUB2 = 144
      S1VALUE = 0.33333E0
      S2VALUE = 1.E0
C
  229 CONTINUE
C
C------
C
        CALL OUTNULAB
C
C
C  SET UP PDS INFO
C
      CALL LAB2PDS(LABEL84,IDGRBE)
      IDGRBE(7) =   0
      IDGRBE(8) =  52
      IDGRBE(9) = 108
      ALEV1 = REAL(LABEL84(5)) 
      ARGL1 = REAL(LABEL84(6))
      XLEV1 = ALEV1 * 10.**ARGL1
      IDGRBE(10) =  INT(XLEV1 * 100.)
      ALEV2 = REAL(LABEL84(12)) 
      ARGL2 = REAL(LABEL84(13))
      XLEV2 = ALEV2 * 10.**ARGL2
      IDGRBE(11) =  INT(XLEV2 * 100.)
      IDGRBE(18) =  LABEL84(3)
      IDGRBE(19) =  0
      IDGRBE(20) =  0
c     do k = 1, 25
c      print *,'rh output ',label84(k),idgrbe(k)
c     enddo
C
C          (NOTE THAT WE HAVE NOT SMOOTHED)
C
C                     GO TO THE PACKER CODE
c     CALL OUTPACK(S(JSCR2(1)),IJOUT, S(JSCR2(2)),DESCRIPT(NCARD),
c    1             LABEL84,IOUTUNIT )
      CALL GRIBITN (S(JSCR2(1)),IJOUT, S(JSCR2(2)),DESCRIPT(NCARD),
     1             IDGRBE,IOUTGRIB,LABEL84 )
C
C------       REPAIR THE DAMAGE
      IF( N .NE. 1 ) GO TO 228
      IF( LFMOLD .NE. 1 ) GO TO 228
      LABSSUB1 = LABSIG
      LABSSUB2 = LABSIG
C
C------
C
  228 CONTINUE
C
C
C          RESTORE THE NORMAL VALUES OF LABMLDIF,LABSSUB2,AND S2VALUE.
      LABMLDIF=0
      LABSSUB2=0
      S2VALUE=0.E0
C
  227 CONTINUE
C
C--------------------------------------------------------
C
C     ON THE OUTPUT GRID, WE NOW HAVE SIGMA LEVEL DATA
C          TEMP IN S(JSCR3OUT(1) )
C            Z   IN S(JSCR3OUT(2) )
C          REL H IN S(JSCR3OUT(3) )
C
C--------------------------------------------------------
C              RELATIVE HUMIDITY AT FREEZING LEVEL
C
C          ASSUME THIS DENOTED BY DTA CARD WITH LQTYPE=LABRELH,AND
C          LSTYPE=LABTEMP, WITH LEVELS(1,N) = 1.
C          IF IFRZDO .GT. 0, LOOK FOR THIS CARD
      IF( IFRZDO .EQ. 0 ) GO TO 260
C
      DO 240 N=1,NOUTVBLS
      NCARD=N
      IF(LQTYPE(N) .NE. LABRELH ) GO TO 240
      IF(LSTYPE(N).EQ.LABTEMP .AND. LEVELS(1,N).EQ.1 ) GO TO 250
  240 CONTINUE
C          NOT WANTED
      GO TO 260
C          WANTED, PREPARE IT.
  250 CONTINUE
C
C          Z AT FREEZING LEVEL IS IN S(MZFR)(DESC. ZFREEZED )
C          GATHER INTEGERS FOR Z (OR REL H) AT THE SIGMA LEVEL
C          ABOVE THE FREEZING LEVEL ARE IN DESCRIPTOR IGATHFZD.
C     THE INTERPOLATION FORMULA IS
C                                 (Z(FRZ)-Z(BEL))*(RH(ABV)-RH(BEL))
C  RH(FRZ)  = RH(BEL)  +       -------------------------------------
C                                           Z(ABV) - Z(BEL)
C
C          PUT RESULT IN S(MSOUT2) FOR PACKER
C          GATHER ORIGINS FOR  Z  AND  REL H ABOVE FREEZING LEVEL.
      IADZ=JSCR3OUT(2)-1
      IADR=JSCR3OUT(3)-1
C          NOMINAL LENGTH
      LEN=1
C
C          REL H (ABOVE) INTO S2D
C*****  Code Expanded From Routine:  RDHGATHR
      DO 77069 I2X = 1, IJOUT
         S(I2X+JSCR2(2)-1) = S(IGATHFZ(I2X)+IADR)
77069 CONTINUE
C*****  End of Code Expanded From Routine:  RDHGATHR
C*****  Code Expanded From Routine:  RDHGATHR
      DO 77070 I3X = 1, IJOUT
         S(I3X+JSCR2(1)-1) = S(IGATHFZ(I3X)+IADR-IJOUT)
77070 CONTINUE
C*****  End of Code Expanded From Routine:  RDHGATHR
C          RH(ABV) - RH(BEL) INTO S2D
      DO 89380 IQ2W6E=1,IJOUT
       S(JSCR2(2)+IQ2W6E-1)=S(JSCR2(2)+IQ2W6E-1)-S(JSCR2(1)+IQ2W6E-1)
89380 CONTINUE
C          Z BELOW INTO S3D
C*****  Code Expanded From Routine:  RDHGATHR
      DO 77071 I4X = 1, IJOUT
         S(I4X+JSCR2(3)-1) = S(IGATHFZ(I4X)+IADZ-IJOUT)
77071 CONTINUE
C*****  End of Code Expanded From Routine:  RDHGATHR
C*****  Code Expanded From Routine:  RDHGATHR
      DO 77072 I5X = 1, IJOUT
         S(I5X+MSOUT2-1) = S(IGATHFZ(I5X)+IADZ)
77072 CONTINUE
C*****  End of Code Expanded From Routine:  RDHGATHR
C          DENOMINATOR INTO S4D
      DO 89390 IQ2W6E=1,IJOUT
         S(MSOUT2+IQ2W6E-1)=S(MSOUT2+IQ2W6E-1)-S(JSCR2(3)+IQ2W6E-1)
89390 CONTINUE
C          ZFREEZE - Z(BEL)
      DO 89400 IQ2W6E=1,IJOUT
         S(JSCR2(3)+IQ2W6E-1)=S(MZFR+IQ2W6E-1)-S(JSCR2(3)+IQ2W6E-1)
89400 CONTINUE
C          GET THE SECOND TERM
C        SET BIT VECTOR =1 FOR POINTS ABOVE SIGMA LEVEL 1.
      DO 89410 IQ2W6E=1,IJOUT
       BITS(MB1+IQ2W6E-1)=IGATHFZ(IQ2W6E).GT.IJOUT
       S(JSCR2(3)+IQ2W6E-1)=S(JSCR2(3)+IQ2W6E-1)*S(JSCR2(2)+IQ2W6E-1)
89410 CONTINUE
C
      DO 89430 IQ2W6E=1,IJOUT
       IF ( BITS(MB1+IQ2W6E-1) ) THEN
         S(JSCR2(3)+IQ2W6E-1)=S(JSCR2(3)+IQ2W6E-1)/S(MSOUT2+IQ2W6E-1)
       END IF
89430 CONTINUE
C
C          PUT THE RESULTS INTO MSOUT2 FOR PACKER
C          FIRST ASSUME LEVEL IS AT OR BELOW K=1.
      DO 89440 IQ2W6E=1,IJOUT
         S(MSOUT2+IQ2W6E-1)=S(JSCR3OUT(3)+IQ2W6E-1)
89440 CONTINUE
C          USE INTERPOLATED RESULT ABOVE LAYER K=1.
      DO 89450 IQ2W6E=1,IJOUT
         IF( BITS(MB1+IQ2W6E-1) ) THEN
         S(MSOUT2+IQ2W6E-1)=S(JSCR2(3)+IQ2W6E-1)+S(JSCR2(1)+IQ2W6E-1)
         END IF
89450 CONTINUE
C
      LABQTYPE=LABRELH
      LABSSUB1=LABTEMP
      S1VALUE=273.16E0
         CALL OUTNULAB
C
C  SET UP PDS INFO
C
      CALL LAB2PDS(LABEL84,IDGRBE)
      IDGRBE(7) =   0
      IDGRBE(8) =  52
      IDGRBE(9) =   4
      IDGRBE(10) =  0
      IDGRBE(11) =  0
      IDGRBE(18) =  LABEL84(3)
      IDGRBE(19) =  0
      IDGRBE(20) =  0
C
C          (NOTE THAT WE HAVE NOT SMOOTHED)
C
C                     GO TO THE PACKER CODE
c     CALL OUTPACK(S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
c    1             LABEL84,IOUTUNIT )
      CALL GRIBITN (S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
     1             IDGRBE,IOUTGRIB,LABEL84 )
C
  260 CONTINUE
C
C--------------------------------------------------------
C
C          COPY SPECIFIC HUMIDITY  Q  FROM HQ IN VBL INTO
C          S (JSCR3NGM(NN,2) FOR J=J1,J2.
      DO 280 NN=1,NUMGDREQ
      NG=NGRIDATA(NN)
      IM=IMG(NG)
      JM=JMG(NG)
      IJ=IM*JM
      LEN=LENGD(NG)
      JJ1=J1(NG)
      JADDM1=(JJ1-1)*IM
C          ADDRESS FOR 1/H
      IADREC = JHREC(NG) + JADDM1
C          ADDRESS OF HQ IN VBL,  MINUS IJ
      IADVBL=IADDRG(4,NG) + JADDM1 - IJ
C          TARGET ADDRESS IN S FOR Q,  MINUS IJ
      IADJ3=JSCR3NGM(NN,2) + JADDM1 - IJ
        DO 270 K=1,KM
        IADVBL=IADVBL + IJ
        IADJ3=IADJ3 + IJ
      DO 89460 IQ2W6E=1,LEN
         S(IADJ3+IQ2W6E-1)=VBL(IADVBL+IQ2W6E-1)*S(IADREC+IQ2W6E-1)
89460 CONTINUE
  270   CONTINUE
C
  280 CONTINUE
C
C--------------------------------------------------------
C              SPECIFIC HUMIDITY ON PRESSURE SURFACES
C
      NDATA=2
      NWORK=1
      MB=MB1
C          ZERO VERTICAL EXTRAPOLATION OUTSIDE OF K=1,KM.
      GAMBOT=0.E0
      GAMTOP=0.E0
C
C             DO NOT SMOOTH
      ISM=0
C
        CALL OUTSIG2P(NDATA,NWORK,MB,LABSPFH,GAMBOT,GAMTOP,ISM)
C
C--------------------------------------------------------
C
C          MOVE HUMIDITY FIELDS (SIGMA) TO OUTPUT GRID
C              USING THE COMPUTED  GO TO ROUTINE
      NFROM=2
      NTO=3
C          (WE PUT Q IN S( JSCR3OUT(3), REPLACING REL HUMIDITY )
      IRET=2
      GO TO 900
  290 CONTINUE
C
C
C--------------------------------------------------------
C               SPECIFIC HUMIDITY ON SIGMA SURFACES
C
      IADSIG=JSCR3OUT(3)
      IADSCR=JSCR2(1)
C
        CALL OUTSIGMA( S(IADSIG), S(IADSCR), LABSPFH )
C
C--------------------------------------------------------
C
C--------------------------------------------------------
C                         LIFTED INDEX
C
C           SATDEL IS THE FRACTIONAL VARIATION OF SATURATION
C           USED IN THE FORECAST CODE( E.G. SATDEL = .05 )
C
           CALL OUTLIFT
C
C--------------------------------------------------------
C
C--------------------------------------------------------
C                        MOISTURE CONVERGENCE
      DO 281 N=1,NOUTVBLS
      NCARD=N
      IF( LQTYPE(N).EQ.LABMCV .AND. LSTYPE(N).EQ.LABSIG) GO TO 282
  281 CONTINUE
C              NO CARD
      GO TO 283
C
  282 IF(LEVELS(1,NCARD) .EQ. 1 ) CALL OUTMCONV(S,IN,SIGMC1,SIGMC2,
     1  NCARD)
C
C              EXIT SPOT
  283 CONTINUE
C
C--------------------------------------------------------
C
C--------------------------------------------------------
C      HEIGHT OF SIGMA AND OF PRESSURE SURFACES, PLUS
C                   SEA-LEVEL PRESSURE
C
C    HGTS OF SIGMA SFCS ON OUTPUT GRID ARE NEEDED FOR HGT OF
C      FREEZING LEVEL, TROPOPAUSE VBLS, AND FD WINDS AND TEMPS.
C
      IWANTHGT=IFRZDO + IFDDO + ITROPDO
C          CHECK FOR HEIGHTS OF PRESSURE SURFACES
      NCARDHP=0
      NWANTZP = 0
      DO 291 N=1,NOUTVBLS
      IF(LQTYPE(N).NE.LABHGT .OR. LSTYPE(N).NE.LABPRES) GO TO 291
C          THE CARD WE ARE LOOKING FOR
      NCARDHP=N
      NWANTZP = 0
      DO 4901 IQ2 = 1, 20
         NWANTZP = NWANTZP + LEVELS(IQ2,N)
4901  CONTINUE
      GO TO 292
C
  291 CONTINUE
C
C          WHAT ABOUT SEA-LEVEL PRESSURE?
  292 NCDPMSL = 0
      NCDPMSLA = 0
      NWANTPSL = 0
      NTWO = 0
      DO 295 N = 1,NOUTVBLS
C           CHECK FOR SEA-LEVEL PRESSURE
      IF( LQTYPE(N).NE.LABPRES .OR. LSTYPE(N).NE.LABMSL) GO TO 295
C         SEA LEVEL PRESSURE CARD, BUT WHICH TYPE
      IF(DESCRIPT(N) .NE. PMSL ) GO TO 293
C           IT IS FOR THE UNADJUSTED PRESSURE. RECORD FINDING CARD
      NTWO = NTWO + 1
      NCDPMSL = N
      IF( LEVELS(1,N) .EQ. 1 ) NWANTPSL = 1
      GO TO 294
C            CARD MUST BE FOR ADJUSTED PRESSURE
  293 NTWO = NTWO + 1
      NCDPMSLA = N
      IF ( LEVELS(1,N) .EQ. 1 ) NWANTPSL = 1
C              HAVE BOTH CARDS BEEN FOUND
  294 IF( NTWO .EQ. 2 ) GO TO 296
C        END OF CARD LOOP
  295 CONTINUE
C         NALL WILL DETERMINE NEED TO CALL THE HYDROSTATIC CODE
  296 NALL = IWANTHGT + NWANTZP +NWANTPSL
C
C
      IF( NALL .GT. 0 ) CALL OUTHYDRO(NCARDHP,NCDPMSL,NCDPMSLA)
C
C
C
C--------------------------------------------------------
C
C          IF OUTHYDRO HAS BEEN CALLED,
C          WE NOW HAVE THE FOLLOWING ARRAYS OF DATA
C          1) FOR ALL NEEDED NGM GRIDS, WITH VALID DATA FOR J=J1,J2,,
C            IN S(JSCR3NGM(NN,1) )         TAU(SIGMA)
C               S(JSCR3NGM(NN,2) )         HGT(SIGMA)
C               S(JSCR3NGM(NN,3) )           Z(SIGMA)
C          2) ON THE OUTPUT GRID
C             IN S(JSCR3OUT(1) )          TEMP(SIGMA)
C                S(JSCR3OUT(2) )             Z(SIGMA)
C                S(JSCR3OUT(3) )             Q(SIGMA)
C                S(JSCR3OUT(4) )           HGT(SIGMA)
C            AND
C         3) IN S(MZGNDOUT)               Z AT GROUND.
C
C-------------------------------------------------------
C               HEIGHT OF FREEZING LEVEL
C          (CAN SKIP THIS IF IFRZDO=0)
      IF( IFRZDO .EQ. 0 ) GO TO 310
C          CHECK FOR THIS CARD
      DO 300 N=1,NOUTVBLS
      NCARD=N
      IF( LSTYPE(N) .NE. LABTEMP ) GO TO 300
      IF( LQTYPE(N) .EQ. LABHGT  ) GO TO 305
  300 CONTINUE
C           NO CARD
      GO TO 310
C         FOUND CARD, IS THERE A ONE IN LEVELS?
  305 IF( LEVELS(1,NCARD) .EQ. 0 ) GO TO 310
C           GET THE HEIGHT, FOLLOWING THE SCHEME USED
C           EARLIER TO GET THE RELATIVE HUMIDITY AT THIS LEVEL.
C
C          PUT RESULT IN S(MSOUT2) FOR PACKER
C          GATHER ORIGINS FOR  Z  AND  HGT  ABOVE FREEZING LEVEL.
      IADZ=JSCR3OUT(2)-1
      IADH=JSCR3OUT(4)-1
C          NOMINAL LENGTH
      LEN=1
C
C           HGT  (ABOVE) INTO S2D
C*****  Code Expanded From Routine:  RDHGATHR
      DO 77073 I6X = 1, IJOUT
         S(I6X+JSCR2(2)-1) = S(IGATHFZ(I6X)+IADH)
77073 CONTINUE
C*****  End of Code Expanded From Routine:  RDHGATHR
C*****  Code Expanded From Routine:  RDHGATHR
      DO 77074 I7X = 1, IJOUT
         S(I7X+JSCR2(1)-1) = S(IGATHFZ(I7X)+IADH-IJOUT)
77074 CONTINUE
C*****  End of Code Expanded From Routine:  RDHGATHR
C          HGT(ABV) - HGT(BEL) INTO S2D
      DO 89470 IQ2W6E=1,IJOUT
         S(JSCR2(2)+IQ2W6E-1)=S(JSCR2(2)+IQ2W6E-1)-S(JSCR2(1)+IQ2W6E-1
     *   )
89470 CONTINUE
C          Z BELOW INTO S3D
C*****  Code Expanded From Routine:  RDHGATHR
      DO 77075 I8X = 1, IJOUT
         S(I8X+JSCR2(3)-1) = S(IGATHFZ(I8X)+IADZ-IJOUT)
77075 CONTINUE
C*****  End of Code Expanded From Routine:  RDHGATHR
C*****  Code Expanded From Routine:  RDHGATHR
      DO 77076 I9X = 1, IJOUT
         S(I9X+MSOUT2-1) = S(IGATHFZ(I9X)+IADZ)
77076 CONTINUE
C*****  End of Code Expanded From Routine:  RDHGATHR
C          DENOMINATOR INTO S4D
      DO 89480 IQ2W6E=1,IJOUT
         S(MSOUT2+IQ2W6E-1)=S(MSOUT2+IQ2W6E-1)-S(JSCR2(3)+IQ2W6E-1)
89480 CONTINUE
C          ZFREEZE - Z(BEL)
      DO 89490 IQ2W6E=1,IJOUT
         S(JSCR2(3)+IQ2W6E-1)=S(MZFR+IQ2W6E-1)-S(JSCR2(3)+IQ2W6E-1)
89490 CONTINUE
C        SET BIT VECTOR =1 FOR POINTS ABOVE SIGMA LEVEL 1.
      DO 89500 IQ2W6E=1,IJOUT
         BITS(MB1+IQ2W6E-1)=IGATHFZ(IQ2W6E).GT.IJOUT
89500 CONTINUE
C          GET THE SECOND TERM
      DO 89510 IQ2W6E=1,IJOUT
         S(JSCR2(3)+IQ2W6E-1)=S(JSCR2(3)+IQ2W6E-1)*S(JSCR2(2)+IQ2W6E-1
     *   )
89510 CONTINUE
      DO 89520 IQ2W6E=1,IJOUT
       IF ( BITS(MB1+IQ2W6E-1) ) THEN
         S(JSCR2(3)+IQ2W6E-1)=S(JSCR2(3)+IQ2W6E-1)/S(MSOUT2+IQ2W6E-1)
       END IF
89520 CONTINUE
C          RESULTS INTO MSOUT2 FOR PACKER
C          FIRST ASSUME LEVEL IS AT OR BELOW K=1.
      DO 89530 IQ2W6E=1,IJOUT
         S(MSOUT2+IQ2W6E-1)=S(JSCR3OUT(3)+IQ2W6E-1)
89530 CONTINUE
C          USE INTERPOLATED RESULT ABOVE LAYER K=1.
      DO 89540 IQ2W6E=1,IJOUT
       IF ( BITS(MB1+IQ2W6E-1) ) THEN
         S(MSOUT2+IQ2W6E-1)=S(JSCR2(3)+IQ2W6E-1)+S(JSCR2(1)+IQ2W6E-1)
       END IF
89540 CONTINUE
C
C
      LABQTYPE=LABHGT
      LABSSUB1=LABTEMP
      S1VALUE=273.16E0
      CALL OUTNULAB
C
C
C  SET UP PDS INFO
C
      CALL LAB2PDS(LABEL84,IDGRBE)
      IDGRBE(7) =   0
      IDGRBE(8) =   7
      IDGRBE(9) =   4
      IDGRBE(10) =  0
      IDGRBE(11) =  0
      IDGRBE(18) =  LABEL84(3)
      IDGRBE(19) =  0
      IDGRBE(20) =  0
C
C          (NOTE THAT WE HAVE NOT SMOOTHED)
C
C                     GO TO THE PACKER CODE
c     CALL OUTPACK(S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
c    1             LABEL84,IOUTUNIT )
      CALL GRIBITN (S(MSOUT2),IJOUT,S(MSOUT1),DESCRIPT(NCARD),
     1             IDGRBE,IOUTGRIB,LABEL84 )
C
  310 CONTINUE
C
C        ARRAYS FOR  IGATHFZD  AND  ZFREEZED  ARE NOW FREE.
C
C--------------------------------------------------------
C
C          START WORK ON VELOCITY VARIABLES.  FIRST PUT
C          U ( AT HU PTS) AND V ( AT HV PTS ) FOR ALL NEEDED
C          NGM GRIDS INTO S(JSCR3NGM(NN,1)) AND S(JSCR3NGM(NN,2)).
C
      DO 370 NN=1,NUMGDREQ
      NG=NGRIDATA(NN)
      IM=IMG(NG)
      JM=JMG(NG)
      IJ=IM*JM
C          GET (1/H) ARRAYS TO FACTOR OUT H IN HU AND HV.
C          ADDRESS OF (1/H) AT H POINTS.
      IADHR=JHREC(NG)
C          1/H AT U PTS.  FIRST ROWS J=1,JM-1.
      LEN1=IJ-IM
      DO 89550 IQ2W6E=1,LEN1
         S(JSCR2(1)+IQ2W6E-1)=.5E0*(S(IADHR+IQ2W6E-1)+S(IADHR+IM+
     *   IQ2W6E-1))
89550 CONTINUE
C          FILL OUT TOP ROW WITH EXTRAPOLATED AVG OF (1/H).
      IAD1=JSCR2(1) + LEN1
      IAD2=IADHR + LEN1
      IAD3=IADHR + (JM-2)*IM
      DO 89560 IQ2W6E=1,IM
         S(IAD1+IQ2W6E-1)=1.5E0*S(IAD2+IQ2W6E-1)-.5E0*S(IAD3+IQ2W6E-1)
89560 CONTINUE
C          (1/H) AT V POINTS
      DO 89570 IQ2W6E=1,IJ
         S(JSCR2(2)+IQ2W6E-1)=.5E0*(S(IADHR+IQ2W6E-1)+S(IADHR+IQ2W6E))
89570 CONTINUE
C          MUST CORRECT THE I=IM POINTS.
      IADHR1=IADHR-1
      IAD1=JSCR2(2)-1
        DO 350 J=1,JM
        IADHR1=IADHR1+IM
        IAD1=IAD1+IM
        S(IAD1)=1.5E0*S(IADHR1) - .5E0*S(IADHR1-1)
  350   CONTINUE
C          CAN NOW CONVERT HU AND HV TO U AND V.
      IADHU=IADDRG(1,NG)-IJ
      IADHV=IADDRG(2,NG)-IJ
      IADU=JSCR3NGM(NN,1)-IJ
      IADV=JSCR3NGM(NN,2)-IJ
        DO 360 K=1,KM
        IADHU=IADHU+IJ
        IADHV=IADHV+IJ
        IADU=IADU+IJ
        IADV=IADV+IJ
      DO 89580 IQ2W6E=1,IJ
         S(IADU+IQ2W6E-1)=S(JSCR2(1)+IQ2W6E-1)*VBL(IADHU+IQ2W6E-1)
         S(IADV+IQ2W6E-1)=S(JSCR2(2)+IQ2W6E-1)*VBL(IADHV+IQ2W6E-1)
89580 CONTINUE
  360   CONTINUE
C
  370 CONTINUE
C
C$$$$$$$$$ DIAGNOSTICS FOR VERTICAL DIFFUSION AND HORIZ SMOOTHING
C
      IF( KGTYPE .NE. NGDSPEC ) GO TO 369
C
  369 CONTINUE
C
C--------------------------------------------------------
C           OMEGA ON PRESSURE SURFACES AND/OR
C               SURFACE PRESSURE TENDENCY
C
C     ( IF DATA CARDS CONTAIN A REQUEST FOR OMEGA ON SIGMA
C       SURFACES, A VALUE OF NOMEGASG .GT. 0 WILL BE RETURNED.)
C
      CALL OUTOMEGA(NOMEGASG)
C
C-------------------------------------------------------
C
C
C-------------------------------------------------------
C                  OMEGA ON SIGMA SURFACES
C
      IF(NOMEGASG .LE. 0 ) GO TO 372
C          FIRST PUT OMEGA ON AN OUTPUT (SIGMA) GRID.
      NFROM=3
      NTO=3
      IRET=5
      GO TO 900
  371 CONTINUE
C
      IADSIG=JSCR3OUT(3)
      IADSCR=JSCR2(1)
          CALL OUTSIGMA(S(IADSIG),S(IADSCR), LABVVEL )
C
  372 CONTINUE
C
C-------------------------------------------------------
C
C
C          INTERPOLATE U AND V TO H POINTS ON THE NGM GRIDS.
C          (U WILL NOT BE VALID FOR J=1 OR JM, AND V WILL NOT BE
C          VALID FOR I=1 OR IM.)
C
      DO 390 NN=1,NUMGDREQ
      NG=NGRIDATA(NN)
      IM=IMG(NG)
      JM=JMG(NG)
      IJ=IM*JM
      IADU1=JSCR3NGM(NN,1)-IJ
      IADU2=JSCR3NGM(NN,2)-IJ
      IADV1=IADU2
      IADV2=JSCR3NGM(NN,3)-IJ
        DO 380 K=1,KM
        IADU1=IADU1+IJ
        IADU2=IADU2+IJ
        IADV1=IADU2
        IADV2=IADV2+IJ
      DO 89780 IQ2W6E=1,IJ
       S(IADV2+IQ2W6E-1)=.5E0*(S(IADV1+IQ2W6E-2)+S(IADV1+IQ2W6E-1))
89780 CONTINUE
      DO 89781 IQ2W6E=1,IJ
       S(IADU2+IQ2W6E-1)=.5E0*(S(IADU1-IM+IQ2W6E-1)+S(IADU1+IQ2W6E-1))
89781 CONTINUE
  380   CONTINUE
C
  390 CONTINUE
C            DO WE NEED TO ROTATE VELOCITY TO OUTPUT GRID DIRECTION?
C            CAN SKIP IF ANGLE BETWEEN GRIDS IS SMALL ENOUGH
      C1=ABS(DLAMNGM-DLAMOUT)
      IF( C1 .LE. 0.1E0 ) GO TO 420
C         MUST DO IT,,,,  THE FORMULAS ARE
C     U(OUT)=COSOUT * U(NGM)  - SINOUT * V(NGM)
C     V(OUT)=COSOUT * V(NGM)  + SINOUT * U(NGM)
C
      DO 410 NN=1,NUMGDREQ
      NG=NGRIDATA(NN)
      IM=IMG(NG)
      JM=JMG(NG)
      IJ=IM*JM
      IADU=JSCR3NGM(NN,2)-IJ
      IADV=JSCR3NGM(NN,3)-IJ
        DO 400 K=1,KM
        IADU=IADU+IJ
        IADV=IADV+IJ
      DO 89800 IQ2W6E=1,IJ
         S(JSCR2(1)+IQ2W6E-1)=COSOUT*S(IADU+IQ2W6E-1)-SINOUT*S(IA
     *   DV+IQ2W6E-1)
         S(IADV+IQ2W6E-1)=COSOUT*S(IADV+IQ2W6E-1)+SINOUT*S(IADU+IQ2W6E
     *   -1)
         S(IADU+IQ2W6E-1)=S(JSCR2(1)+IQ2W6E-1)
89800 CONTINUE
  400   CONTINUE
C
  410 CONTINUE
C
  420 CONTINUE
C
C-------------------------------------------------------
C          U AND V ON PRESSURE SURFACES
C
C
C       (SEE IF WE CAN SKIP THIS AND THE ENSUING VORTICITY)
      NKARDU=0
      NKARDV=0
      NKARDZ=0
      NUFD=0
      NVFD=0
      NZFD=0
C
      DO 421 N=1,NOUTVBLS
      IF( LSTYPE(N) .NE. LABPRES) GO TO 421
      IF( LQTYPE(N) .EQ. LABUGRD) THEN
        NKARDU=N
        NUFD=1
        GO TO 421
      END IF
      IF(LQTYPE(N) .EQ. LABVGRD) THEN
        NKARDV=N
        NVFD=1
        GO TO 421
      END IF
      IF( LQTYPE(N) .EQ. LABABSV ) THEN
        NKARDZ=N
        NZFD=1
      END IF
  421 CONTINUE
C
      NMUST=0
      IF( NUFD .EQ. 1) THEN
          IXXX = 0
          DO 5701 IQ2 = 1, LMOUT
             IXXX = IXXX + LEVELS(IQ2,NKARDU)
5701      CONTINUE
          NMUST = IXXX
      END IF
      IF( NVFD .EQ. 1) THEN
          IXXX = 0
          DO 5702 IQ2 = 1, LMOUT
             IXXX = IXXX + LEVELS(IQ2,NKARDV)
5702      CONTINUE
          NMUST = NMUST + IXXX
      END IF
      IF( NZFD .EQ. 1) THEN
          IXXX = 0
          DO 5703 IQ2 = 1, LMOUT
             IXXX = IXXX + LEVELS(IQ2,NKARDZ)
5703      CONTINUE
          NMUST = NMUST + IXXX
      END IF
C         CAN SKIP TO END OF ABSOLUTE VORTICITY IF NMUST IS ZERO
      IF( NMUST .EQ. 0 ) GO TO 429
C
C         SINCE AT LEAST ONE LEVEL OF AT LEAST ONE OF THESE 3 VARIABLES
C         IS WANTED, WE WILL PROCEED( HOWEVER WITHOUT TRYING TO
C         REDUCE THE LEVELS OF U AND V IN THE FIRST STEP OF THE
C         DO-LOOP THAT NOW FOLLOWS.)
C
C
C        SCRATCH WORK SPACE
      NWORK=1
      MB=MB1
C          EXTRAPOLATION COEFFS AT BOTTOM AND TOP OF ATMOSPHERE
      GAMBOT=0.E0
      GAMTOP=0.E0
C
C          WILL FIRST PUT U(P,OUTPUT GRID) INTO S(JSCR3OUT(5) )
C     FOR ALL  LMOUT  LEVELS, AND OUTPUT THE DESIRED LEVELS.  WILL
C     THEN REPEAT THIS FOR V(P,OUTPUT GRID) INTO S(JSCR3OUT(3) )
C     AND OUTPUT IT.  (THE TWO 3-D PRESSURE ARRAYS OF U AND V
C     ARE THEN AVAILABLE TO COMPUTE VORTICITY IN NEXT STEP.)
C
      NSIG=2
      NTO=5
      LQQTYPE=LABUGRD
      NKARD=NKARDU
      MFOUND=NUFD
C
      DO 428 KVEL=1,2
C
C
      CALL OUTDAT2P(NSIG,NWORK,MB,GAMBOT,GAMTOP,NTO)
C
C          SMOOTH THIS VELOCITY FIELD
      IAD= JSCR3OUT(NTO)
        DO 422 L=1,LMOUT
                 CALL OUTSMOO( IAD )
        IAD = IAD + IJOUT
  422   CONTINUE
C
C          IS OUTPUT OF U ( OR V ) WANTED????
        IF(MFOUND .EQ. 0 ) GO TO 427
C          HAVE THE RIGHT DATA CARD,, LOOK FOR LEVELS
        DO 426 L=1,LMOUT
        IF( LEVELS(L,NKARD) .EQ. 0 ) GO TO 426
C          THIS LEVEL IS WANTED, GET PRESSURE IN MBS.
        S1VALUE=ANINT( 1000.E0*PLOUT(L) )
        LABQTYPE=LQQTYPE
        LABSSUB1=8
C          CAN NOW UPDATE THE TABLE  LABEL84
            CALL OUTNULAB
C               ADDRESS OF FIELD TO BE OUTPUT
        IADVEL=JSCR3OUT(NTO) + (L-1)*IJOUT
C
C
C  SET UP PDS INFO
C
      CALL LAB2PDS(LABEL84,IDGRBE)
      IDGRBE(7) =   0
      IF(KVEL.EQ.1) IDGRBE(8) =  33
      IF(KVEL.EQ.2) IDGRBE(8) =  34
      IDGRBE(9) =   100
      IDGRBE(10) =  0
      IARG = LABEL84(6)
      IDGRBE(11) =  LABEL84(5) * 10.**IARG
      IDGRBE(18) =  LABEL84(3)
      IDGRBE(19) =  0
      IDGRBE(20) =  0

c     do k = 1, 25
c       print *,' wind press output ',k,label84(k),idgrbe(k)
c     enddo

C
C          (NOTE THAT WE HAVE NOT SMOOTHED)
C
C                     GO TO THE PACKER CODE
c     CALL OUTPACK(S(IADVEL),IJOUT,S(MSOUT1),DESCRIPT(NKARD),
c    1             LABEL84,IOUTUNIT )
      CALL GRIBITN (S(IADVEL),IJOUT,S(MSOUT1),DESCRIPT(NKARD),
     1             IDGRBE,IOUTGRIB,LABEL84 )
C
C            END OF OUTPUT LEVEL LOOP
  426   CONTINUE
C          PREPARE TO PUT V(P,OUTPUT) INTO S(JSCR3OUT(3) )
  427 NSIG=3
      NTO=3
      LQQTYPE=LABVGRD
      NKARD=NKARDV
      MFOUND=NVFD
C
  428 CONTINUE
C
C-----------------------------------------------------------
C
C-----------------------------------------------------------
C             ABSOLUTE VORTICITY ON PRESSURE SURFACES
C
C            SKIP THIS IF NO ABSOLUTE VORTICITY CARD WAS FOUND
       IF( NZFD .EQ. 0 ) GO TO 429
C
C          SR OUTABVOR WILL COMPUTE( AND OUTPUT ) THIS USING
C          THE OUTPUT P-LEVEL ARRAYS OF U AND V JUST STORED
C          IN THE LAST STEP( ON THE OUTPUT GRID)  .
C
      NU=5
      NV=3
              CALL OUTABVOR( NU, NV ,NKARDZ )
C
C           ENTRY WHEN U(P), V(P), AND VORT(P) COULD ALL BE SKIPPED
  429 CONTINUE
C
C
C-------------------------------------------------------
C
C          INTERPOLATE U AND V ON SIGMA TO THE OUTPUT GRID
C          IN JSCR3OUT(5) AND JSCR3OUT(3),RESPECTIVELY.
      NFROM=2
      NTO=5
      IRET=3
      GO TO 900
  430 CONTINUE
      NFROM=3
      NTO=3
      IRET=4
      GO TO 900
  440 CONTINUE
C
C
C---------------
C
C-------------------------------------------------------
C            ANEMOMETER LEVEL WINDS
C
      DO 444 N=1,NOUTVBLS
      NCARD = N
      IF( LQTYPE(N) .NE. LABUGRD ) GO TO 444
      IF( LSTYPE(N) .NE. LABDIST ) GO TO 444
C                 THE RIGHT CARD
      GO TO 445
  444 CONTINUE
C                NO CARD
      GO TO 448
C
  445 IF(LEVELS(1,NCARD) .NE. 1  )  GO TO 448
C               ANEMOMETER WINDS ARE DESIRED
C           CONSTANTS NEEDED OVER LAND
      F1LAND = SQRT(287.05E0 * 288.E0 )  /  (10.E0 * 0.4E0 )
      CLOGAN = ALOG(10.E0)
C        CONSTANT  NEEDED OVER WATER  (ZL1 IS HEIGHT OF VBLS IN LYR 1 )
      ZL1 = 287.05E0 * 288.E0 * DELSIG(1) / ( 2.E0 * 9.8E0 )
      CLOGA1 = ALOG(10.E0 / ZL1 )
C
      DO 446 NN = 1,NUMGDREQ
      NG = NGRIDATA(NN)
      IM = IMG(NG)
      JM = JMG(NG)
      IJ = IM * JM
      IADF = JADDFNGM(NG)
C              FIRST JOB IS TO CONVERT EXCHANGE COEFFICIENT TO THE
C              DRAG COEFFICIENT. GET SPEED IN LAYER ONE
      DO 89830 IQ2W6E=1,IJ
         S(JSCR2(1)+IQ2W6E-1)=S(JSCR3OUT(3)+IQ2W6E-1)*S(JSCR3OUT(
     *   3)+IQ2W6E-1)
         S(JSCR2(2)+IQ2W6E-1)=S(JSCR3OUT(5)+IQ2W6E-1)*S(JSCR3OUT(
     *   5)+IQ2W6E-1)
         S(JSCR2(1)+IQ2W6E-1)=S(JSCR2(1)+IQ2W6E-1)+S(JSCR2(2)+IQ2W6E-1
     *   )
         S(JSCR2(2)+IQ2W6E-1)=SQRT( S(JSCR2(1)+IQ2W6E-1) )
89830 CONTINUE
C            OVER LAND MUST MAKE THIS AT LEAST 2 M/SEC
C              ( SEE USE OF AMINSP IN SR SFCEXCH )
      DO 89870 IQ2W6E=1,IJ
         BITS(MB1+IQ2W6E-1)=S(JSCR2(2)+IQ2W6E-1).LT.2.E0
         BITS(MB1+IQ2W6E-1)=BITS(MB1+IQ2W6E-1).AND..NOT.BITSEA(IQ2W6E,
     *   NG)
89870 CONTINUE
      DO 89890 IQ2W6E=1,IJ
       IF ( BITS( MB1+IQ2W6E-1) ) THEN
         S(JSCR2(2)+IQ2W6E-1)=2.E0
       END IF
89890 CONTINUE
C          ALLOW FOR VBL SFC PRESSURE IN DENSITY
      DO 89900 IQ2W6E=1,IJ
         S(JSCR2(2)+IQ2W6E-1)=S(JSCR2(2)+IQ2W6E-1)*VBL(IADDRG(5,NG)+
     *   IQ2W6E-1)
         S(JSCR2(1)+IQ2W6E-1)=VBL(IADDRG(19,NG)+IQ2W6E-1)/S(JSCR2
     *   (2)+IQ2W6E-1)
         S(JSCR2(1)+IQ2W6E-1)=SQRT( S(JSCR2(1)+IQ2W6E-1) )
89900 CONTINUE
C        SQ ROOT OF DRAG COEFF,  DIVIDED BY VON KARMAN NUMBER(0.4)
      DO 89930 IQ2W6E=1,IJ
         S(JSCR2(1)+IQ2W6E-1)=S(JSCR2(1)+IQ2W6E-1)*F1LAND
89930 CONTINUE
C           FOR LAND VALUES, NEED LOG OF ROUGHNESS LENGTH
      DO 89940 IQ2W6E=1,IJ
         S(JSCR2(2)+IQ2W6E-1)=ALOG(VBL(IADDRG(20,NG)+IQ2W6E-1))
         S(JSCR2(2)+IQ2W6E-1)=CLOGAN-S(JSCR2(2)+IQ2W6E-1)
         FNGM(IADF+IQ2W6E-1)=S(JSCR2(2)+IQ2W6E-1)*S(JSCR2(1)+IQ2W6E-1)
89940 CONTINUE
C             MUST USE LOG PROFILE OVER OCEAN SINCE OCEANIC
C             ROUGHNESS LENGTH IS GIVEN BY CHARNOCK FORMULA
C             AND NOT BY THE NOMINAL VALUES  IN VBL(IADDRG(19,NG) )
      DO 89970 IQ2W6E=1,IJ
         S(JSCR2(2)+IQ2W6E-1)=CLOGA1*S(JSCR2(1)+IQ2W6E-1)
89970 CONTINUE
      DO 89980 IQ2W6E=1,IJ
       IF ( BITSEA(IQ2W6E,NG) ) THEN
         FNGM(IADF+IQ2W6E-1)=S(JSCR2(2)+IQ2W6E-1)+1.E0
       END IF
89980 CONTINUE
C
  446 CONTINUE
C
C     INTERPOLATE THE ANEMOMETER FACTOR TO OUTPUT GRID IN S(JSCR2(1) )
            CALL OUTHORIZ(IN(MIILL),IN(MIIUL),S(MSA),S(MSB),S(MSC),
     *                    S(MSD),S(MSOUT1),S(JSCR2(1)))
C          CAN NOW DO THE OUTPUT OF U AND V AT ANEMOMETER HEIGHT
      LABSSUB1 = LABDIST
      S1VALUE = 10.E0
C         FIRST DO U ( U(SIGMA, OUTPUT) IS IN S(JSCR3OUT(5) ).
      LABQTYPE = LABUGRD
      IADAN = 5
C
      DO 447 NN=1,2
      DO 89990 IQ2W6E=1,IJOUT
         S(JSCR2(2)+IQ2W6E-1)=S(JSCR3OUT(IADAN)+IQ2W6E-1)*S(JSCR2
     *   (1)+IQ2W6E-1)
89990 CONTINUE
C
         CALL OUTNULAB
C
C  SET UP PDS INFO
C
      CALL LAB2PDS(LABEL84,IDGRBE)
      IDGRBE(7) =   0
      IF(NN.EQ.1) IDGRBE(8) =  33
      IF(NN.EQ.2) IDGRBE(8) =  34
      IDGRBE(9) =   105
      IDGRBE(10) =  0
      IDGRBE(11) =  10
      IDGRBE(18) =  LABEL84(3)
      IDGRBE(19) =  0
      IDGRBE(20) =  0
C
C          (NOTE THAT WE HAVE NOT SMOOTHED)
C
C                     GO TO THE PACKER CODE
c     CALL OUTPACK(S(JSCR2(2)),IJOUT,S(MSOUT2),DESCRIPT(NCARD),
c    1             LABEL84,IOUTUNIT )
      CALL GRIBITN (S(JSCR2(2)),IJOUT,S(MSOUT2),DESCRIPT(NCARD),
     1             IDGRBE,IOUTGRIB,LABEL84 )
 
C            PREPARE FOR V
      LABQTYPE = LABVGRD
      IADAN = 3
C
  447 CONTINUE
C
  448 CONTINUE
C
C---------------
C
C-------------------------------------------------------
C            U(OUTPUT GRID) ON SIGMA SURFACES
C
        CALL OUTSIGMA( S( JSCR3OUT(5) ), S( JSCR2(1) ), LABUGRD )
C
C-------------------------------------------------------
C
C-------------------------------------------------------
C              V (OUTPUT GRID) ON SIGMA SURFACES
C
        CALL OUTSIGMA( S( JSCR3OUT(3) ), S( JSCR2(1) ), LABVGRD )
C
C-------------------------------------------------------
C
C ------------------------------------------------------
C          THE FD TEMPS, U AND V VELOCITIES.
      IF( IFDDO .EQ. 0 ) GO TO 450
C
           CALL OUTFDTUV
C
  450 CONTINUE
C
C--------------------------------------------------------
C
C--------------------------------------------------------
C                THE TROPOPAUSE VARIABLES
C
      IF( ITROPDO .EQ. 0 ) GO TO 500
C
           CALL OUTRPAUS
C
  500 CONTINUE
C
C-------------------------------------------------------
C
C-------------------------------------------------------
C
C
C
C
C--------------PRINT OUT 6-COLUMN RESULTS IF IPRCOL=9
      IF ( 1 .EQ. 1 ) GOTO 940
      IF(NUMPROF .EQ. 0 ) GO TO 940
      IF(KGTYPE .NE. NGDSPEC ) GO TO 940
      IF(IPRCOL .NE. 9 ) GO TO 940
C           HAVE FINISHED, PRINT OUT
      PRINT 901, NUMPROF
  901 FORMAT(1H0,40X,'FORECAST COLUMNS AT ',I3,' LOCATIONS')
C
C
      DO 930 N=1,NUMPROF
      PRINT 904,DESCRP(N),ALATPR(N),ALONPR(N),XSAVE(N),YSAVE(N)
  904 FORMAT(//1H1,10X,A24,' LOCATED AT LAT ',F6.2,
     1         ' AND LONG ',F7.2,
     2         ' AT POINT (',F6.2,',',F6.2,')')
      PRINT 905,ITIMCOL
  905 FORMAT(1H0,2X,'PRESS',2X,9(I4,' HRS',5X) )
C
        DO 911 KK=1,KM
        K = KM - KK + 1
C            USE SFC PRESS AT ZERO HOURS TO DEFINE P(SIGMA)
        IPPP = NINT( PRESS(K) * HCOL(N,1) )
C                 PRINT TEMPERATURE AND RELATIVE HUMIDITY
C            CONVERT REL HUMIDITY TO INTEGERS
          DO 9906 NT=1,9
          ISPD(NT) = INT( RCOL(K,N,NT) )
 9906     CONTINUE
        PRINT 906, IPPP, (TCOL(K, N, NT), ISPD(NT), PERCENT, NT=1,9)
  906   FORMAT(1H0, 2X, I5, 9(F7.1, ' *', I3, A1) )
C             CONVERT U,V TO SPEED AND DIRECTION
          DO 909 NT=1,9
          U=UCOL(K,N,NT)
          V=VCOL(K,N,NT)
C***********************************************************************
C
C              THE DIRECTION IS CALCULATED BY A METHOD THAT ALLOWS
C              FOR THE CASE OF A U WIND COMPONENT OF ZERO.
C              THE ORIGINAL VERSION OF THE CODE DID NOT DO THIS.
C***********************************************************************
C****          NOTE THAT THE WINDS ARE NOT ROTATED TO EARTH COORDINATES.
C***********************************************************************
          IF ((U .EQ. 0.0E0) .AND. (V .EQ. 0.0E0)) THEN
             DD = 0.0E0
          ELSE
C              DETERMINE THE WIND DIRECTION IN THE METEOROLOGICAL
C              CONVENTION IN DEGREES.
             DD = 270.E0 - ((180.E0 / PI) * ATAN2(V, U))
C
C              ALLOW THE DIRECTION TO RANGE ONLY FROM 0 TO 360 DEGREES.
             IF (DD .GT. 360.E0) DD = DD - 360.E0
C
          END IF
C
C***********************************************************************
C
          SPD = SQRT(U*U + V*V )
          ISPD(NT) = INT(SPD)
          IDIR(NT) = INT(DD)
  909     CONTINUE
C               PRINT SPEED AND DIRECTION
        PRINT 910,(IDIR(NT),ISPD(NT),NT=1,9 )
  910   FORMAT(1H ,8X,9(2X,I4,1X,I4,2X) )
C
  911   CONTINUE
C                 PRINT SFC PRESSURE IN MBS
      PRINT 912,(HCOL(N,I),I=1,9)
  912 FORMAT(1H0,2X,'SFC PRESS',9(F6.1,7X) )
C                 PRINT PRECIPITATION AFTER CONVERTING TO 6HR AMTS
      PRECOL(N,3) = PRECOL(N,3) -PRECOL(N,2)
      PRECOL(N,5) = PRECOL(N,5) -PRECOL(N,4)
      PRECOL(N,7) = PRECOL(N,7) -PRECOL(N,6)
      PRECOL(N,9) = PRECOL(N,9) -PRECOL(N,8)
      PRINT 913,(PRECOL(N,I),I=1,9)
  913 FORMAT(1H ,2X,'PRECIP   ',9(F5.2,8X) )
C            PRINT ADDITIONAL PHYSICS OUTPUT
      PRINT 914,( Q1COL(N,I),I=1,9)
  914 FORMAT(1H0,2X,'LYR 1 Q',9(E12.3,1X  ) )
      PRINT 915,( CLDHI(N,I),I=1,9)
  915 FORMAT(1H ,2X,' HI CLD',9(F6.1,7X) )
      PRINT 916,( CLDME(N,I),I=1,9)
  916 FORMAT(1H ,2X,'MED CLD',9(F6.1,7X) )
      PRINT 917,( CLDLO(N,I),I=1,9)
  917 FORMAT(1H ,2X,'LOW CLD',9(F6.1,7X) )
      PRINT 918,(TGDCOL(N,I),I=1,9)
  918 FORMAT(1H0,2X,'GD TEMP',9(F6.1,7X) )
      PRINT 919,(QGDCOL(N,I),I=1,9)
  919 FORMAT(1H ,2X,'GND Q  ',9(E12.3,1X  ) )
      PRINT 920,(AVMCOL(N,I),I=1,9)
  920 FORMAT(1H ,2X,'MOISTAV',9(F7.2,6X ) )
      PRINT 921,(SEXCOL(N,I),I=1,9)
  921 FORMAT(1H ,2X,'EXCHCOF',9(E12.3,1X  ) )
      PRINT 922,(SENCOL(N,I),I=1,9)
  922 FORMAT(1H0,2X,'SENS HF',9(F6.1,7X) )
      PRINT 923,(EVPCOL(N,I),I=1,9)
  923 FORMAT(1H ,2X,'LAT  HF',9(F6.1,7X) )
      PRINT 924,(SWDCOL(N,I),I=1,9)
  924 FORMAT(1H ,2X,'DSOLGND',9(F6.1,7X) )
C              PRINT OUT BOWEN RATIO FOR KICKS
      DO 925 I=1,9
      COLSCR(I)=999.E0
      IF(EVPCOL(N,I).NE.0.E0) COLSCR(I)=SENCOL(N,I)/EVPCOL(N,I)
  925 CONTINUE
      PRINT 926,COLSCR
  926 FORMAT(1H ,2X,'BOWEN R',9(E12.3,1X) )
C
      PRINT 927,(DLWCOL(N,I),I=1,9)
  927 FORMAT(1H ,2X,'DLWVGND',9(F6.1,7X) )
      PRINT 928,(ULWCOL(N,I),I=1,9)
  928 FORMAT(1H ,2X,'ULWVGND',9(F6.1,7X) )
      PRINT 929,(TLWCOL(N,I),I=1,9)
  929 FORMAT(1H0,2X,'ULWVTOP',9(F6.1,7X) )
C               DO ANEM WIND SPEED ( AT 10 METERS ) IF RADIATION USED
      IF( ICALLRAD .EQ. 0 ) GO TO 936
C         ADDRESS FOR ROUGHNESS LENGTH
C     IADZO=ICOL(N)+IMG(NGRDUSE)*(JCOL(N)-1)+IADDRG(20,NGRDUSE)-1
      NGH = NGRIDH(N)
      IN0H = IN00H(N)
      IADZO = IADDRG(20,NGH) - 1
C
C          1 / SQ ROOT OF NEUTRAL DRAG COEFF FOR WIND AT 10 METERS
C
      RLENGTH = VBL(IADZO + IN0H)           *CF00H(N) +
     1          VBL(IADZO + IN0H+1)         *CF10H(N) +
     2          VBL(IADZO + IN0H+IMG(NGH))  *CF01H(N) +
     3          VBL(IADZO + IN0H+IMG(NGH)+1)*CF11H(N)
C          TYPICAL SPECIFIC VOLUME AT GROUND FOR THIS POINT
C          CONVERSION CONSTANT
      ANEMCON =  ( ALOG( 10.E0 / RLENGTH) / 0.4E0 ) *
     *  SQRT(2870.E0*(TCOL(1,N,1)+273.16E0) / HCOL(N,1) )
C           CONVERT ALL NINE TIMES
CFPP$ NOVECTOR L
        DO 934 I = 1,9
        SEXCOL(N,I) = ANEMCON*SQRT( SEXCOL(N,I)*
     *         SQRT (
     *   UCOL(1,N,I)*UCOL(1,N,I) + VCOL(1,N,I)*VCOL(1,N,I)))
  934   CONTINUE
      PRINT 935,(SEXCOL(N,I),I=1,9)
  935 FORMAT(1H ,2X,'ANEM SP',9(F6.1,7X) )
C
  936 CONTINUE
C
  930 CONTINUE
C
C
  940 CONTINUE
C
C-----------------------------------------------------
C           CONSIDER OUTPUT OF SINGLE ARRAYS IN VBL
      CALL OUTPHYS
C
C
C ------------------------------------------------------
C             THE RETURN WHEN JOB IS ALL DONE
C
      RETURN
C
C
C ------------------------------------------------------
C ------------------------------------------------------
C
C
C   ***********************************************************
C          COMPUTED GO TO ROUTINE TO INTERPOLATE FROM A SET OF
C          3-DIMENSIONAL NGM GRIDS OF DATA, LOCATED IN
C             S( JSCR3NGM( NN , NFROM )  ), NN=1,NUMGDREQ
C          TO THE IJOUT*KM ARRAY LOCATED IN
C             S( JSCR3OUT( NTO ) )
C          OF POINTS ON THE OUTPUT GRID.
C     (NFROM  AND   NTO  MUST BE STORED BEFORE COMING TO 900.)
C
  900 CONTINUE
C
      DO 951 K=1,KM
C          ADDRESS FOR THE OUTPUT GRID DATA
      IADTO=JSCR3OUT(NTO) + (K-1)*IJOUT
C
        DO 950 NN=1,NUMGDREQ
        NG=NGRIDATA(NN)
        IM=IMG(NG)
        JM=JMG(NG)
        IJ=IM*JM
        JJ1=J1(NG)
        LEN=LENGD(NG)
        J1ADDM1=(JJ1-1)*IM
C          ADDRESS TO FETCH NGM GRID DATA
        IADFROM=JSCR3NGM(NN,NFROM)+J1ADDM1+IJ*(K-1)
C          ADDRESS IN FNGM
        IADF=JADDFNGM(NG)+J1ADDM1
C          STORE NGM DATA FROM GRID NG IN ARRAY FNGM
      DO 90000 IQ2W6E=1,LEN
         S(IADF+IQ2W6E-1)=S(IADFROM+IQ2W6E-1)
90000 CONTINUE
C
  950   CONTINUE
C          DO THE HORIZONTAL INTERPOLATION
C
            CALL OUTHORIZ(IN(MIILL),IN(MIIUL),S(MSA),S(MSB),S(MSC),
     *                    S(MSD),S(MSOUT1),S(IADTO))
C
  951 CONTINUE
C          RESTORE OUTHORD TO ITS NORMAL VALUE
C
      GO TO ( 220, 290, 430, 440, 371,  70,  50, 35  ),IRET
C
C****************************************************************
C
C
C
      END
